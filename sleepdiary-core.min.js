(function(){/*
 Copyright 2020-2022 Sleepdiary Developers <sleepdiary@pileofstuff.org>

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use, copy,
 modify, merge, publish, distribute, sublicense, and/or sell copies
 of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
 BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
 ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.
*/
function aa(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}function ba(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):{next:aa(a)}}var ca="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b},da="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){if(a==Array.prototype||a==Object.prototype)return a;a[b]=d.value;return a};
function fa(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var d=a[b];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");}var ha=fa(this);function G(a,b){if(b)a:{var d=ha;a=a.split(".");for(var k=0;k<a.length-1;k++){var h=a[k];if(!(h in d))break a;d=d[h]}a=a[a.length-1];k=d[a];b=b(k);b!=k&&null!=b&&da(d,a,{configurable:!0,writable:!0,value:b})}}var ia;
if("function"==typeof Object.setPrototypeOf)ia=Object.setPrototypeOf;else{var ja;a:{var ka={a:!0},la={};try{la.__proto__=ka;ja=la.a;break a}catch(a){}ja=!1}ia=ja?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var ma=ia;
function L(a,b){a.prototype=ca(b.prototype);a.prototype.constructor=a;if(ma)ma(a,b);else for(var d in b)if("prototype"!=d)if(Object.defineProperties){var k=Object.getOwnPropertyDescriptor(b,d);k&&Object.defineProperty(a,d,k)}else a[d]=b[d];a.ia=b.prototype}
G("Symbol",function(a){function b(e){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new d(k+(e||"")+"_"+h++,e)}function d(e,f){this.g=e;da(this,"description",{configurable:!0,writable:!0,value:f})}if(a)return a;d.prototype.toString=function(){return this.g};var k="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",h=0;return b});
G("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),d=0;d<b.length;d++){var k=ha[b[d]];"function"===typeof k&&"function"!=typeof k.prototype[a]&&da(k.prototype,a,{configurable:!0,writable:!0,value:function(){return na(aa(this))}})}return a});function na(a){a={next:a};a[Symbol.iterator]=function(){return this};return a}
function oa(a,b){a instanceof String&&(a+="");var d=0,k=!1,h={next:function(){if(!k&&d<a.length){var e=d++;return{value:b(e,a[e]),done:!1}}k=!0;return{done:!0,value:void 0}}};h[Symbol.iterator]=function(){return h};return h}G("Array.prototype.keys",function(a){return a?a:function(){return oa(this,function(b){return b})}});G("Math.log10",function(a){return a?a:function(b){return Math.log(b)/Math.LN10}});
var pa="function"==typeof Object.assign?Object.assign:function(a,b){for(var d=1;d<arguments.length;d++){var k=arguments[d];if(k)for(var h in k)Object.prototype.hasOwnProperty.call(k,h)&&(a[h]=k[h])}return a};G("Object.assign",function(a){return a||pa});
G("Array.from",function(a){return a?a:function(b,d,k){d=null!=d?d:function(c){return c};var h=[],e="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];if("function"==typeof e){b=e.call(b);for(var f=0;!(e=b.next()).done;)h.push(d.call(k,e.value,f++))}else for(e=b.length,f=0;f<e;f++)h.push(d.call(k,b[f],f));return h}});
G("Promise",function(a){function b(f){this.h=0;this.l=void 0;this.g=[];this.J=!1;var c=this.A();try{f(c.resolve,c.reject)}catch(p){c.reject(p)}}function d(){this.g=null}function k(f){return f instanceof b?f:new b(function(c){c(f)})}if(a)return a;d.prototype.h=function(f){if(null==this.g){this.g=[];var c=this;this.l(function(){c.B()})}this.g.push(f)};var h=ha.setTimeout;d.prototype.l=function(f){h(f,0)};d.prototype.B=function(){for(;this.g&&this.g.length;){var f=this.g;this.g=[];for(var c=0;c<f.length;++c){var p=
f[c];f[c]=null;try{p()}catch(l){this.A(l)}}}this.g=null};d.prototype.A=function(f){this.l(function(){throw f;})};b.prototype.A=function(){function f(l){return function(n){p||(p=!0,l.call(c,n))}}var c=this,p=!1;return{resolve:f(this.M),reject:f(this.B)}};b.prototype.M=function(f){if(f===this)this.B(new TypeError("A Promise cannot resolve to itself"));else if(f instanceof b)this.O(f);else{a:switch(typeof f){case "object":var c=null!=f;break a;case "function":c=!0;break a;default:c=!1}c?this.L(f):this.I(f)}};
b.prototype.L=function(f){var c=void 0;try{c=f.then}catch(p){this.B(p);return}"function"==typeof c?this.P(c,f):this.I(f)};b.prototype.B=function(f){this.K(2,f)};b.prototype.I=function(f){this.K(1,f)};b.prototype.K=function(f,c){if(0!=this.h)throw Error("Cannot settle("+f+", "+c+"): Promise already settled in state"+this.h);this.h=f;this.l=c;2===this.h&&this.N();this.T()};b.prototype.N=function(){var f=this;h(function(){if(f.U()){var c=ha.console;"undefined"!==typeof c&&c.error(f.l)}},1)};b.prototype.U=
function(){if(this.J)return!1;var f=ha.CustomEvent,c=ha.Event,p=ha.dispatchEvent;if("undefined"===typeof p)return!0;"function"===typeof f?f=new f("unhandledrejection",{cancelable:!0}):"function"===typeof c?f=new c("unhandledrejection",{cancelable:!0}):(f=ha.document.createEvent("CustomEvent"),f.initCustomEvent("unhandledrejection",!1,!0,f));f.promise=this;f.reason=this.l;return p(f)};b.prototype.T=function(){if(null!=this.g){for(var f=0;f<this.g.length;++f)e.h(this.g[f]);this.g=null}};var e=new d;
b.prototype.O=function(f){var c=this.A();f.C(c.resolve,c.reject)};b.prototype.P=function(f,c){var p=this.A();try{f.call(c,p.resolve,p.reject)}catch(l){p.reject(l)}};b.prototype.then=function(f,c){function p(m,r){return"function"==typeof m?function(x){try{l(m(x))}catch(H){n(H)}}:r}var l,n,q=new b(function(m,r){l=m;n=r});this.C(p(f,l),p(c,n));return q};b.prototype.catch=function(f){return this.then(void 0,f)};b.prototype.C=function(f,c){function p(){switch(l.h){case 1:f(l.l);break;case 2:c(l.l);break;
default:throw Error("Unexpected state: "+l.h);}}var l=this;null==this.g?e.h(p):this.g.push(p);this.J=!0};b.resolve=k;b.reject=function(f){return new b(function(c,p){p(f)})};b.race=function(f){return new b(function(c,p){for(var l=ba(f),n=l.next();!n.done;n=l.next())k(n.value).C(c,p)})};b.all=function(f){var c=ba(f),p=c.next();return p.done?k([]):new b(function(l,n){function q(x){return function(H){m[x]=H;r--;0==r&&l(m)}}var m=[],r=0;do m.push(void 0),r++,k(p.value).C(q(m.length-1),n),p=c.next();while(!p.done)})};
return b});G("Array.prototype.find",function(a){return a?a:function(b,d){a:{var k=this;k instanceof String&&(k=String(k));for(var h=k.length,e=0;e<h;e++){var f=k[e];if(b.call(d,f,e,k)){b=f;break a}}b=void 0}return b}});G("Object.values",function(a){return a?a:function(b){var d=[],k;for(k in b)Object.prototype.hasOwnProperty.call(b,k)&&d.push(b[k]);return d}});
G("Array.prototype.fill",function(a){return a?a:function(b,d,k){var h=this.length||0;0>d&&(d=Math.max(0,h+d));if(null==k||k>h)k=h;k=Number(k);0>k&&(k=Math.max(0,h+k));for(d=Number(d||0);d<k;d++)this[d]=b;return this}});function M(a){return a?a:Array.prototype.fill}G("Int8Array.prototype.fill",M);G("Uint8Array.prototype.fill",M);G("Uint8ClampedArray.prototype.fill",M);G("Int16Array.prototype.fill",M);G("Uint16Array.prototype.fill",M);G("Int32Array.prototype.fill",M);
G("Uint32Array.prototype.fill",M);G("Float32Array.prototype.fill",M);G("Float64Array.prototype.fill",M);var qa={},ra=[],sa,ta=(new Intl.DateTimeFormat).resolvedOptions().timeZone;sa="UTC"==ta?"Etc/GMT":ta;function P(a,b){b&&(this.g=b)}P.file_format=function(){return"DiaryBase"};P.prototype.merge=function(){return this};P.prototype.clone=function(){return ua({file_format:"storage-line",contents:{file_format:this.file_format(),contents:JSON.parse(JSON.stringify(this,function(a,b){return"spreadsheet"==a?void 0:b}))}},this.g)};
P.prototype.to=function(a){switch(a){case this.file_format():return this;case "url":return"sleepdiary="+encodeURIComponent(JSON.stringify({file_format:this.file_format(),contents:this},function(b,d){return"spreadsheet"==b?void 0:d}));case "json":return JSON.stringify(this,function(b,d){return"spreadsheet"==b?void 0:d});case "storage-line":return"storage-line:"+this.file_format()+":"+JSON.stringify(this,function(b,d){return"spreadsheet"==b?void 0:d});default:if(qa.hasOwnProperty(a))return new qa[a](this.to("Standard"),
this.g);throw Error(this.file_format()+" cannot be converted to "+a);}};P.prototype.to_async=function(a){switch(a){case "spreadsheet":if(!this.spreadsheet.synchronise())throw Error("Could not synchronise data");return this.spreadsheet.serialise();default:var b=this.to(a);return b.then?b:{then:function(d){return d(b)}}}};function Q(a,b){return a.g?a.g(b):b}
function R(a){var b=a.prototype.format_info();b.constructor=a;ra.push(b);"/"==b.url[0]&&(b.url="https://sleepdiary.github.io/core"+b.url);"Standard"!=b.name&&(qa[b.name]=b.constructor)}function U(){throw null;}function va(a){throw Error("Does not appear to be a valid "+a.file_format()+" file");}
function wa(a,b){switch(b.file_format()){case "url":return b=b.contents,a.file_format()==b.file_format?(Object.keys(b.contents).forEach(function(d){return a[d]=b.contents[d]}),!0):U();case "string":case "spreadsheet":if(a.spreadsheet.load(b))return!0;case "archive":case "array":U()}return!1}function V(a,b){var d="";if(a)for(b=Math.pow(10,(b||2)-1);b>a;b/=10)d+="0";else for(var k=1;k<(b||2);++k)d+="0";return d+a}
function xa(a){try{var b=self.DOMParser;if(!b)throw"";}catch(d){b=require("@xmldom/xmldom").DOMParser}return(new b).parseFromString(a,"application/xml")}
function ya(a,b){if(null===a||void 0===a)return NaN;if(a.getTime)return a=a.getTime(),864E5>=a&&(a+=b||0),a;if(a.match){if(b=a.match(/^((19|20)[0-9]{2})[-.]?([0-9]{2})[-.]?([0-9]{2})[T ]?([0-9]{2})[.:]?([0-9]{2})(?:[.:]?([0-9]{2}))?Z?$/))return(new Date(parseInt(b[1],10),parseInt(b[3],10)-1,parseInt(b[4],10),parseInt(b[5],10),parseInt(b[6],10),parseInt(b[7]||0,10))).getTime();a.search(/^[0-9]{4,}$/)||(a=parseInt(a,10))}if("number"==typeof a)return b=12-Math.floor(Math.log10(a)),a*Math.pow(10,a&&2<
Math.abs(b)?b:0);if(!a||!a.search)return NaN;b=(-1==a.search(/[a-su-y]/i)&&-1!=a.search(/-.*-/)?a:a.replace(/\s*(-|to).*/,"")).replace(/([ap])\s*(m)/i,"$1$2").toLowerCase();if(-1!=b.search(/midnight/i))return 0;if(-1!=b.search(/midd?ay|noon|12pm/i))return 432E5;var d=b.match(/^([0-9]*)(:([0-9]*))?\s*([ap])m$/);return d?36E5*(parseInt(d[1],10)+parseInt(d[3]||"0",10)/60+("p"==d[4]?12:0)):(d=b.match(/^([0-9]*)(:([0-9]*))?(:([0-9]*))?$/))?36E5*(parseInt(d[1],10)+parseInt(d[3]||"0",10)/60+parseInt(d[5]||
"0",10)/3600):Date.parse(b)||Date.parse(a)}function za(a,b,d){if("function"!=typeof d){var k=d;d=function(e){return k.map(function(f){return e[f]}).join("\ue000")}}var h={};a.forEach(function(e){return h[d(e)]=1});return b.filter(function(e){return!h.hasOwnProperty(d(e))})}function Aa(){try{var a=self.tc;if(!a)throw"";}catch(b){a=require("timezonecomplete")}return a}function W(a,b){var d=Aa();a=new d.DateTime(a||0,d.zone("Etc/UTC"));return b?a.toZone(d.zone(b)):a}
function Ba(a,b){for(var d=Aa().TzDatabase.instance(),k=a-1728E5;k<a;k+=36E5)try{var h=d.nextDstChange(b,k);if(!h)return Infinity;if(h>a)return h}catch(e){return Infinity}return d.nextDstChange(b,a)||Infinity}
function Da(){return[["awake","w.ke",""],["asleep","sle*p(?!.*aid)","#FFFFFF00,#FF0000FF,#FFFFFFFF"],["lights off","light.*(?:out|off)","#FFFFFFFF,#FF000080,#FFFFFFFF"],["lights on","light.*on","#FFFFFFFF,#FFE6E6FF"],["snack","snack","#FFFF7FFF,#FF7FFF7F"],["meal","meal|eat","#FFFF00FF,#FF00FF00"],["alcohol","alco","#FF1FAFEF,#FFE05010,#FFFFFFFF"],["chocolate","choc","#FF84C0FF,#FF7B3F00,#FFFFFFFF"],["caffeine","caffeine|coffee|tea|cola","#FF0B3B8B,#FFF4C474"],["drink","drink","#FFDF8F5F,#FF2070a0,#FFFFFFFF"],
["sleep aid","sle*p.*aid|pill|tranq","#FFAFFF7F,#FF500080,#FFFFFFFF"],["exercise","exercise","#FF00C0C0,#FFFF3F3F"],["toilet","toilet|bathroom|loo","#FF363636,#FFC9C9C9"],["noise","noise","#FF8F8F8F,#FF707070,#FFFFFFFF"],["alarm","alarm","#FF000000,#FFFF0000"],["in bed","down|(in|to).*bed","#FFA0A000,#FF5f5fff"],["out of bed","up|out.*bed","#FF0000FF,#FFFFFFCC"]]}P.prototype.timezones=function(){return Object.keys(self.tzdata.zones).sort()};P.prototype.software_version=function(){return"2def2ce"};
function ua(a,b){var d=Error("This does not appear to be a sleep diary"),k=a.file_format;if("string"==typeof a)k="string",a={file_format:function(){return"string"},contents:a};else if(k)"string"==typeof k?a.file_format=function(){return k}:k=k(),"url"==k?a.contents=JSON.parse(decodeURIComponent(a.contents.replace(/^sleep-?diary=/,""))):"storage-line"==k&&(k="url");else throw d;"string"==k&&Object.assign(a,Ea(a.contents));for(var h=0;h!=ra.length;++h)try{return new ra[h].constructor(a,b)}catch(e){e&&
(d=e)}throw d;};function Fa(a,b,d){function k(f){return function(){(history.state||{})["sleepdiary-core-processed"]||location.hash.replace(/(?:^#|[?&])(sleep-?diary=[^&]*)/g,function(c,p){history.replaceState(Object.assign({"sleepdiary-core-processed":d},history.state||{}),"");e.load({file_format:"url",contents:p},f)})}}this.success_callback=a||function(){};this.error_callback=b||function(){};var h,e=this;2!=d&&(h=setInterval(function(){self.tc&&(clearInterval(h),self.addEventListener("hashchange",k("hashchange"),
!1),k("hash")())},100));Ga()}function Ha(){return[[self.JSZip,"https://cdn.jsdelivr.net/npm/jszip@3.6.x/dist/jszip.min.js"],[self.tc,"https://cdn.jsdelivr.net/npm/tzdata@1.0.x/tzdata.js","https://cdn.jsdelivr.net/npm/timezonecomplete@5.12.x/dist/timezonecomplete.min.js"],[self.ExcelJS,"https://cdn.jsdelivr.net/npm/exceljs@4.2.x/dist/exceljs.min.js"]]}
function Ga(){try{var a=[];Ha().forEach(function(b){b[0]||(a=a.concat(b.slice(1)))});self.importScripts?self.importScripts.apply(self,a):a.forEach(function(b){var d=document.createElement("script");d.src=b;document.head.appendChild(d)})}catch(b){}}
Fa.prototype.load=function(a,b){var d=this;if(Ha().some(function(f){return!f[0]}))return setTimeout(function(){return d.load(a,b)},100);var k=self.JSZip;if(!k)return setTimeout(function(){return d.load(a,b)},100);if("string"==typeof a&&!a.search(/^(blob|data):/)){var h=new XMLHttpRequest;h.responseType="blob";h.onload=function(){return d.load([h.response],b)};h.open("GET",a);return h.send()}b||(b=a);a.target&&a.target.files&&(a=a.target.files);a.replace&&a.replace(/^storage-line:([^:]+):(.*)/,function(f,
c,p){a={file_format:"storage-line",contents:{file_format:c,contents:JSON.parse(p)}}});if("string"!=typeof a&&a.length)Array.from(a).forEach(function(f){var c=new FileReader,p=new k;c.onload=function(){return Ia(c.result).then(function(l){return d.load(l,b)},function(){return p.loadAsync(c.result).then(function(l){function n(){m.length?l.file(m[0]).async("string").then(function(r){q[m[0]]=r;m.shift();n()}):d.load({file_format:"archive",contents:q},b)}var q={},m=Object.keys(l.files);n()},function(){var l=
d.error_callback;try{d.error_callback=function(){},d.load({file_format:"array",contents:c.result},b),d.error_callback=l}catch(n){d.error_callback=l,c.onload=function(){return d.load({file_format:"string",contents:c.result},b)},c.readAsText(f)}})})};c.readAsArrayBuffer(f)});else{try{var e=self.new_sleep_diary(a,Fa.serialiser)}catch(f){throw this.error_callback(a,b),f;}e?this.success_callback(e,b):this.error_callback(a,b)}};
Fa.serialiser=function(a){switch(a.file_format()){case "array":return a.contents;case "string":return btoa(unescape(encodeURIComponent(a.contents)));case "archive":var b=function(d,k){var h=self.JSZip;if(!h)return setTimeout(function(){return b(d,k)},100);var e=new h;Object.keys(a.contents).forEach(function(f){return e.file(f,a.contents[f])});return e.generateAsync({type:"base64",compression:"DEFLATE"}).then(d,k)};Ga();return new Promise(b);default:throw Error("Unsupported output format: "+a.file_format());
}};Fa.to_url=function(a){if("string"==typeof a)return"data:application/octet-stream;base64,"+a;a.file_format&&a.contents&&("archive"==a.file_format()?a=JSON.stringify(a):a=a.contents);return URL.createObjectURL(new Blob([a]))};var Ja={number:"General",time:'YYYY-MM-DD" "HH:MM',duration:"[h]:mm"};
function X(a,b,d){function k(f){var c=f.member;switch(f.type){case "time":var p=function(n,q,m){return q[m]=Y(void 0===n[c]?void 0:new Date(n[c]))};break;case "duration":p=function(n,q,m){return q[m]=Y(void 0===n[c]?void 0:n[c]/864E5)};break;default:p=function(n,q,m){return q[m]=Y(n[c])}}if(f.optional){var l=p;p=function(n,q,m){return void 0===n[c]||l(n,q,m)}}return p}function h(f,c){var p=f.member;switch(f.type){case "time":var l=d?function(m,r,x){return!isNaN(m[p]=r[x].H)}:function(m,r,x){return!isNaN(m[p]=
r[x].S)};break;case "duration":l=function(m,r,x){return!isNaN(m[p]=r[x].value.getTime()+c.epoch_offset)};break;case "number":l=function(m,r,x){return!isNaN(m[p]=parseFloat(r[x].value))};break;case "boolean":l=function(m,r,x){return!isNaN(m[p]=!!r[x].value)};break;default:l=function(m,r,x){m[p]=r[x].value;return!0}}if(f.regexp){var n=l;l=function(m,r,x){return f.regexp.test(r[x].value)&&n(m,r,x)}}if(f.optional){var q=l;l=function(m,r,x){return!r[x]||null==r[x].value||q(m,r,x)||""==r[x].value}}return l}
var e=this;this.g=null;this.h=a;this.l=b.map(function(f){return{sheet:f.sheet||f.member,member:f.member||f.sheet,type:f.type||"list",optional:!!f.optional,cells:f.cells.map(function(c){if(c.members){for(c.formats=(c.formats||[]).map(function(p){return Ja[p]||p});c.formats.length<c.members.length;)c.formats.push("General");return c}return{members:[c.member],regexp:c.regexp||RegExp(""),formats:[Ja[c.type]||"General"],"export":k(c),"import":h(c,e)}})}});this.epoch_offset=0;this.sheets=[]}
function Y(a,b){return{value:a,style:b||""}}X.prototype.get_sheet=function(a,b,d){var k=b.join("\x00"),h=this.sheets.filter(function(e){return e.cells[0]&&e.cells[0].map(function(f){return f.value}).join("\x00")==k});return h.length?[!1,h.find(function(e){return e.name==a})||h[0]]:[!0,{name:a,number_formats:d.map(function(e){return e?Ja[e]||e:"General"}),cells:[b.map(function(e){return Y(e,"#FFEEEEEE,#FFEEEEEE")})]}]};
function Ka(a,b){return ya((a||{}).hasOwnProperty("value")?a.value:a,b?(b.properties||{}).date1904?20828448E5:22091616E5:0)}function La(a,b){var d=0;a.forEach(function(k){return k.forEach(function(h){var e=h.S=Ka(h,b);e=h.H=isNaN(e)||0>e||864E5<e?e:e+d-d%864E5;e<d&&(h.H=e+=864E5);d=e})})}
function Ia(a){function b(k){return k.hasOwnProperty("argb")?"#"+k.argb:k.hasOwnProperty("indexed")?"i"+k.indexed:k.hasOwnProperty("theme")?"t"+k.theme:""}try{var d=new self.ExcelJS.Workbook}catch(k){d=new (require("exceljs").Workbook)}return d.xlsx.load(a).then(function(){if(d._worksheets.length){var k=[];d.eachSheet(function(h){var e={name:h.name,cells:[]};k.push(e);h.eachRow({includeEmpty:!0},function(f,c){var p=e.cells[c-1]=[];f.eachCell({includeEmpty:!0},function(l,n){var q="";l.style&&l.style.fill&&
(q=b(l.style.fill.bgColor||{})+","+b(l.style.fill.fgColor||{}));1==q.length&&(q="");if((l.value||{}).getTime){var m=l.value.getTime();if(1==m%1E3||-999==m%1E3)l.value=new Date(m-1);if(-1==m%1E3||999==m%1E3)l.value=new Date(m+1)}p[n-1]=Y(l.value,q)})})});k.forEach(function(h){return La(h.cells,d)});return{file_format:"spreadsheet",spreadsheet:d,sheets:k}}throw Error("empty spreadsheet");})}
function Ea(a){"\ufeff"==a[0]&&(a=a.substr(1));-1==a.search(/[\r\n]$/)&&(a+="\n");if(!a.search(RegExp('^(([^",\\r\\n]*|"([^"]|"")*")(,([^",\\r\\n]*|"([^"]|"")*"))*(?:\r\n|\r|\n))*$'))){try{var b=new self.ExcelJS.Workbook}catch(c){b=new (require("exceljs").Workbook)}for(var d=b.addWorksheet("Records"),k=b.addWorksheet("Settings"),h=[],e=0,f=[[Y("Setting"),Y("Value")]];!a.search(/^([A-Za-z_][A-Za-z0-9_]*)=[^,]*\n/);)a=a.replace(/([^=]*?)=(.*)\n/,function(c,p,l){f.push([p,l].map(function(n){return Y(n)}));
k.addRow([p,l]);return""});a.replace(RegExp('([^",\\r\\n]*|"([^"]|"")*")(,([^",\\r\\n]*|"([^"]|"")*"))*(?:\r\n|\r|\n)',"g"),function(c){var p=d.getRow(++e),l=[],n=0;h.push(l);c.replace(RegExp('([^",\\r\\n]*|"([^"]|"")*")[,\r\n]',"g"),function(q){var m=p.getCell(++n);m.value='"'==q[0]?q.substr(1,q.length-3).replace(/""/g,'"'):q.substr(0,q.length-1);l.push(Y(m.value))})});La(h);return{spreadsheet:b,sheets:[{name:"Records",cells:h},{name:"Settings",cells:f}]}}}
function Ma(a){return void 0===a?"":a.getTime?W(a.getTime()).format("yyyy-MM-ddTHH:mm:ss.SSS")+"Z":-1==a.toString().search(/[",\n]/)?a:'"'+a.replace(/"/g,'""')+'"'}
X.prototype.load=function(a){var b=this,d=a.sheets;if(!d)return!1;var k=this.epoch_offset;this.epoch_offset=(a.spreadsheet.properties||{}).date1904?20828448E5:22091616E5;if(!this.l.every(function(h){return d.some(function(e){var f=e.cells,c="dictionary"==h.type;if(!f.length||c&&2!=f.length)return!1;var p=f[0].slice(0);if(!h.cells.every(function(r){return r.members.every(function(x){return x==(p.shift()||{value:NaN}).value})}))return!1;var l=[];if(!f.slice(1).every(function(r){if(!r.length)return!0;
var x=0,H={};l.push(H);return h.cells.every(function(C){return C["import"](H,r,(x+=C.members.length)-C.members.length)})}))return!1;var n=h.member;if(c)b.h[n]=Object.assign(l[0],b.h[n]||{});else{b.h[n]||(b.h[n]=[]);var q=b.h[n];q.length>=f.length&&q.splice(0,f.length-1);l.forEach(function(r,x){return q[x]=Object.assign(r,q[x])})}var m=[];h.cells.forEach(function(r){return m=m.concat(r.formats)});e.number_formats=m;return!0})}))return this.epoch_offset=k,!1;this.g=a.spreadsheet;this.sheets=d;return!0};
X.prototype.synchronise=function(){var a=this;return this.l.every(function(b){function d(n){var q=[],m=0;p.push(q);return b.cells.every(function(r){return r["export"](n,q,(m+=r.members.length)-r.members.length)})}var k="dictionary"==b.type,h=[],e=[];b.cells.forEach(function(n){h=h.concat(n.members);e=e.concat(n.formats)});var f=a.get_sheet(b.sheet,h,e),c=f[0];f=f[1];var p=f.cells=[h.map(function(n){return Y(n,"#FFEEEEEE,#FFEEEEEE")})],l=a.h[b.member||b.sheet];if(k){if(!d(l))return!1}else if(!l.every(d))return!1;
c&&a.sheets.push(f);return!0})};
X.prototype.serialise=function(){function a(e){switch(e[0]){case "#":return{argb:e.slice(1)};case "i":return{indexed:parseInt(e.slice(1),10)};case "t":return{theme:parseInt(e.slice(1),10)};default:return{}}}var b=this,d=!this.g;if(!this.g){try{this.g=new self.ExcelJS.Workbook}catch(e){this.g=new (require("exceljs").Workbook)}this.epoch_offset=(this.g.properties||{}).date1904?20828448E5:22091616E5}var k=this.epoch_offset,h={};this.sheets.forEach(function(e){return h[e.name]=0});this.g.eachSheet(function(e,
f){h.hasOwnProperty(e.name)?h[e.name]=e:b.g.ga(f)});this.sheets.forEach(function(e){var f=h[e.name]||b.g.addWorksheet(e.name,e.options);f.eachRow({includeEmpty:!0},function(c,p){var l=e.cells[p-1]||[];c.eachCell({includeEmpty:!0},function(n,q){l[q]||(n.value=null,n.style={})})});e.cells.forEach(function(c,p){var l=f.getRow(p+1);c.forEach(function(n,q){var m=l.getCell(q+1);m.value=d&&(n.value||{}).getTime&&0<=n.value.getTime()&&864E5>n.value.getTime()?new Date(n.value.getTime()-k):n.value;n=n.style.split(",");
m=m.style=m.style||{};q=((e.styles||[])[q]||{}).font;n[0]||n[1]||n[2]?(m.fill=m.fill||{},m.fill.type="pattern",m.fill.pattern="solid",n[0]?m.fill.bgColor=a(n[0]):delete m.fill.bgColor,n[1]?m.fill.fgColor=a(n[1]):delete m.fill.fgColor,n[2]?(m.font=m.font||{},m.font.color=a(n[2])):delete m.font):m&&m.fill&&(delete m.fill.bgColor,delete m.fill.fgColor);q&&Object.assign(m.font=m.font||{},q)});l.commit()});e.widths?e.widths.forEach(function(c,p){return f.columns[p].width=c}):f.columns.forEach(function(c){return c.width=
18});e.styles&&e.styles.forEach(function(c,p){return f.columns[p].style=c});(e.number_formats||[]).forEach(function(c,p){return f.getColumn(p+1).numFmt=c})});return this.g.xlsx.writeBuffer()};
function Oa(a){var b=a.l[0];return(a.h.settings||[]).map(function(d){return d.Setting+"="+d.Value+"\n"}).concat([b.cells.map(function(d){return d.members.join(",")}).join(",")+"\n"],a.h[b.member].map(function(d){var k=[],h=0;b.cells.forEach(function(e){return e["export"](d,k,(h+=e.members.length)-e.members.length)});return k.map(function(e){return Ma(e.value)}).join(",")+"\n"})).join("")}X.prototype.file_format=function(){return"Spreadsheet"};var Pa={new_sleep_diary:ua,sleepdiary_engines:ra,DiaryLoader:Fa,Spreadsheet:X};"undefined"!==typeof module&&module.exports?module.exports=Pa:Object.keys(Pa).forEach(function(a){return self[a]=Pa[a]});var Qa={Z:"awake",da:"in bed",Y:"asleep","lights off":"lights off","lights on":"lights on",ha:"snack",fa:"meal",X:"alcohol",aa:"chocolate",$:"caffeine",ba:"drink","sleep aid":"sleep aid",ca:"exercise",ja:"toilet",R:"noise",W:"alarm","in bed":"in bed","out of bed":"out of bed"};
function Z(a,b){b&&(this.g=b);a.records&&!a.file_format&&(a={file_format:function(){return"Standard"},contents:a});this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"status",regexp:new RegExp("^("+Object.values(Qa).join("|")+")$"),type:"string"},{member:"start",type:"time",optional:!0},{member:"end",type:"time",optional:!0},{member:"start_timezone",type:"string",optional:!0},{member:"end_timezone",type:"string",optional:!0},{member:"duration",type:"duration",optional:!0},
{members:["tags"],"export":function(l,n,q){return n[q]=Y((l.tags||[]).join("; "))},"import":function(l,n,q){n[q].value&&(l.tags=n[q].value.split(/ *; */));return!0}},{members:["comments"],"export":function(l,n,q){return n[q]=Y((l.comments||[]).map(function(m){return m.time?"TIME="+m.time+" "+m.text:m}).join("; "))},"import":function(l,n,q){n[q].value&&(n=n[q].value.split(/ *; */).map(function(m){var r;m=m.replace(/^TIME=([0-9]*) */,function(x,H){r=parseInt(H,10);return""});return r?{time:r,text:m}:
m}),l.comments=n);return!0}},{member:"day_number",type:"number",optional:!0},{member:"start_of_new_day",type:"boolean",optional:!0},{member:"is_primary_sleep",type:"boolean",optional:!0},{member:"missing_record_after",type:"boolean",optional:!0}]},{sheet:"Settings",member:"settings",type:"dictionary",cells:[{member:"minimum_day_duration",type:"duration"},{member:"maximum_day_duration",type:"duration"}]}]);switch(a.file_format()){case "string":try{a={file_format:function(){return"Standard"},contents:JSON.parse(a.contents)}}catch(l){return U()}if("Standard"!=
a.contents.file_format)return U();default:if(!wa(this,a)){b=a.contents;if("Standard"!=a.file_format()||null===b||"object"!=typeof b||!Array.isArray(b.records))return U();this.records=b.records.map(function(l){return Object.assign({},l)}).sort(function(l,n){return l.start-n.start||l.end-n.end});a=b.settings||b;var d=a.minimum_day_duration||576E5,k=a.maximum_day_duration||2*d;this.settings={minimum_day_duration:d,maximum_day_duration:k};var h=0,e=0,f={status:"",day_number:-1},c=[],p=f;this.records.forEach(function(l){["start",
"end"].forEach(function(q){void 0==l[q]&&delete l[q]});["tags","comments"].forEach(function(q){(l[q]||[]).length||delete l[q]});l.hasOwnProperty("duration")||(l.duration=l.end-l.start,isNaN(l.duration)&&delete l.duration);l.hasOwnProperty("start_of_new_day")?l.start_of_new_day&&(h=l.start):l.start_of_new_day="asleep"==l.status&&l.start>h+d;l.hasOwnProperty("day_number")?e=l.day_number:(l.start_of_new_day&&(e=l.start>h+k?e+2:e+1,h=l.start),l.day_number=e);if("awake"==l.status||"asleep"==l.status)p.hasOwnProperty("missing_record_after")||
(p.missing_record_after=l.status==p.status),p=l;"asleep"==l.status&&(c[l.day_number]||{duration:-Infinity}).duration<l.duration&&(c[l.day_number]=l);if(l.hasOwnProperty("comments")){var n=l.comments;void 0===n?delete l.comments:Array.isArray(n)||(l.comments=[n])}f=l});c.forEach(function(l){l&&!l.hasOwnProperty("is_primary_sleep")&&(l.is_primary_sleep=!0)})}}}L(Z,P);
Z.prototype.to=function(a){switch(a){case "output":return a=Object.assign({file_format:this.file_format()},this),delete a.spreadsheet,Q(this,{file_format:function(){return"string"},contents:JSON.stringify(a)});default:return P.prototype.to.call(this,a)}};
Z.prototype.merge=function(a){var b={};[this,a.to(this.file_format())].forEach(function(d){return d.records.forEach(function(k){return b[[k.start,k.end,k.status].join()]=k})});this.records=Object.values(b).sort(function(d,k){return d.start-k.start||d.end-k.end});return this};Z.prototype.file_format=function(){return"Standard"};Z.prototype.format_info=function(){return{name:"Standard",title:"Standardised diary format",url:"/src/Standard",extension:".json"}};
function Ra(a,b){function d(q,m){return q+Math.pow(m-n,2)}function k(q,m){return q+m}var h=a.map(function(q){return q[0]}).filter(function(q){return void 0!==q}),e=h.length;if(!e)return null;var f=h.sort(function(q,m){return q-m}),c=f.slice(Math.round(.25*f.length),Math.round(.75*f.length)),p=h.reduce(k)/(e||1),l=c.reduce(k)/(c.length||1);f={average:p,mean:p,interquartile_mean:l,median:f[Math.floor(f.length/2)],interquartile_range:c[c.length-1]-c[0],durations:a.map(function(q){return q?q[0]:void 0}),
timestamps:a.map(function(q){return q?q[1]:void 0}),interquartile_durations:c,rolling_average:a.map(b?function(q,m){if(!(14>m)){q=a.slice(Math.max(0,m-13),m+1).map(function(x){return x[0]}).filter(function(x){return void 0!==x});var r=[0,0];q.forEach(function(x){x<1*b/4?++r[0]:x>3*b/4&&++r[1]});return q.length?(q.reduce(function(x,H){return x+H})+(r[0]<r[1]?r[0]*b:r[1]*-b))/q.length:void 0}}:function(q,m){q=a.slice(Math.max(0,m-13),m+1).map(function(r){return r[0]}).filter(function(r){return void 0!==
r});return 14<=m&&q.length?q.reduce(function(r,x){return r+x})/q.length:void 0})};var n=p;f.standard_deviation=Math.sqrt(h.reduce(d,0)/e);n=l;f.interquartile_standard_deviation=Math.sqrt(c.reduce(d,0)/c.length);return f}Z.prototype.summarise_records=function(a){return Ra((a?this.records.filter(a):this.records).map(function(b){return[b.duration,b.start||b.end]}))};
Z.prototype.summarise_days=function(a){var b=[],d=this.records.length?this.records[this.records.length-1].day_number:0;for((a?this.records.filter(a):this.records).forEach(function(h){var e=h.day_number;(b[e]||0)<h.start&&0<e&&e<d&&(b[e]=h.start)});b.length&&!b[0];)b.shift();a=[];for(var k=1;k<b.length;++k)b[k]&&b[k-1]&&(a[k-1]=[b[k]-b[k-1],b[k-1]]);return Ra(a)};
Z.prototype.total_per_day=function(a,b){var d=[],k=this.records.length?this.records[this.records.length-1].day_number:0;(b?this.records.filter(b):this.records).forEach(function(h){return(d[h.day_number]=d[h.day_number]||[0,h.start])[0]+=a&&!a(h)?0:1});for(d=d.slice(1,k);d.length&&void 0===d[0];)d.shift();return Ra(d)};
Z.prototype.summarise_schedule=function(a,b,d){b=b||864E5;d=d||sa;var k=b/2,h=[],e=[],f=[],c=[];(a?this.records.filter(a):this.records).forEach(function(q){if(q.is_primary_sleep){if(q.start){var m=q.start;m+=6E4*W(m,q.start_timezone||d).offset();h.push([m%b,m]);e.push([(m+k)%b,m])}q.end&&(m=q.end,m+=6E4*W(m,q.end_timezone||d).offset(),f.push([m%b,m]),c.push([(m+k)%b,m]))}});a=Ra(h,b);var p=Ra(e,b),l=Ra(f,b),n=Ra(c,b);[[p,a],[n,l]].forEach(function(q){q[0]&&(["average","mean","interquartile_mean",
"median"].forEach(function(m){return q[0][m]=(q[0][m]+k)%b}),["durations","interquartile_durations"].forEach(function(m){return q[0][m]=q[1][m]}),q[0].rolling_average=q[1].rolling_average)});return{wake:(l||{}).standard_deviation<(n||{}).standard_deviation?l:n,sleep:(a||{}).standard_deviation<(p||{}).standard_deviation?a:p}};
Z.prototype.daily_activities=function(a,b,d,k){function h(F,E){E.time=((E.start||E.end)+(E.end||E.start))/2;E.record=F;E.index=r++;F=q[q.length-1];var I=F.start,N=F.duration;["start","end","time"].forEach(function(v){E[v]&&(E["offset_"+v]=(E[v]-I)/N)});return E}function e(F){for(var E=p;C.unixUtcMillis()<=F;)if(E=p,m=0,++n,c=C,C=C.add(d,x),C.unixUtcMillis()>=p){p=Ba(c.unixUtcMillis(),a);var I=C.add(6E4*(c.offset()-C.offset()),x);if(c.lessThan(I)){var N=C.unixUtcMillis()>F;C=I;if(N)break}}if(!m&&(N=
c.unixUtcMillis(),F=C.unixUtcMillis(),I=q[n]={start:N,end:F,duration:F-N,id:c.toString(),year:c.year(),month:c.month()-1,day:c.day()-1,activities:m=[]},0<k))for(I=I.segments=[];N<F;){var v=new Date(N+T);I.push({dst_state:S?"on":"off",id:v.toISOString().replace(/Z/,l),year:v.getUTCFullYear(),month:v.getUTCMonth(),day:v.getUTCDate()-1,hour:v.getUTCHours(),minute:v.getUTCMinutes(),second:v.getUTCSeconds()});N+=k;N>=E&&(E=W(N,c.zone().name()),I[I.length-1].dst_state="change-"+(S?"back":"forward"),K=E.offsetDuration(),
T=K.milliseconds(),S=!K.equals(c.standardOffsetDuration()),E=Ba(E.unixUtcMillis(),a))}}a=a||sa;b=void 0===b?648E5:b;d=d||864E5;var f=this.records.sort(function(F,E){return(F.start||F.end)-(E.start||E.end)}),c=f.find(function(F){return F.start||F.end}),p=Ba(c?(c.start||c.end)-1:0,a),l=a.replace(/^([A-Za-z])/," $1"),n=0,q=[],m,r,x=Aa().TimeUnit.Millisecond;if(c){c=W(c.start||c.end,a);var H=c.unixUtcMillis()-c.startOfDay().unixUtcMillis();c=c.sub((H<b?864E5:0)+H-b,x);var C=c.add(d,x);b=C.add(6E4*(c.offset()-
C.offset()),x);b.greaterThan(c)&&(C=b);var K=c.offsetDuration();var T=K.milliseconds();var S=!K.equals(c.standardOffsetDuration());f.forEach(function(F){r=0;var E=F.start,I=F.end;if(E)if(e(E),I)if(C.unixUtcMillis()>=I)m.push(h(F,{start:E,end:I,type:"start-end"}));else{for(m.push(h(F,{start:E,end:C.unixUtcMillis(),type:"start-mid"}));;){e(C.unixUtcMillis()+1);if(C.unixUtcMillis()>=I)break;m.push(h(F,{start:c.unixUtcMillis(),end:C.unixUtcMillis(),type:"mid-mid"}))}m.push(h(F,{start:c.unixUtcMillis(),
end:I,type:"mid-end"}))}else m.push(h(F,{start:E,type:"start-unknown"}));else I&&(e(I),m.push(h(F,{end:I,type:"unknown-end"})))})}q.forEach(function(F){var E=F.activity_summaries={};F.activities.forEach(function(I){var N=I.record.status,v=E[N]=E[N]||{duration:0};["start","end"].forEach(function(z){var A=I[z];void 0!==A&&(A=W(A,a).toString(),v["last_"+z]=A,void 0==v["first_"+z]&&(v["first_"+z]=A))});v.duration=I.start&&I.end?v.duration+(I.end-I.start):NaN})});return q};
Z.prototype.latest_sleep_status=function(){for(var a=this.records.length-1;0<=a;--a){var b=this.records[a].status;if("awake"==b||"asleep"==b)return b}return""};R(Z);function Sa(a,b){function d(g){return g.substr(1,g.length-2)}function k(g){return(new Date(g.substr(1,g.length-2))).getTime()}function h(g){var t=g.match(z);return{string:g,year:parseInt(t[1],10),month:parseInt(t[2],10),day:parseInt(t[3],10),hour:parseInt(t[4],10),minute:parseInt(t[5],10),offset:("-"==t[6]?-1:1)*(60*parseInt(t[7],10)+parseInt(t[8],10))}}function e(g,t){g=W(g,t);t=g.offset();return{string:'"'+g.year()+"-"+V(g.month())+"-"+V(g.day())+" "+V(g.hour())+":"+V(g.minute())+(0>t?"-":"+")+
V(Math.abs(Math.round(t/60)))+V(Math.abs(t%60))+'"',year:g.year(),month:g.month(),day:g.day(),hour:g.hour(),minute:g.minute(),offset:t}}function f(g,t){var y=Math.floor(t/60),w=Math.floor(t%60);g=new Date((g.getTime?g.getTime():g)+6E4*(60*y+w));return{string:'"'+g.getUTCFullYear()+"-"+V(g.getUTCMonth()+1)+"-"+V(g.getUTCDate())+" "+V(g.getUTCHours())+":"+V(g.getUTCMinutes())+("-"==t[0]?"":"+")+V(Math.floor(t/60),2)+V(Math.floor(t%60),2)+'"',year:g.getUTCFullYear(),month:g.getUTCMonth()+1,day:g.getUTCDate(),
hour:g.getUTCHours(),minute:g.getUTCMinutes(),offset:t}}function c(g){var t=[];if(""!=g){g=g.split("|");for(var y=0;y!=g.length;++y){var w=g[y].split("-");t.push({wake:parseInt(w[0],10),sleep:parseInt(w[1],10)})}}return t}function p(g){var t=[];if(g.length&&"NONE"!=g){g=g.split("|");for(var y=0;y!=g.length;++y){var w=g[y].split(":");t.push({type:w[0],mood:parseInt(w[1],10),themes:w.slice(2)})}}return t}function l(g){return g.length&&"NONE"!=g?g.split("|"):[]}function n(g){g=g.match(E);return{custom_aid_id:g[1],
"class":g[2],name:d(g[3])}}function q(g){g=g.match(I);return{custom_hindrance_id:g[1],"class":g[2],name:d(g[3])}}function m(g){g=g.match(N);return{custom_tag_id:g[1],name:d(g[2])}}function r(g){g=g.match(v);var t=c(g[28]);return{start:k(g[19]),end:k(g[1]),duration:t.reduce(function(y,w){return y+w.sleep-w.wake},k(g[1])-k(g[10])),wake:h(g[1]),sleep:h(g[10]),bedtime:h(g[19]),holes:t,type:g[34],dreams:p(g[35]),aids:l(g[47]),hindrances:l(g[51]),tags:l(g[55]),quality:parseInt(g[59],10),notes:d(g[60])}}
function x(g){var t=!0,y={D:[],F:[],G:[],u:[]};g=g.split("\n");for(var w=0;w!=g.length;++w){var O=g[w];if(t){switch(O){case "custom_aid_id,class,name":var B=y.D;var J=E;break;case "custom_hindrance_id,class,name":B=y.F;J=I;break;case "custom_tag_id,name":B=y.G;J=N;break;case "wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes":B=y.u;J=v;break;default:if(B)B[B.length-1]+="\n",--w;else return va(this)}t=!1}else if(""==g[w])t=!0;else{for(;'"'!=O.substr(O.length-1);){if(++w==g.length)return va(this);
O+="\n"+g[w]}if(J.test(O))B.push(O);else if(B.length)B[B.length-1]+="\n"+O;else return va(this)}}return y}b&&(this.g=b);var H="ALCOHOL AMBIEN AMBIEN_CR AROMATHERAPY BENADRYL CHAMOMILE CIRCADIN CPAP DOZILE EAR_PLUGS EXERCISE GABA IMOVANE LUNESTA MAGNESIUM MARIJUANA MEDITATION MELATONIN MILK MUSIC NYQUIL READING RESTAVIT ROZEREM SEX SOUND_MACHINE ST_JOHNS_WORT TV TYLENOL TYLENOL_PM UNISOM UNISOM2 VALERIAN ZIMOVANE".split(" "),C="ALARM_CLOCK ANGER ANXIETY ARGUMENT BABY_CRYING BATHROOM_BREAK TOO_BRIGHT BUNKMATE_SNORING CAFFEINE TOO_COLD DOG_BARKING FIRE_ANTS HEARTBURN TOO_HOT HUNGER LOUD_NEIGHBOR MIND_RACING PAIN PHONE_RANG RESTLESS_LEGS SCARY_MOVIE SICK SQUIRRELS_ON_ROOF STORM STRESS SUGAR VIDEO_GAME WIND".split(" "),
K="ALONE BUNKMATE CAMPING COUCH GOING_FISHING HOTEL OUT_OF_TOWN PASSED_OUT_DRUNK SCHOOL_NIGHT SLEEP_TALKING SLEEP_WALKING SLEPT_AT_FRIENDS_PLACE SLEPT_IN_CAR WORK_NIGHT".split(" ");b=H.join("|")+"|CUSTOM_[0-9]*";var T=C.join("|")+"|CUSTOM_[0-9]*",S=K.join("|")+"|CUSTOM_[0-9]*",F={};[H,C,K].forEach(function(g,t){return g.forEach(function(y){return F[y]=t})});H=RegExp("^CUSTOM_[0-9]*$");var E=RegExp('^(CUSTOM_[0-9]*),(AIRWAY|BEVERAGE|DRUG|EXERTION|HERBAL|READING|RELAXATION|SENSORY_DEPRIVATION|SOUND),("(.|\n)*")$'),
I=RegExp('^(CUSTOM_[0-9]*),(ENVIRONMENTAL|MENTAL|NOISE|OBLIGATION|PHYSICAL|STIMULANT),("(.|\n)*")$'),N=RegExp('^(CUSTOM_[0-9]*),("(.|\n)*")$'),v=new RegExp('^("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),(|([1-9][0-9]*)-([1-9][0-9]*)(\\|([1-9][0-9]*)-([1-9][0-9]*))*),(NIGHT_SLEEP|NAP),(NONE|((UNKNOWN|GOOD|EROTIC|NEUTRAL|STRANGE|CREEPY|TROUBLING|NIGHTMARE):(-[1-5]|[0-5])(:(CHASE|COMPENSATORY|DAILY_LIFE|DEATH|EPIC|FALLING|FALSE_AWAKENING|FLYING|LUCID|MURDER|MUTUAL|NAKED_IN_PUBLIC|ORGASMIC|PHYSIOLOGICAL|PRECOGNITIVE|PROGRESSIVE|RECURRING|RELIGIOUS|SIGNAL|TEETH|TEST|MONEY))*)(\\|((UNKNOWN|GOOD|EROTIC|NEUTRAL|STRANGE|CREEPY|TROUBLING|NIGHTMARE):(-[1-5]|[0-5])(:(CHASE|COMPENSATORY|DAILY_LIFE|DEATH|EPIC|FALLING|FALSE_AWAKENING|FLYING|LUCID|MURDER|MUTUAL|NAKED_IN_PUBLIC|ORGASMIC|PHYSIOLOGICAL|PRECOGNITIVE|PROGRESSIVE|RECURRING|RELIGIOUS|SIGNAL|TEETH|TEST|MONEY))*))*),(NONE|('+
(b+")(\\|("+b+"))*),(NONE|(")+(T+")(\\|("+T+"))*),(NONE|(")+(S+")(\\|("+S+'))*),([0-9]|10),("(.|\n)*")$')),z=RegExp('"([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"');this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{members:["start","start_offset"],formats:["time",null],"export":function(g,t,y){t[y]=Y(new Date(g.start));t[y+1]=Y(g.bedtime.offset);return!0},"import":function(g,t,y){g.start=t[y].value.getTime();return g.bedtime=
f(t[y].value,t[y+1].value)}},{members:["end","end_offset"],formats:["time",null],"export":function(g,t,y){t[y]=Y(new Date(g.end));t[y+1]=Y(g.wake.offset);return!0},"import":function(g,t,y){g.end=t[y].value.getTime();return g.wake=f(t[y].value,t[y+1].value)}},{member:"duration",type:"duration"},{members:["sleep","sleep_offset"],formats:["time",null],"export":function(g,t,y){t[y]=Y(new Date(g.sleep.string.substr(1,g.sleep.string.length-2)));t[y+1]=Y(g.sleep.offset);return!0},"import":function(g,t,y){return g.sleep=
f(t[y].value,t[y+1].value)}},{members:["holes"],regexp:/^([0-9]*-[0-9]*(\|[0-9]*-[0-9]*)*)?$/,"export":function(g,t,y){t[y]=Y(g.holes.map(function(w){return w.wake+"-"+w.sleep}).join("|"));return!0},"import":function(g,t,y){g.holes=c(t[y].value);return!0}},{member:"type",regexp:/^(NIGHT_SLEEP|NAP)$/},{members:["dreams"],"export":function(g,t,y){t[y]=Y(g.dreams.map(function(w){return[w.type,w.mood].concat(w.themes).join(":")}).join("|"));return!0},"import":function(g,t,y){return g.dreams=p(t[y].value)}},
{members:["aids"],"export":function(g,t,y){t[y]=Y(g.aids.join("|"));return!0},"import":function(g,t,y){g.aids=l(t[y].value);return!0}},{members:["hindrances"],"export":function(g,t,y){t[y]=Y(g.hindrances.join("|"));return!0},"import":function(g,t,y){g.hindrances=l(t[y].value);return!0}},{members:["tags"],"export":function(g,t,y){t[y]=Y(g.tags.join("|"));return!0},"import":function(g,t,y){g.tags=l(t[y].value);return!0}},{member:"quality",regexp:/^[0-9]*$/},{member:"notes"}]},{sheet:"Custom Aids",member:"custom_aids",
cells:[{member:"custom_aid_id",regexp:H},{member:"class",regexp:RegExp("^(AIRWAY|BEVERAGE|DRUG|EXERTION|HERBAL|READING|RELAXATION|SENSORY_DEPRIVATION|SOUND)$")},{member:"name"}]},{sheet:"Custom Hindrances",member:"custom_hindrances",cells:[{member:"custom_hindrance_id",regexp:H},{member:"class",regexp:RegExp("^(ENVIRONMENTAL|MENTAL|NOISE|OBLIGATION|PHYSICAL|STIMULANT)$")},{member:"name"}]},{sheet:"Custom Tags",member:"custom_tags",cells:[{member:"custom_tag_id",regexp:H},{member:"name"}]}]);b=[];
T=[];var A=[],u=[];switch(a.file_format()){case "string":if(-1==a.contents.search("wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes"))return U();a=x(a.contents);b=a.D.map(n);T=a.F.map(q);A=a.G.map(m);u=a.u.map(r);break;default:if(wa(this,a))return;var D={};a.to("Standard").records.forEach(function(g){switch(g.status){case "in bed":D[g.end]=[g.start,g.start_timezone];break;case "asleep":var t=[[],[],[]],y=D[g.start]||[g.start,g.start_timezone];(g.tags||[]).forEach(function(w){if(F.hasOwnProperty(w))t[F[w]].push(w);
else{var O=A.find(function(B){return w==B.name});O?t[2].push(O.custom_tag_id):(O="CUSTOM_"+V(A.length+1,4),A.push({custom_tag_id:O,name:w}),t[2].push(O))}});u.push({start:y[0],end:g.end,duration:g.duration,wake:e(g.end,g.end_timezone),sleep:e(g.start,g.start_timezone),bedtime:e(y[0],y[1]),holes:[],type:g.is_primary_sleep?"NIGHT_SLEEP":"NAP",dreams:[],aids:t[0],hindrances:t[1],tags:t[2],quality:5,notes:(g.comments||[]).join("; ")})}})}this.custom_aids=b;this.custom_hindrances=T;this.custom_tags=A;
this.records=u}L(Sa,P);
Sa.prototype.to=function(a){switch(a){case "output":var b="";this.custom_aids.length&&(b+="custom_aid_id,class,name\n",this.custom_aids.forEach(function(c){return b+=c.custom_aid_id+","+c["class"]+',"'+c.name+'"\n'}),b+="\n");this.custom_hindrances.length&&(b+="custom_hindrance_id,class,name\n",this.custom_hindrances.forEach(function(c){return b+=c.custom_hindrance_id+","+c["class"]+',"'+c.name+'"\n'}),b+="\n");this.custom_tags.length&&(b+="custom_tag_id,name\n",this.custom_tags.forEach(function(c){return b+=c.custom_tag_id+
',"'+c.name+'"\n'}),b+="\n");b+="wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes\n";this.records.forEach(function(c){return b+=[c.wake.string,c.sleep.string,c.bedtime.string,c.holes.map(function(p){return p.wake+"-"+p.sleep}).join("|"),c.type,c.dreams.map(function(p){return[p.type,p.mood].concat(p.themes).join(":")}).join("|")||"NONE",c.aids.join("|")||"NONE",c.hindrances.join("|")||"NONE",c.tags.join("|")||"NONE",c.quality,'"'+c.notes+'"'].join()+"\n"});return Q(this,{file_format:function(){return"string"},
contents:b});case "Standard":var d=function(c){c=Math.round(c.offset/60);return 0>c?"Etc/GMT+"+Math.abs(c):0<c?"Etc/GMT-"+c:"Etc/GMT"},k={},h={},e={},f=[];this.custom_aids.forEach(function(c){return k[c.custom_aid_id]=c.name});this.custom_hindrances.forEach(function(c){return h[c.custom_hindrance_id]=c.name});this.custom_tags.forEach(function(c){return e[c.custom_tag_id]=c.name});this.records.forEach(function(c){var p=c.sleep;p=(new Date(p.string.substr(1,p.string.length-2))).getTime();c.start<p&&
f.push({status:"in bed",start:c.start,end:p,start_timezone:d(c.bedtime),end_timezone:d(c.sleep)});var l=[];c.aids.forEach(function(n){return l.push(k[n]||n)});c.hindrances.forEach(function(n){return l.push(h[n]||n)});c.tags.forEach(function(n){return l.push(e[n]||n)});f.push(Object.assign({status:"asleep",start:void 0===c.start?p||void 0:Math.max(c.start,p),end:c.end,start_timezone:d(c.sleep),end_timezone:d(c.wake),tags:l,comments:c.notes.length?[c.notes]:[]},void 0===c.duration?{}:{duration:c.duration},
"NIGHT_SLEEP"==c.type?{is_primary_sleep:!0}:{}))});return new Z({records:f},this.g);default:return P.prototype.to.call(this,a)}};
Sa.prototype.merge=function(a){var b=this,d={},k={},h={};a=a.to(this.file_format());this.custom_aids.length&&a.custom_aids.length?a.custom_aids.forEach(function(e){var f=b.custom_aids.find(function(p){return p["class"]==e["class"]&&p.name==e.name});if(!f){var c="CUSTOM_0001";for(f=2;b.custom_aids.some(function(p){return p.custom_aid_id==c});++f)c="CUSTOM_"+V(f,4);f={custom_aid_id:c,"class":e["class"],name:e.name};b.custom_aids.push(f)}d[e.custom_aid_id]=f.custom_aid_id}):a.custom_aids.forEach(function(e){return d[e.custom_aid_id]=
e.custom_aid_id});this.custom_hindrances.length&&a.custom_hindrances.length?a.custom_hindrances.forEach(function(e){var f=b.custom_hindrances.find(function(p){return p["class"]==e["class"]&&p.name==e.name});if(!f){var c="CUSTOM_0001";for(f=2;b.custom_hindrances.some(function(p){return p.custom_hindrance_id==c});++f)c="CUSTOM_"+V(f,4);f={custom_hindrance_id:c,"class":e["class"],name:e.name};b.custom_hindrances.push(f)}k[e.custom_hindrance_id]=f.custom_hindrance_id}):a.custom_hindrances.forEach(function(e){return k[e.custom_hindrance_id]=
e.custom_hindrance_id});this.custom_tags.length&&a.custom_tags.length?a.custom_tags.forEach(function(e){var f=b.custom_tags.find(function(p){return p.name==e.name});if(!f){var c="CUSTOM_0001";for(f=2;b.custom_tags.some(function(p){return p.custom_tag_id==c});++f)c="CUSTOM_"+V(f,4);f={custom_tag_id:c,name:e.name};b.custom_tags.push(f)}h[e.custom_tag_id]=f.custom_tag_id}):a.custom_tags.forEach(function(e){return h[e.custom_tag_id]=e.custom_tag_id});this.records=this.records.concat(za(this.records,a.records,
function(e){return[e.wake.string,e.sleep.string,e.bedtime.string].join()}).map(function(e){return Object.assign({},e,{aids:e.aids.map(function(f){return d[f]||f}),hindrances:e.hindrances.map(function(f){return k[f]||f}),tags:e.tags.map(function(f){return h[f]||f})})})).sort(function(e,f){return e.wake-f.wake});return this};Sa.prototype.file_format=function(){return"Sleepmeter"};
Sa.prototype.format_info=function(){return{name:"Sleepmeter",title:"Sleepmeter",url:"/src/Sleepmeter",statuses:["in bed","asleep"],extension:".csv",logo:"http://www.squalllinesoftware.com/sites/squalllinesoftware.com/files/sleepmeter_logo_128x128.png"}};R(Sa);function Ta(a,b){function d(u){return u.substr(1,u.length-2).replace(E,'"').replace(I,"\n")}function k(u){var D=[];u.replace(S,function(g,t){3<t.length&&("_2x"==t.substr(t.length-3)?D.push({count:2,value:t.substr(0,t.length-3)}):"_3x"==t.substr(t.length-3)?D.push({count:3,value:t.substr(0,t.length-3)}):D.push({count:1,value:t}))});return D}function h(u){var D=u.match(H);return{string:u,year:parseInt(D[3],10),month:parseInt(D[2],10),day:parseInt(D[1],10),hour:parseInt(D[4],10),minute:parseInt(D[5],
10)}}function e(u,D){u=W(u,D);return{string:'"'+V(u.day())+". "+V(u.month())+". "+u.year()+" "+u.hour()+":"+V(u.minute())+'"',year:u.year(),month:u.month(),day:u.day(),hour:u.hour(),minute:u.minute()}}function f(u,D){return D.some(function(g){return g==u})?null:p(u)}function c(u,D){return D.some(function(g){return g==u})?null:p(u)}function p(u){return parseFloat(u.substr(1,u.length-2))}function l(u,D){return D.some(function(g){return g==u})?null:d(u)}function n(u){var D={},g=xa(u).documentElement;
u=Array.from(g.getElementsByTagName("long"));var t=Array.from(g.getElementsByTagName("int")),y=Array.from(g.getElementsByTagName("boolean"));g=Array.from(g.getElementsByTagName("string"));u.forEach(function(w){return D[w.getAttribute("name")]=parseInt(w.getAttribute("value"),10)});t.forEach(function(w){return D[w.getAttribute("name")]=parseInt(w.getAttribute("value"),10)});y.forEach(function(w){return D[w.getAttribute("name")]="true"==w.getAttribute("value")});g.forEach(function(w){return D[w.getAttribute("name")]=
w.textContent});return D}function q(u){var D=[];u=u.split("\n");""==u[u.length-1]&&u.pop();for(var g={},t=0;t!=u.length;g={i:g.i,s:g.s,m:g.m,v:g.v,o:g.o},t+=2){var y=function(B){return function(J){return W(["year","month","day"].map(function(ea){return V(J[ea])}).join("-")+"T"+["hour","minute"].map(function(ea){return V(J[ea])}).join(":"),B.i.Tz).unixUtcMillis()}}(g),w=u[t].match(m);g.s=[];g.m=[];if(!w)return va(this);w[1].replace(C,function(B){return function(J,ea,Ca){B.s.push({header_string:J,hours:parseInt(ea,
10),minutes:parseInt(Ca,10),actigraphy:null,noise:null})}}(g));w[5].replace(/"Event"/g,function(B){return function(){B.m.push({label:null,timestamp:null})}}(g));w=u[t+1].match(r);if(!w)return va(this);g.v=0;g.o=0;var O=d(w[27]);g.i={Id:d(w[1]),Tz:d(w[3]),From:h(w[5]),To:h(w[11]),Sched:h(w[17]),Hours:p(w[23]),Rating:p(w[25]),Comment:{string:O,tags:k(O),notags:O.replace(F,"")},Framerate:d(w[29]),Snore:f(w[31],['"-1"']),Noise:c(w[32],['"-1.0"']),Cycles:f(w[34],['"-1"']),DeepSleep:c(w[35],['"-1.0"','"-2.0"']),
LenAdjust:c(w[37],['"-1.0"']),Geo:l(w[39],[""]),times:g.s,events:g.m};g.i.start=parseInt(g.i.Id,10);g.i.end=g.i.start+36E5*g.i.Hours;g.i.duration=Math.round(6E4*(60*g.i.Hours+("-1.0"==w[37]?0:g.i.LenAdjust)));g.i.alarm=6E4*Math.round((g.i.end+y(g.i.Sched)-y(g.i.To))/6E4);w[40].replace(K,function(B){return function(J){B.s[B.v++].V=p(J)}}(g));w[43].replace(T,function(B){return function(J,ea,Ca,ab,Na){B.m[B.o].label=ea;B.m[B.o].timestamp=parseInt(Ca,10);Na&&(B.m[B.o].value=parseFloat(Na));++B.o}}(g));
if(y=u[t+2]?u[t+2].match(x):0)g.v=0,y[1].replace(K,function(B){return function(J){B.s[B.v++].R=p(J)}}(g)),++t;D.push(g.i)}return D}b&&(this.g=b);var m=RegExp('^Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)$'),r=RegExp('^("([^"]|"")*"),("([^"]|"")*"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(\\.[0-9]*)?"),("[0-9]*(\\.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(\\.[0-9]*)?"),("-?[0-9]*"),("(-[12]\\.0|0\\.[0-9]*|1\\.0)"),("-?[0-9]*(\\.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(\\.[0-9]*)?")*)((,"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)$'),
x=RegExp('^,,,,,,,,,,,,((,"-?[0-9]*(\\.[0-9]*)?")*)$');b=RegExp('^(Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)\n("([^"]|"")*"),("([^"]|"")*"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(\\.[0-9]*)?"),("[0-9]*(\\.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(\\.[0-9]*)?"),("-?[0-9]*"),("(-[12]\\.0|0\\.[0-9]*|1\\.0)"),("-?[0-9]*(\\.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(\\.[0-9]*)?")*)((,"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)\n(,,,,,,,,,,,,((,"-?[0-9]*(\\.[0-9]*)?")*)\n)?)*(Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)\n("([^"]|"")*"),("([^"]|"")*"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(\\.[0-9]*)?"),("[0-9]*(\\.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(\\.[0-9]*)?"),("-?[0-9]*"),("(-[12]\\.0|0\\.[0-9]*|1\\.0)"),("-?[0-9]*(\\.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(\\.[0-9]*)?")*)((,"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)(\n,,,,,,,,,,,,((,"-?[0-9]*(\\.[0-9]*)?")*))?)\n?$');
var H=RegExp('"([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"'),C=RegExp('"([0-9]*):([0-9]*)"',"g"),K=RegExp('"-?[0-9]*(\\.[0-9]*)?"',"g"),T=RegExp('"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?"',"g"),S=RegExp('#([^ ",][^ ",]*)',"g"),F=RegExp(' *#([^ ",][^ ",]*)',"g"),E=RegExp('""',"g"),I=RegExp(" \\\\n ","g"),N={},v=[];this.spreadsheet=new X(this,[]);var z=a.contents;switch(a.file_format()){case "spreadsheet":if(!a.sheets.some(function(u){u=u.cells;if(!u.length)return!1;A=[];var D=1,g,t,y;return u.every(function(w){if("Id,Tz,From,To,Sched,Hours,Rating,Comment,Tags,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo"==
w.slice(0,16).map(function(B){return B.value}).join())t=[],y=[],g={times:t,events:y},A.push(g),D=2,w.slice(16).forEach(function(B){if("Event"==B.value)y.push({label:null,timestamp:null});else if("number"==typeof B.value){var J=Math.floor(24*B.value);B=Math.floor(1440*B.value)%60;t.push({header_string:J+":"+V(B),hours:J,minutes:B,actigraphy:null,noise:null})}else return!1});else if(2==D){D=3;["Id","Tz",,,,"Hours","Rating","Comment","Tags","Framerate","Snore","Noise","Cycles","DeepSleep","LenAdjust",
"Geo"].forEach(function(B,J){return g[B]=w[J]?w[J].value:null});g.Comment=g.Comment&&g.Tags?{string:g.Comment+" "+g.Tags,tags:k(g.Tags),notags:g.Comment}:g.Comment?{string:g.Comment,tags:[],notags:g.Comment}:g.Tags?{string:g.Tags,tags:k(g.Tags),notags:""}:{string:"",tags:[],notags:""};delete g.Tags;var O=w[1].value;g.start=w[2].value.getTime();g.From=e(w[2].value.getTime(),O);g.end=w[3].value.getTime();g.To=e(w[3].value.getTime(),O);g.alarm=w[4].value.getTime();g.Sched=e(w[4].value.getTime(),O);g.duration=
Math.round(6E4*(60*g.Hours+(g.LenAdjust||0)));t.forEach(function(B,J){w[16+J]&&(B.actigraphy=w[16+J].value)});y.forEach(function(B,J){w[16+t.length+J]&&(J=w[16+t.length+J].value.split("-"),B.label=J[0],B.timestamp=J[1],2<J.length&&(B.value=J[2]))})}else if(3==D)D=1,t.forEach(function(B,J){w[16+J]&&(B.noise=w[16+J].value)});else return!1;return!0})})||!a.sheets.some(function(u){u=u.cells;if(!u.length||"Alarm"!=u[0][0].value)return!1;v=u.slice(1).map(function(D){return JSON.parse(D[0].value)});return!0})||
!a.sheets.some(function(u){u=u.cells;if(!u.length||"Preferences"!=u[0][0].value)return!1;N=JSON.parse(u[1][0].value);return!0}))return U();break;case "string":if(!b.test(z))return U();var A=q.call(this,z);break;case "archive":if(z.hasOwnProperty("sleep-export.csv")&&z["prefs.xml"]&&z["alarms.json"]){A=q.call(this,z["sleep-export.csv"]);N=n(z["prefs.xml"]);v=JSON.parse(z["alarms.json"]);break}else return U();default:if(wa(this,a))return;A=a.to("Standard").records.filter(function(u){return"asleep"==
u.status}).map(function(u){return{start:u.start,end:u.end,duration:u.duration,alarm:6E4*Math.round(u.end/6E4),Id:(u.start||0).toString(),Tz:u.start_timezone||u.end_timezone||"Etc/GMT",From:e(u.start,u.start_timezone||u.end_timezone),To:e(u.end,u.end_timezone||u.start_timezone),Sched:e(u.end,u.end_timezone||u.start_timezone),Hours:(u.end-u.start)/36E5,Rating:2.5,Comment:{string:(u.comments||[]).join("\n")+(u.tags||[]).map(function(D){return"#"+D}).join(" "),tags:(u.tags||[]).map(function(D){return{count:1,
value:D}}),notags:(u.comments||[]).join("\n")},Framerate:"10000",Snore:null,Noise:null,Cycles:null,DeepSleep:null,LenAdjust:null,Geo:"",times:[],events:[]}})}this.records=A;this.prefs=N;this.alarms=v}L(Ta,P);
Ta.prototype.to=function(a){var b=this,d=["Id","Tz","From","To","Sched"],k=["Hours","Rating"],h="Framerate Snore Noise Cycles DeepSleep LenAdjust Geo".split(" ");switch(a){case "output":var e=function(p,l){return'"'+(null===p?l:p)+'"'};a=JSON.stringify(this.alarms);var f="<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n<map>"+Object.keys(this.prefs).map(function(p){var l=b.prefs[p];switch(typeof l){case "boolean":return'\n\t<boolean name="'+p+'" value="'+l+'" />\n';case "number":return"\n\t<"+
(Math.abs(l)>=Math.pow(2,31)?"long":"int")+' name="'+p+'" value="'+l+'" />\n';default:return'\n\t<string name="'+p+'"><![CDATA['+l+"]]\x3e</string>\n"}}).join("")+"\n</map>\n",c=this.records.map(function(p){return[].concat(d,k,["Comment"],h,p.times.map(function(l){return',"'+l.header_string+'"'}),p.events.map(function(){return',"Event"'})).join(",")+"\n"+['"'+p.Id+'"','"'+p.Tz+'"'].concat(["start","end","alarm"].map(function(l){l=W(p[l],p.Tz);return'"'+V(l.day())+". "+V(l.month())+". "+l.year()+" "+
l.hour()+":"+V(l.minute())+'"'}),k.map(function(l){return'"'+p[l]+'"'}),['"'+p.Comment.string.replace(/"/g,'""').replace(/\n/g," \\n ")+'"','"'+p.Framerate+'"',e(p.Snore,"-1"),e(p.Noise,"-1.0"),e(p.Cycles,"-1"),e(p.DeepSleep,"-1.0"),e(p.LenAdjust,"-1.0"),e(p.Geo,"")],p.times.map(function(l){return'"'+l.actigraphy+'"'}),p.events.map(function(l){return'"'+l.label+"-"+l.timestamp+(l.hasOwnProperty("value")?"-"+l.value:"")+'"'})).join(",")+"\n"+(p.times.length?",,,,,,,,,,,,,"+p.times.map(function(l){return'"'+
l.noise+'"'}).join(",")+"\n":"")}).join("");return Q(this,{file_format:function(){return"archive"},contents:{"sleep-export.csv":c,"prefs.xml":f,"alarms.json":a}});case "Standard":return new Z({records:this.records.map(function(p){return Object.assign({status:"asleep",start:p.start,end:p.end,start_timezone:p.Tz,end_timezone:p.Tz,tags:p.Comment.tags.map(function(l){return l.value}),comments:p.Comment.notags.length?[p.Comment.notags]:void 0},void 0===p.duration?{}:{duration:p.duration})})},this.g);default:return P.prototype.to.call(this,
a)}};
Ta.prototype.to_async=function(a){var b=["Id","Tz","From","To","Sched"],d=["Hours","Rating"],k="Framerate Snore Noise Cycles DeepSleep LenAdjust Geo".split(" ");switch(a){case "spreadsheet":a=this.spreadsheet;var h=this.records.length?Math.max.apply(0,this.records.map(function(l){return l.times.length})):0,e=a.get_sheet("Records",b.concat(d,["Comment","Tags"],k),[null,null,"time","time","time",null,null,null,null,null,null,null,null,null,null].concat(Array(h).fill("duration")));h=e[0];e=e[1];var f=
e.cells;f.splice(0);this.records.forEach(function(l){f.push([].concat(b,d,["Comment","Tags"],k,l.times.map(function(n){return(60*n.hours+n.minutes)/1440}),l.events.map(function(){return"Event"})).map(function(n){return Y(n,"#FFEEEEEE,#FFEEEEEE")}));f.push([l.Id,l.Tz].concat(["start","end","alarm"].map(function(n){return new Date(l[n])}),d.map(function(n){return l[n]}),[l.Comment.notags,l.Comment.tags.map(function(n){return"#"+n.value+(1==n.count?"":"_"+n.count+"x")}).join(" "),l.Framerate,l.Snore,
l.Noise,l.Cycles,l.DeepSleep,l.LenAdjust,l.Geo],l.times.map(function(n){return n.actigraphy}),l.events.map(function(n){return n.label+"-"+n.timestamp+(n.hasOwnProperty("value")?"-"+n.value:"")})).map(function(n){return Y(n)}));l.times.some(function(n){return n.noise})&&f.push([].concat(Array(13).fill(""),l.times.map(function(n){return n.noise})).map(function(n){return Y(n)}))});e.cells=f;h&&a.sheets.push(e);e=a.get_sheet("Alarms",["Alarm"],[""]);h=e[0];e=e[1];var c=e.cells;c.splice(1);this.alarms.forEach(function(l){return c.push([Y(JSON.stringify(l))])});
h&&a.sheets.push(e);e=a.get_sheet("Preferences",["Preferences"],[""]);h=e[0];e=e[1];var p=e.cells;p.splice(1);p.push([Y(JSON.stringify(this.prefs))]);h&&a.sheets.push(e);return a.serialise();default:return P.prototype.to_async.call(this,a)}};Ta.prototype.merge=function(a){a=a.to(this.file_format());this.records=this.records.concat(za(this.records,a.records,["Id"]));return this};Ta.prototype.file_format=function(){return"SleepAsAndroid"};
Ta.prototype.format_info=function(){return{name:"SleepAsAndroid",title:"Sleep as Android",url:"/src/SleepAsAndroid",statuses:["asleep"],extension:".zip",logo:"https://docs.sleep.urbandroid.org/assets/images/logo.png"}};R(Ta);function Ua(a,b){b&&(this.g=b);this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"sid",regexp:/^[1-9][0-9]*$/,type:"number"},{member:"start",type:"time"},{member:"stop",type:"time"},{member:"rating",regexp:/^[0-5]$/,type:"number"}]}]);wa(this,a)||(this.records=a.to("Standard").records.filter(function(d){return"asleep"==d.status}).map(function(d,k){return{start:d.start,stop:d.end,sid:k+1,rating:0}}))}L(Ua,P);
Ua.prototype.to=function(a){switch(a){case "output":return Q(this,{file_format:function(){return"string"},contents:"sid,start,stop,rating\n"+this.records.map(function(b){return[b.sid,b.start,b.stop,b.rating].join()+"\n"}).join("")});case "Standard":return new Z({records:this.records.map(function(b){return{status:"asleep",start:b.start,end:b.stop}})},this.g);default:return P.prototype.to.call(this,a)}};
Ua.prototype.merge=function(a){a=a.to(this.file_format());this.records=this.records.concat(za(this.records,a.records,["start","stop"]));this.records.forEach(function(b,d){return b.sid=d+1});return this};Ua.prototype.file_format=function(){return"PleesTracker"};Ua.prototype.format_info=function(){return{name:"PleesTracker",title:"Plees Tracker",url:"/src/PleesTracker",statuses:["asleep"],extension:".csv",logo:"https://raw.githubusercontent.com/vmiklos/plees-tracker/master/app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png"}};
R(Ua);function Va(a,b){b&&(this.g=b);b=[];this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"start",type:"time"},{member:"end",type:"time"},{member:"forced awakening",type:"boolean"},{member:"delayed retirement",type:"boolean"}]}]);switch(a.file_format()){case "array":a=a.contents;if(a.byteLength%12)return U();for(var d=new Float32Array(a),k=new Uint8Array(a),h=1,e=0;e<a.byteLength/12;++e){var f=d[3*e],c=d[3*e+1],p=!k[12*e+8],l=!k[12*e+9];if(f<h||c<=f)return U();h=c;b.push({start:6E4*
Math.round(15776640+1440*f),end:6E4*Math.round(15776640+1440*c),"forced awakening":p,"delayed retirement":l})}break;default:if(wa(this,a))return;b=a.to("Standard").records.filter(function(n){return"asleep"==n.status}).map(function(n){return{start:n.start,end:n.end,"forced awakening":(n.tags||[]).some(function(q){return-1!=q.search(/forced awakening/i)}),"delayed retirement":(n.tags||[]).some(function(q){return-1!=q.search(/delayed retirement/i)})}})}this.records=b}L(Va,P);
Va.prototype.to=function(a){switch(a){case "output":var b=new Float32Array(3*this.records.length),d=new Uint8Array(b.buffer);this.records.forEach(function(k,h){b[3*h]=(k.start-9465984E5)/864E5;b[3*h+1]=(k.end-9465984E5)/864E5;d[12*h+8]=k["forced awakening"]?0:255;d[12*h+9]=k["delayed retirement"]?0:255});return Q(this,{file_format:function(){return"array"},contents:b.buffer});case "Standard":return new Z({records:this.records.map(function(k){return{status:"asleep",start:k.start,end:k.end,tags:[].concat(k["forced awakening"]?
["forced awakening"]:[],k["delayed retirement"]?["delayed retirement"]:[])}})},this.g);default:return P.prototype.to.call(this,a)}};Va.prototype.merge=function(a){a=a.to(this.file_format());var b=1;this.records=this.records.concat(a.records).sort(function(d,k){return d.start-k.start}).filter(function(d){if(d.start<b||d.start>=d.end)return!1;b=d.end;return!0});return this};Va.prototype.file_format=function(){return"SleepChart1"};
Va.prototype.format_info=function(){return{name:"SleepChart1",title:"SleepChart 1.0",url:"/src/SleepChart1",statuses:["asleep"],extension:".tim",logo:"https://www.supermemo.com/assets/images/frontpage2/intro/icon4.svg"}};R(Va);function Wa(a,b){b&&(this.g=b);this.spreadsheet=new X(this,[{sheet:"Activities",member:"activities",cells:[{member:"ActivityStart",type:"time"},{member:"ActivityEnd",type:"time"}]},{sheet:"Settings",member:"settings",cells:[{member:"Setting",type:"text"},{member:"Value",type:"number"}]}]);wa(this,a)?Xa(this,[]):(this.records=a.to("Standard").records.filter(function(d){return"awake"==d.status||"asleep"==d.status}).map(function(d){return{status:d.status,start:d.start,end:d.end}}),this.activities=this.records.map(function(d){return{ActivityStart:d.start,
ActivityEnd:d.end}}),this.settings=[{Setting:"maximum_day_length_ms",Value:6E4}])}L(Wa,P);
function Xa(a,b){var d=a.records=[],k=[{}],h=1152E5,e=NaN,f=NaN,c=1;a.settings.forEach(function(r){"maximum_day_length_ms"==r.Setting&&(h=r.Value)});a.activities.concat(b).sort(function(r,x){return r.ActivityStart-x.ActivityStart}).forEach(function(r){f>=r.ActivityStart-6E4?k[k.length-1].ActivityEnd=r.ActivityEnd:k.push({ActivityStart:r.ActivityStart,ActivityEnd:f=r.ActivityEnd})});for(a.activities=k.slice(1);c<k.length;){a=k[c];b=a.ActivityStart;for(var p=a.ActivityEnd,l=0,n=++c;n<k.length;){var q=
k[n],m=q.ActivityStart-a.ActivityEnd;l<m&&(l=m,p=a.ActivityEnd,c=n);if(q.ActivityEnd-b>h)break;a=q;++n}36E5<p-b&&(b-e<h&&d.push({start:f+1,end:b-1,status:"asleep"}),d.push({start:b,end:n==k.length?k[n-1].ActivityEnd:p,status:"awake"}),e=b,f=p);if(n==k.length)break}}
Wa.prototype.to=function(a){switch(a){case "output":return Q(this,{file_format:function(){return"string"},contents:Oa(this.spreadsheet)});case "Standard":return new Z({records:this.records},this.g);default:return P.prototype.to.call(this,a)}};Wa.prototype.merge=function(a){a=a.to(this.file_format());Xa(this,a.activities);return this};Wa.prototype.file_format=function(){return"ActivityLog"};
Wa.prototype.format_info=function(){return{name:"ActivityLog",title:"Activity Log",url:"/src/ActivityLog",statuses:["awake","asleep"],extension:".csv"}};R(Wa);function Ya(a,b){function d(h){return"N/A"==h?null:parseInt(h.replace(/,/g,""),10)}b&&(this.g=b);var k=[];this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"Start Time",type:"time"},{member:"End Time",type:"time"},{member:"Minutes Asleep",type:"number"},{member:"Minutes Awake",type:"number"},{member:"Number of Awakenings",type:"number",optional:!0},{member:"Time in Bed",type:"number",optional:!0},{member:"Minutes REM Sleep",type:"number",optional:!0},{member:"Minutes Light Sleep",
type:"number",optional:!0},{member:"Minutes Deep Sleep",type:"number",optional:!0},{members:[],"export":function(){return!0},"import":function(h){h.end=h["End Time"];h.start=h["Start Time"];return!0}}]}]);b=RegExp('^Sleep\nStart Time,End Time,Minutes Asleep,Minutes Awake,Number of Awakenings,Time in Bed,Minutes REM Sleep,Minutes Light Sleep,Minutes Deep Sleep\n(?:"(([0-9][0-9]*)-([0-9][0-9]*)-([0-9][0-9]*) ([0-9][0-9]*):([0-9][0-9]*) *([AP])M)","(([0-9][0-9]*)-([0-9][0-9]*)-([0-9][0-9]*) ([0-9][0-9]*):([0-9][0-9]*) *([AP])M)","([0-9][0-9,]*)","([0-9][0-9,]*)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)"\n)*\n$',
"i");switch(a.file_format()){case "string":a=a.contents;if(b.test(a))a.replace(RegExp('"(([0-9][0-9]*)-([0-9][0-9]*)-([0-9][0-9]*) ([0-9][0-9]*):([0-9][0-9]*) *([AP])M)","(([0-9][0-9]*)-([0-9][0-9]*)-([0-9][0-9]*) ([0-9][0-9]*):([0-9][0-9]*) *([AP])M)","([0-9][0-9,]*)","([0-9][0-9,]*)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)"\n',"gi"),function(h,e,f,c,p,l,n,q,m,r,x,H,C,K,T,S,F,E,I,N,v,z){h=T.toUpperCase();r=parseInt(r,10);x=parseInt(x,
10);H=parseInt(H,10);C=parseInt(C,10);12==C?"A"==h&&(C=0):"P"==h&&(C+=12);K=parseInt(K,10);K=31<H?(new Date(H,x-1,r,C,K)).getTime():(new Date(r,x-1,H,C,K)).getTime();S={"End Time":K,"Minutes Asleep":parseInt(S.replace(/,/g,""),10),"Minutes Awake":parseInt(F.replace(/,/g,""),10),"Number of Awakenings":d(E),"Time in Bed":d(I),"Minutes REM Sleep":d(N),"Minutes Light Sleep":d(v),"Minutes Deep Sleep":d(z),end:K};S["Start Time"]=S.start=K-6E4*(S["Minutes Asleep"]+S["Minutes Awake"]);k.push(S)}),this.records=
k;else return U();break;default:wa(this,a)?this.records.forEach(function(h){return["Number of Awakenings","Time in Bed","Minutes REM Sleep","Minutes Light Sleep","Minutes Deep Sleep"].forEach(function(e){return Object.prototype.hasOwnProperty.call(h,e)||(h[e]=null)})}):this.records=a.to("Standard").records.filter(function(h){return"asleep"==h.status}).map(function(h){return{start:h.start,end:h.end,"Start Time":h.start,"End Time":h.end,"Minutes Asleep":Math.round((h.end-h.start)/6E4),"Minutes Awake":0,
"Number of Awakenings":null,"Time in Bed":null,"Minutes REM Sleep":null,"Minutes Light Sleep":null,"Minutes Deep Sleep":null}})}}L(Ya,P);
Ya.prototype.to=function(a){switch(a){case "output":return Q(this,{file_format:function(){return"string"},contents:["Sleep","Start Time,End Time,Minutes Asleep,Minutes Awake,Number of Awakenings,Time in Bed,Minutes REM Sleep,Minutes Light Sleep,Minutes Deep Sleep"].concat(this.records.map(function(b){return["Start Time","End Time"].map(function(d){d=new Date(b[d]);var k=d.getHours();return'"'+d.getFullYear()+"-"+V(d.getMonth()+1)+"-"+V(d.getDate())+" "+(k%12||12)+":"+V(d.getMinutes())+(12<=k?"PM":
"AM")+'"'}).concat("Minutes Asleep;Minutes Awake;Number of Awakenings;Time in Bed;Minutes REM Sleep;Minutes Light Sleep;Minutes Deep Sleep".split(";").map(function(d){return null===b[d]?'"N/A"':'"'+b[d].toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'"'})).join(",")}),"\n").join("\n")});case "Standard":return new Z({records:this.records.map(function(b){return{status:"asleep",start:b.start,end:b.end,duration:b.end-b.start}})},this.g);default:return P.prototype.to.call(this,a)}};
Ya.prototype.merge=function(a){a=a.to(this.file_format());this.records=this.records.concat(za(this.records,a.records,["start","end"])).sort(function(b,d){return d.start-b.start});return this};Ya.prototype.file_format=function(){return"Fitbit"};Ya.prototype.format_info=function(){return{name:"Fitbit",title:"fitbit",url:"/src/Fitbit",statuses:["asleep"],extension:".csv",logo:"https://community.fitbit.com/html/assets/fitbit_logo_1200.png"}};R(Ya);function Za(a,b){function d(n){return{type:"text",member:"status",regexp:new RegExp(f.map(function(q){return"("+q[1]+")"}).join("|"),"i"),"export":function(q,m,r){return m[r]=Y(q[n])},"import":function(q,m,r){return f.some(function(x){return-1!=m[r].value.toString().search(new RegExp(x[1],"i"))&&(q[n]=x[0])})}}}function k(n){return{"export":function(q,m,r){q[n].forEach(function(x){return m[r++]=Y(x)});return!0},"import":function(q,m,r){for(q=q[n]=c.map(function(){return(m[r++]||{}).value});q.length&&
!q[q.length-1];)q.pop();return!0}}}b&&(this.g=b);var h=[],e={},f=Da();b={members:[],"export":function(){return!0},"import":function(n){return n.status="asleep"}};var c=[];if("url"==a.file_format()&&"SpreadsheetTable"==a.contents.file_format)e=a.contents.contents.member_map,Object.keys(e).forEach(function(n){var q=e[n];switch(n){case "start":case "end":h[q[1]]={member:q[0],type:"time",optional:!0};break;case "status":h[q[1]]=Object.assign({members:[q[0]]},d(q[0]));break;case "comments":c=q[2];1==c.length?
h[q[1]]={member:q[0],type:"text"}:h.push(Object.assign({members:c},k(q[0])));break;default:return U()}}),e.status||h.push(b);else if("Standard"==a.file_format())e={start:["start",0],end:["end",1],status:["status",2],comments:["comments",3]},h=[{member:"start",type:"time",optional:!0},{member:"end",type:"time",optional:!0},d("status"),{members:["comments"],"export":function(n,q,m){return q[m]=Y((n.comments||[]).join("; "))},"import":function(n,q,m){q[m].value&&(n.comments=q[m].value.split(/ *; */));
return!0}}];else if(a.sheets&&a.sheets[0]&&a.sheets[0].cells[0]){if(a.sheets[0].cells[0].map(function(n,q){return[n,q]}).filter(function(n){var q=n[0].value;"string"!=typeof q&&(q="");if(![["end",/w.ke|stop|end/i],["start",/sleep|start|begin/i]].some(function(m){if(-1==q.search(m[1]))return!1;e.hasOwnProperty(m[0])||(e[m[0]]=[q,n[1]],h[n[1]]={member:q,type:"time",optional:!0});return!0}))if(-1!=q.search(/event|activity|stat(e|us)/i))e.hasOwnProperty("status")||(e.status=[q,n[1]],h[n[1]]=Object.assign({members:[q]},
d(q)));else{if(q&&-1==q.search(/comment|note/i))return!0;c.push(n)}return!1}).filter(function(n){var q=n[0].value;if(e.hasOwnProperty("start"))if(e.hasOwnProperty("end"))if(/date|time/i.test(q))h[n[1]]={member:q,optional:!0,ea:!0};else return!0;else e.end=[q,n[1]],h[n[1]]={member:q,type:"time",optional:!0};else e.start=[q,n[1]],h[n[1]]={member:q,type:"time",optional:!0};return!1}).length||!e.hasOwnProperty("start")||!e.hasOwnProperty("end"))return U();for(var p=0;p!=h.length;++p)if(!h[p])return U();
if(c.length)if(e.comments=[c[0][0].value,c[0][1],c.map(function(n){return n[0].value})],1==c.length)h[c[0][1]]={member:c[0][0].value,type:"text"};else{if(c[0][1]!=h.length)return U();for(p=1;p<c.length;++p)if(c[p][1]!=c[p-1][1]+1)return U();h.push(Object.assign({members:c.map(function(n){return n[0].value})},k(c[0][0].value)))}e.hasOwnProperty("status")||h.push(b)}else return U();this.member_map=e;this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:h}],!0);if(!wa(this,a)){var l=this.member_map;
a=a.to("Standard").records;l.hasOwnProperty("status")||(a=a.filter(function(n){return"asleep"==n.status}));l.hasOwnProperty("comments")&&(a=a.map(function(n){n.comments&&(n=Object.assign({},n),n.comments=n.comments.map(function(q){return"string"==typeof q?q:q.text}),1==c.length&&(n.comments=n.comments[0]));return n}));this.records=a.map(function(n){var q={};Object.keys(l).forEach(function(m){return q[l[m][0]]=n[m]});return q})}}L(Za,P);
Za.prototype.to=function(a){switch(a){case "output":var b=[],d=[];Object.values(this.member_map).forEach(function(h){d[h[1]]=h[0];h[2]?b=b.concat(h[2]):b[h[1]]=h[0]});return Q(this,{file_format:function(){return"string"},contents:b.filter(function(h){return void 0!==h}).join()+"\n"+this.records.map(function(h){var e=[];d.forEach(function(f){f=h[f];Array.isArray(f)?e=e.concat(f.map(Ma)):e.push(Ma(f))});return e.join()+"\n"}).join("")});case "Standard":var k=this.member_map;return new Z({records:this.records.map(function(h){return{status:h[(k.status||
["status"])[0]],start:h[(k.start||["start"])[0]],end:h[(k.end||["end"])[0]],comments:h[(k.comments||["comments"])[0]]||[]}})},this.g);default:return P.prototype.to.call(this,a)}};
Za.prototype.merge=function(a){function b(h){return["status","start","end"].map(function(e){return h[(d[e]||[e])[0]]}).join()}a=a.to("Standard");var d=this.member_map,k={};this.records.forEach(function(h){return k[b(h)]=1});this.records=this.records.concat(a.records.map(function(h){var e={};Object.keys(d).forEach(function(f){h.hasOwnProperty(f)&&(e[d[f][0]]=h[f])});return e}).filter(function(h){return!k.hasOwnProperty(b(h))}));return this};Za.prototype.file_format=function(){return"SpreadsheetTable"};
Za.prototype.format_info=function(){return{name:"SpreadsheetTable",title:"Spreadsheet Table",url:"/src/SpreadsheetTable",extension:".xlsx",icon:"mdi-file-excel"}};R(Za);function $a(a,b){b&&(this.g=b);var d=Da(),k={};this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"start",type:"time"},{member:"end",type:"time"},{member:"status",type:"text"},{members:["comments"],"export":function(v,z,A){return z[A]=Y(v.comments.join("; "))},"import":function(v,z,A){return v.comments=z[A].value.split(/\s*;\s*/)}}]}]);if(a.sheets&&a.sheets[0]&&a.sheets[0].cells){var h=a.sheets[0].cells,e=0,f=0,c=h[0].map(function(v){return Ka(v,a.spreadsheet)});b=h.map(function(v){return Ka(v[0],
a.spreadsheet)});var p=Infinity,l=0,n=Infinity,q=0;h.forEach(function(v,z){return v.forEach(function(A,u){A.style&&(p=Math.min(p,u),l=Math.max(l,u),n=Math.min(n,z),q=Math.max(q,z))})});var m=[c,b].map(function(v){for(var z="number"!=typeof v[0]||isNaN(v[0])?[[1]]:[[0,v[0]]],A=1;A<v.length;++A)432E5<=v[A-1]&&432E5>v[A]&&(v[A]+=432E5),"number"!=typeof v[A]||isNaN(v[A])?z.push([A+1]):z[z.length-1].push(v[A]);v=z.sort(function(g,t){return t.length-g.length})[0];z=v.slice(1);var u;if(4<z.length)z.some(function(g){return 0>
g||864E5<=g})?u=1:23<z.length&&(u=2);else{var D=(new Date).getTime();z.length&&z.every(function(g){return 864E5<=g&&g<=D})&&(u=1)}return{lines:1,start:v[0],j:z,type:u}});switch(m[0].type){case 0:m[1].type&&(e=m[1]);break;case 1:switch(m[1].type){case 2:e=m[1];case 0:f=m[0];break;default:m[0].j.length>m[1].j.length?f=m[0]:e=m[1]}break;case 2:switch(m[1].type){case 1:e=m[1];case 0:f=m[0];break;default:m[0].j.length%24<m[1].j.length%24?f=m[0]:e=m[1]}}if(!f)if((m=e?1:0)?1==e.type:24<=c.length){var r=
[];c=c.length-m;c-=c%24;for(var x=0;x!=c;++x)r.push(864E5*x/c);f={lines:0,start:m,j:r,type:2}}else{r=[];c=(new Date).getTime();c-=c%864E5;for(x=Math.max(m+1,p);x<=l;++x)r.push(c-864E5*(l-x));f={lines:0,start:m,j:r,type:2}}if(!e)if(m=f.lines,1==f.type){r=[];b=b.length-m;b-=b%24;for(c=0;c!=b;++c)r.push(864E5*c/b);e={lines:0,start:m,j:r,type:2}}else{b=[];r=(new Date).getTime();r-=r%864E5;for(c=m=Math.max(m,n);c<=q;++c)b.push(r-864E5*(q-c));e={lines:0,start:m,j:b,type:2}}if(!f.j.length||!e.j.length)return U();
var H=[];e.j.forEach(function(v,z){var A=h[e.start+z];f.j.forEach(function(u,D){D=A[f.start+D]||{style:""};H.push({start:v+u,style:D.style||"",comments:D.value?[D.value]:[]})})});if(!H.length)return U();H=H.sort(function(v,z){return v.start-z.start});var C=[{style:NaN}];H.forEach(function(v){v.style==C[C.length-1].style?C[C.length-1].comments=C[C.length-1].comments.concat(v.comments):(C[C.length-1].end=v.start-1,C.push(v))});C.shift();var K={};C.forEach(function(v){var z=K[v.style]=K[v.style]||{u:[],
duration:0};z.u.push(v);v.end&&v.start&&(z.duration+=v.end-v.start)});var T=[],S=[];h.forEach(function(v,z){v.forEach(function(A,u){if(z<e.start-f.lines||z>=e.start+e.j.length||u<f.start-e.lines||u>=f.start+f.j.length)A.value&&S.push([z,u,A.value]),A.style&&T.push([z,u,A.style])})});var F=[];T.forEach(function(v){return F=F.concat(S.map(function(z){return[Math.abs(z[0]-v[0])+Math.abs(z[1]-v[1]),v[2],z[2]]}))});var E={};d.forEach(function(v){return E[v[0]]=new RegExp(v[1],"i")});var I={};F.sort(function(v,
z){return v[0]-z[0]}).forEach(function(v){if(K[v[1]]&&!I[v[2]]){I[v[2]]=1;var z=Object.keys(E).find(function(A){return-1!=v[2].search(E[A])});z?delete E[z]:z=v[2];k[z]=v[1];K[v[1]].u.forEach(function(A){delete A.style;A.status=z});delete K[v[1]]}});var N=0;Object.values(K).sort(function(v,z){return z.duration-v.duration}).forEach(function(v){var z=d.find(function(A){return E[A[0]]});z?(z=z[0],delete E[z]):z="Unknown status #"+ ++N;v.u.forEach(function(A){k[z]=A.style;A.status=z;delete A.style})})}else{if(wa(this,
a))return;C=a.to("Standard").records.map(function(v){var z={comments:[]};["start","end","status","comments"].forEach(function(A){return v.hasOwnProperty(A)&&(z[A]=v[A])});k[v.status]=d.find(function(A){return A[0]==v.status})[2];return z})}this.records=C;this.status_map=k}L($a,P);
$a.prototype.to=function(a){switch(a){case "output":throw Error("Please use to_async() to generate output for SpreadsheetGraph");case "Standard":return new Z({records:this.records},this.g);default:return P.prototype.to.call(this,a)}};
$a.prototype.to_async=function(a){var b=this;switch(a){case "output":var d=this.records,k=this.status_map,h=[60,30,15,5].map(function(m){return 6E4*m}).find(function(m){return!d.filter(function(r){return r.start%m}).length})||3E5,e=Infinity,f=0;d.forEach(function(m){e=Math.min(e,m.start);f=Math.max(f,m.end||m.start+1)});Infinity==e&&(e=f);e-=e%864E5;f-=f%864E5;var c=[[Y()]];a=["YYYY-MM-DD"];for(var p=[11],l=[{font:{size:10}}],n=0;864E5!=n;n+=h)c[0].push(Y(n/864E5,"#FFEEEEEE,#FFEEEEEE")),a.push("H:MM"),
p.push(5),l.push({font:{size:10}});for(n=e;n<=f;n+=864E5)c.push([Y(new Date(n),"#FFEEEEEE,#FFEEEEEE")]);d.forEach(function(m){var r=m.start,x=m.end||r+1,H=k[m.status];m=(m.comments||[]).slice(0);for(var C=Math.ceil(m.length/Math.max((x-r)/h)),K=r;K<Math.max(x,r+1);K+=h){var T=K%864E5;c[(K-T-e)/864E5+1][Math.floor(T/h)+1]=Y(m.splice(0,C).join("; "),H)}});var q={};d.forEach(function(m){var r=m.status;k[r]&&((q[r]=q[r]||[0,k[r],r])[0]+=m.end-m.start)});Object.values(q).sort(function(m,r){return r[0]-
m[0]}).forEach(function(m,r){r=c[r+1]=c[r+1]||[];r[c[0].length+2]=Y(void 0,m[1]);r[c[0].length+3]=Y(m[2])});this.spreadsheet.sheets[0]={name:"Sleep Graph",number_formats:a,cells:c,widths:p,styles:l,options:{properties:{defaultRowHeight:12.5},pageSetup:{paperSize:9,orientation:"landscape"}}};return this.spreadsheet.serialise().then(function(m){return Q(b,{file_format:function(){return"array"},contents:m})});default:return P.prototype.to_async.call(this,a)}};
$a.prototype.merge=function(a){function b(e){return["status","start","end"].map(function(f){return e[f]}).join()}a=a.to(this.file_format());var d={};this.records.forEach(function(e){return d[b(e)]=1});this.records=this.records.concat(a.records.filter(function(e){return!d.hasOwnProperty(b(e))}));var k=a.status_map,h=this.status_map;Object.keys(k).forEach(function(e){h.hasOwnProperty(e)||(h[e]=k[e])});return this};$a.prototype.file_format=function(){return"SpreadsheetGraph"};
$a.prototype.format_info=function(){return{name:"SpreadsheetGraph",title:"Spreadsheet Graph",url:"/src/SpreadsheetGraph",extension:".xlsx",icon:"mdi-file-excel-outline"}};R($a);}).call(this);
//# sourceMappingURL=sleepdiary-core.min.js.map
