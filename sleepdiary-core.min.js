(function(){/*
 Copyright 2020-2021 Sleepdiary Developers <sleepdiary@pileofstuff.org>

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use, copy,
 modify, merge, publish, distribute, sublicense, and/or sell copies
 of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
 BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
 ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.
*/
function aa(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}function ba(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):{next:aa(a)}}var ca="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b},da="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,e){if(a==Array.prototype||a==Object.prototype)return a;a[b]=e.value;return a};
function fa(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var e=a[b];if(e&&e.Math==Math)return e}throw Error("Cannot find global object");}var G=fa(this);function K(a,b){if(b)a:{var e=G;a=a.split(".");for(var k=0;k<a.length-1;k++){var n=a[k];if(!(n in e))break a;e=e[n]}a=a[a.length-1];k=e[a];b=b(k);b!=k&&null!=b&&da(e,a,{configurable:!0,writable:!0,value:b})}}var ha;
if("function"==typeof Object.setPrototypeOf)ha=Object.setPrototypeOf;else{var ia;a:{var ja={a:!0},ka={};try{ka.__proto__=ja;ia=ka.a;break a}catch(a){}ia=!1}ha=ia?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var la=ha;
function L(a,b){a.prototype=ca(b.prototype);a.prototype.constructor=a;if(la)la(a,b);else for(var e in b)if("prototype"!=e)if(Object.defineProperties){var k=Object.getOwnPropertyDescriptor(b,e);k&&Object.defineProperty(a,e,k)}else a[e]=b[e];a.ia=b.prototype}
K("Symbol",function(a){function b(d){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new e(k+(d||"")+"_"+n++,d)}function e(d,f){this.g=d;da(this,"description",{configurable:!0,writable:!0,value:f})}if(a)return a;e.prototype.toString=function(){return this.g};var k="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",n=0;return b});
K("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),e=0;e<b.length;e++){var k=G[b[e]];"function"===typeof k&&"function"!=typeof k.prototype[a]&&da(k.prototype,a,{configurable:!0,writable:!0,value:function(){return ma(aa(this))}})}return a});function ma(a){a={next:a};a[Symbol.iterator]=function(){return this};return a}
function na(a,b){a instanceof String&&(a+="");var e=0,k=!1,n={next:function(){if(!k&&e<a.length){var d=e++;return{value:b(d,a[d]),done:!1}}k=!0;return{done:!0,value:void 0}}};n[Symbol.iterator]=function(){return n};return n}K("Array.prototype.keys",function(a){return a?a:function(){return na(this,function(b){return b})}});K("Math.log10",function(a){return a?a:function(b){return Math.log(b)/Math.LN10}});
var oa="function"==typeof Object.assign?Object.assign:function(a,b){for(var e=1;e<arguments.length;e++){var k=arguments[e];if(k)for(var n in k)Object.prototype.hasOwnProperty.call(k,n)&&(a[n]=k[n])}return a};K("Object.assign",function(a){return a||oa});
K("Array.from",function(a){return a?a:function(b,e,k){e=null!=e?e:function(c){return c};var n=[],d="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];if("function"==typeof d){b=d.call(b);for(var f=0;!(d=b.next()).done;)n.push(e.call(k,d.value,f++))}else for(d=b.length,f=0;f<d;f++)n.push(e.call(k,b[f],f));return n}});
K("Promise",function(a){function b(f){this.h=0;this.l=void 0;this.g=[];this.J=!1;var c=this.A();try{f(c.resolve,c.reject)}catch(p){c.reject(p)}}function e(){this.g=null}function k(f){return f instanceof b?f:new b(function(c){c(f)})}if(a)return a;e.prototype.h=function(f){if(null==this.g){this.g=[];var c=this;this.l(function(){c.B()})}this.g.push(f)};var n=G.setTimeout;e.prototype.l=function(f){n(f,0)};e.prototype.B=function(){for(;this.g&&this.g.length;){var f=this.g;this.g=[];for(var c=0;c<f.length;++c){var p=
f[c];f[c]=null;try{p()}catch(h){this.A(h)}}}this.g=null};e.prototype.A=function(f){this.l(function(){throw f;})};b.prototype.A=function(){function f(h){return function(m){p||(p=!0,h.call(c,m))}}var c=this,p=!1;return{resolve:f(this.M),reject:f(this.B)}};b.prototype.M=function(f){if(f===this)this.B(new TypeError("A Promise cannot resolve to itself"));else if(f instanceof b)this.O(f);else{a:switch(typeof f){case "object":var c=null!=f;break a;case "function":c=!0;break a;default:c=!1}c?this.L(f):this.I(f)}};
b.prototype.L=function(f){var c=void 0;try{c=f.then}catch(p){this.B(p);return}"function"==typeof c?this.P(c,f):this.I(f)};b.prototype.B=function(f){this.K(2,f)};b.prototype.I=function(f){this.K(1,f)};b.prototype.K=function(f,c){if(0!=this.h)throw Error("Cannot settle("+f+", "+c+"): Promise already settled in state"+this.h);this.h=f;this.l=c;2===this.h&&this.N();this.T()};b.prototype.N=function(){var f=this;n(function(){if(f.U()){var c=G.console;"undefined"!==typeof c&&c.error(f.l)}},1)};b.prototype.U=
function(){if(this.J)return!1;var f=G.CustomEvent,c=G.Event,p=G.dispatchEvent;if("undefined"===typeof p)return!0;"function"===typeof f?f=new f("unhandledrejection",{cancelable:!0}):"function"===typeof c?f=new c("unhandledrejection",{cancelable:!0}):(f=G.document.createEvent("CustomEvent"),f.initCustomEvent("unhandledrejection",!1,!0,f));f.promise=this;f.reason=this.l;return p(f)};b.prototype.T=function(){if(null!=this.g){for(var f=0;f<this.g.length;++f)d.h(this.g[f]);this.g=null}};var d=new e;b.prototype.O=
function(f){var c=this.A();f.C(c.resolve,c.reject)};b.prototype.P=function(f,c){var p=this.A();try{f.call(c,p.resolve,p.reject)}catch(h){p.reject(h)}};b.prototype.then=function(f,c){function p(l,r){return"function"==typeof l?function(z){try{h(l(z))}catch(J){m(J)}}:r}var h,m,q=new b(function(l,r){h=l;m=r});this.C(p(f,h),p(c,m));return q};b.prototype.catch=function(f){return this.then(void 0,f)};b.prototype.C=function(f,c){function p(){switch(h.h){case 1:f(h.l);break;case 2:c(h.l);break;default:throw Error("Unexpected state: "+
h.h);}}var h=this;null==this.g?d.h(p):this.g.push(p);this.J=!0};b.resolve=k;b.reject=function(f){return new b(function(c,p){p(f)})};b.race=function(f){return new b(function(c,p){for(var h=ba(f),m=h.next();!m.done;m=h.next())k(m.value).C(c,p)})};b.all=function(f){var c=ba(f),p=c.next();return p.done?k([]):new b(function(h,m){function q(z){return function(J){l[z]=J;r--;0==r&&h(l)}}var l=[],r=0;do l.push(void 0),r++,k(p.value).C(q(l.length-1),m),p=c.next();while(!p.done)})};return b});
K("Array.prototype.find",function(a){return a?a:function(b,e){a:{var k=this;k instanceof String&&(k=String(k));for(var n=k.length,d=0;d<n;d++){var f=k[d];if(b.call(e,f,d,k)){b=f;break a}}b=void 0}return b}});K("Object.values",function(a){return a?a:function(b){var e=[],k;for(k in b)Object.prototype.hasOwnProperty.call(b,k)&&e.push(b[k]);return e}});
K("Array.prototype.fill",function(a){return a?a:function(b,e,k){var n=this.length||0;0>e&&(e=Math.max(0,n+e));if(null==k||k>n)k=n;k=Number(k);0>k&&(k=Math.max(0,n+k));for(e=Number(e||0);e<k;e++)this[e]=b;return this}});function P(a){return a?a:Array.prototype.fill}K("Int8Array.prototype.fill",P);K("Uint8Array.prototype.fill",P);K("Uint8ClampedArray.prototype.fill",P);K("Int16Array.prototype.fill",P);K("Uint16Array.prototype.fill",P);K("Int32Array.prototype.fill",P);
K("Uint32Array.prototype.fill",P);K("Float32Array.prototype.fill",P);K("Float64Array.prototype.fill",P);var pa={},qa=[],ra,sa=(new Intl.DateTimeFormat).resolvedOptions().timeZone;ra="UTC"==sa?"Etc/GMT":sa;function Q(a,b){b&&(this.g=b)}Q.file_format=function(){return"DiaryBase"};Q.prototype.merge=function(){return this};Q.prototype.clone=function(){return ta({file_format:"storage-line",contents:{file_format:this.file_format(),contents:JSON.parse(JSON.stringify(this,function(a,b){return"spreadsheet"==a?void 0:b}))}},this.g)};
Q.prototype.to=function(a){switch(a){case this.file_format():return this;case "url":return"sleepdiary="+encodeURIComponent(JSON.stringify({file_format:this.file_format(),contents:this},function(b,e){return"spreadsheet"==b?void 0:e}));case "json":return JSON.stringify(this,function(b,e){return"spreadsheet"==b?void 0:e});case "storage-line":return"storage-line:"+this.file_format()+":"+JSON.stringify(this,function(b,e){return"spreadsheet"==b?void 0:e});default:if(pa.hasOwnProperty(a))return new pa[a](this.to("Standard"),
this.g);throw Error(this.file_format()+" cannot be converted to "+a);}};Q.prototype.to_async=function(a){switch(a){case "spreadsheet":if(!this.spreadsheet.synchronise())throw Error("Could not synchronise data");return this.spreadsheet.serialise();default:var b=this.to(a);return b.then?b:{then:function(e){return e(b)}}}};function R(a,b){return a.g?a.g(b):b}
function ua(a){var b=a.prototype.format_info();b.constructor=a;qa.push(b);"/"==b.url[0]&&(b.url="https://sleepdiary.github.io/core"+b.url);"Standard"!=b.name&&(pa[b.name]=b.constructor)}function T(){throw null;}function va(a){throw Error("Does not appear to be a valid "+a.file_format()+" file");}
function wa(a,b){switch(b.file_format()){case "url":return b=b.contents,a.file_format()==b.file_format?(Object.keys(b.contents).forEach(function(e){return a[e]=b.contents[e]}),!0):T();case "string":case "spreadsheet":if(a.spreadsheet.load(b))return!0;case "archive":case "array":T()}return!1}function V(a,b){var e="";if(a)for(b=Math.pow(10,(b||2)-1);b>a;b/=10)e+="0";else for(var k=1;k<(b||2);++k)e+="0";return e+a}
function xa(a){try{var b=self.DOMParser;if(!b)throw"";}catch(e){b=require("@xmldom/xmldom").DOMParser}return(new b).parseFromString(a,"application/xml")}
function ya(a,b){if(null===a||void 0===a)return NaN;if(a.getTime)return a=a.getTime(),864E5>=a&&(a+=b||0),a;if(a.match){if(b=a.match(/^((19|20)[0-9]{2})[-.]?([0-9]{2})[-.]?([0-9]{2})[T ]?([0-9]{2})[.:]?([0-9]{2})(?:[.:]?([0-9]{2}))?Z?$/))return(new Date(parseInt(b[1],10),parseInt(b[3],10)-1,parseInt(b[4],10),parseInt(b[5],10),parseInt(b[6],10),parseInt(b[7]||0,10))).getTime();a.search(/^[0-9]{4,}$/)||(a=parseInt(a,10))}if("number"==typeof a)return b=12-Math.floor(Math.log10(a)),a*Math.pow(10,a&&2<
Math.abs(b)?b:0);if(!a||!a.search)return NaN;b=(-1==a.search(/[a-su-y]/i)&&-1!=a.search(/-.*-/)?a:a.replace(/\s*(-|to).*/,"")).replace(/([ap])\s*(m)/i,"$1$2").toLowerCase();if(-1!=b.search(/midnight/i))return 0;if(-1!=b.search(/midd?ay|noon|12pm/i))return 432E5;var e=b.match(/^([0-9]*)(:([0-9]*))?\s*([ap])m$/);return e?36E5*(parseInt(e[1],10)+parseInt(e[3]||"0",10)/60+("p"==e[4]?12:0)):(e=b.match(/^([0-9]*)(:([0-9]*))?(:([0-9]*))?$/))?36E5*(parseInt(e[1],10)+parseInt(e[3]||"0",10)/60+parseInt(e[5]||
"0",10)/3600):Date.parse(b)||Date.parse(a)}function za(a,b,e){if("function"!=typeof e){var k=e;e=function(d){return k.map(function(f){return d[f]}).join("\ue000")}}var n={};a.forEach(function(d){return n[e(d)]=1});return b.filter(function(d){return!n.hasOwnProperty(e(d))})}function Aa(){try{var a=self.tc;if(!a)throw"";}catch(b){a=require("timezonecomplete")}return a}function W(a,b){var e=Aa();a=new e.DateTime(a||0,e.zone("Etc/UTC"));return b?a.toZone(e.zone(b)):a}
function Ca(a,b){for(var e=Aa().TzDatabase.instance(),k=a-1728E5;k<a;k+=36E5)try{var n=e.nextDstChange(b,k);if(!n)return Infinity;if(n>a)return n}catch(d){return Infinity}return e.nextDstChange(b,a)||Infinity}
function Da(){return[["awake","w.ke",""],["asleep","sle*p(?!.*aid)","#FFFFFF00,#FF0000FF,#FFFFFFFF"],["lights off","light.*(?:out|off)","#FFFFFFFF,#FF000080,#FFFFFFFF"],["lights on","light.*on","#FFFFFFFF,#FFE6E6FF"],["snack","snack","#FFFF7FFF,#FF7FFF7F"],["meal","meal|eat","#FFFF00FF,#FF00FF00"],["alcohol","alco","#FF1FAFEF,#FFE05010,#FFFFFFFF"],["chocolate","choc","#FF84C0FF,#FF7B3F00,#FFFFFFFF"],["caffeine","caffeine|coffee|tea|cola","#FF0B3B8B,#FFF4C474"],["drink","drink","#FFDF8F5F,#FF2070a0,#FFFFFFFF"],
["sleep aid","sle*p.*aid|pill|tranq","#FFAFFF7F,#FF500080,#FFFFFFFF"],["exercise","exercise","#FF00C0C0,#FFFF3F3F"],["toilet","toilet|bathroom|loo","#FF363636,#FFC9C9C9"],["noise","noise","#FF8F8F8F,#FF707070,#FFFFFFFF"],["alarm","alarm","#FF000000,#FFFF0000"],["in bed","down|(in|to).*bed","#FFA0A000,#FF5f5fff"],["out of bed","up|out.*bed","#FF0000FF,#FFFFFFCC"]]}Q.prototype.timezones=function(){return Object.keys(self.tzdata.zones).sort()};Q.prototype.software_version=function(){return"72f51fd"};
function ta(a,b){var e=Error("This does not appear to be a sleep diary"),k=a.file_format;if("string"==typeof a)k="string",a={file_format:function(){return"string"},contents:a};else if(k)"string"==typeof k?a.file_format=function(){return k}:k=k(),"url"==k?a.contents=JSON.parse(decodeURIComponent(a.contents.replace(/^sleep-?diary=/,""))):"storage-line"==k&&(k="url");else throw e;"string"==k&&Object.assign(a,Ea(a.contents));for(var n=0;n!=qa.length;++n)try{return new qa[n].constructor(a,b)}catch(d){d&&
(e=d)}throw e;};function Fa(a,b,e){function k(f){return function(){(history.state||{})["sleepdiary-core-processed"]||location.hash.replace(/(?:^#|[?&])(sleep-?diary=[^&]*)/g,function(c,p){history.replaceState(Object.assign({"sleepdiary-core-processed":e},history.state||{}),"");d.load({file_format:"url",contents:p},f)})}}this.success_callback=a||function(){};this.error_callback=b||function(){};var n,d=this;2!=e&&(n=setInterval(function(){self.tc&&(clearInterval(n),self.addEventListener("hashchange",k("hashchange"),
!1),k("hash")())},100));Ga()}function Ha(){return[[self.JSZip,"https://cdn.jsdelivr.net/npm/jszip@3.6.x/dist/jszip.min.js"],[self.tc,"https://cdn.jsdelivr.net/npm/tzdata@1.0.x/tzdata.js","https://cdn.jsdelivr.net/npm/timezonecomplete@5.12.x/dist/timezonecomplete.min.js"],[self.ExcelJS,"https://cdn.jsdelivr.net/npm/exceljs@4.2.x/dist/exceljs.min.js"]]}
function Ga(){try{var a=[];Ha().forEach(function(b){b[0]||(a=a.concat(b.slice(1)))});self.importScripts?self.importScripts.apply(self,a):a.forEach(function(b){var e=document.createElement("script");e.src=b;document.head.appendChild(e)})}catch(b){}}
Fa.prototype.load=function(a,b){var e=this;if(Ha().some(function(f){return!f[0]}))return setTimeout(function(){return e.load(a,b)},100);var k=self.JSZip;if(!k)return setTimeout(function(){return e.load(a,b)},100);if("string"==typeof a&&!a.search(/^(blob|data):/)){var n=new XMLHttpRequest;n.responseType="blob";n.onload=function(){return e.load([n.response],b)};n.open("GET",a);return n.send()}b||(b=a);a.target&&a.target.files&&(a=a.target.files);a.replace&&a.replace(/^storage-line:([^:]+):(.*)/,function(f,
c,p){a={file_format:"storage-line",contents:{file_format:c,contents:JSON.parse(p)}}});if("string"!=typeof a&&a.length)Array.from(a).forEach(function(f){var c=new FileReader,p=new k;c.onload=function(){return Ia(c.result).then(function(h){return e.load(h,b)},function(){return p.loadAsync(c.result).then(function(h){function m(){l.length?h.file(l[0]).async("string").then(function(r){q[l[0]]=r;l.shift();m()}):e.load({file_format:"archive",contents:q},b)}var q={},l=Object.keys(h.files);m()},function(){var h=
e.error_callback;try{e.error_callback=function(){},e.load({file_format:"array",contents:c.result},b),e.error_callback=h}catch(m){e.error_callback=h,c.onload=function(){return e.load({file_format:"string",contents:c.result},b)},c.readAsText(f)}})})};c.readAsArrayBuffer(f)});else{try{var d=self.new_sleep_diary(a,Fa.serialiser)}catch(f){throw this.error_callback(a,b),f;}d?this.success_callback(d,b):this.error_callback(a,b)}};
Fa.serialiser=function(a){switch(a.file_format()){case "array":return a.contents;case "string":return btoa(unescape(encodeURIComponent(a.contents)));case "archive":var b=function(e,k){var n=self.JSZip;if(!n)return setTimeout(function(){return b(e,k)},100);var d=new n;Object.keys(a.contents).forEach(function(f){return d.file(f,a.contents[f])});return d.generateAsync({type:"base64",compression:"DEFLATE"}).then(e,k)};Ga();return new Promise(b);default:throw Error("Unsupported output format: "+a.file_format());
}};Fa.to_url=function(a){if("string"==typeof a)return"data:application/octet-stream;base64,"+a;a.file_format&&a.contents&&("archive"==a.file_format()?a=JSON.stringify(a):a=a.contents);return URL.createObjectURL(new Blob([a]))};var Ja={number:"General",time:'YYYY-MM-DD" "HH:MM',duration:"[h]:mm"};
function X(a,b,e){function k(f){var c=f.member;switch(f.type){case "time":var p=function(m,q,l){return q[l]=Y(void 0===m[c]?void 0:new Date(m[c]))};break;case "duration":p=function(m,q,l){return q[l]=Y(void 0===m[c]?void 0:m[c]/864E5)};break;default:p=function(m,q,l){return q[l]=Y(m[c])}}if(f.optional){var h=p;p=function(m,q,l){return void 0===m[c]||h(m,q,l)}}return p}function n(f,c){var p=f.member;switch(f.type){case "time":var h=e?function(l,r,z){return!isNaN(l[p]=r[z].H)}:function(l,r,z){return!isNaN(l[p]=
r[z].S)};break;case "duration":h=function(l,r,z){return!isNaN(l[p]=r[z].value.getTime()+c.epoch_offset)};break;case "number":h=function(l,r,z){return!isNaN(l[p]=parseFloat(r[z].value))};break;case "boolean":h=function(l,r,z){return!isNaN(l[p]=!!r[z].value)};break;default:h=function(l,r,z){l[p]=r[z].value;return!0}}if(f.regexp){var m=h;h=function(l,r,z){return f.regexp.test(r[z].value)&&m(l,r,z)}}if(f.optional){var q=h;h=function(l,r,z){return!r[z]||null==r[z].value||q(l,r,z)||""==r[z].value}}return h}
var d=this;this.g=null;this.h=a;this.l=b.map(function(f){return{sheet:f.sheet||f.member,member:f.member||f.sheet,type:f.type||"list",optional:!!f.optional,cells:f.cells.map(function(c){if(c.members){for(c.formats=(c.formats||[]).map(function(p){return Ja[p]||p});c.formats.length<c.members.length;)c.formats.push("General");return c}return{members:[c.member],regexp:c.regexp||RegExp(""),formats:[Ja[c.type]||"General"],"export":k(c),"import":n(c,d)}})}});this.epoch_offset=0;this.sheets=[]}
function Y(a,b){return{value:a,style:b||""}}X.prototype.get_sheet=function(a,b,e){var k=b.join("\x00"),n=this.sheets.filter(function(d){return d.cells[0]&&d.cells[0].map(function(f){return f.value}).join("\x00")==k});return n.length?[!1,n.find(function(d){return d.name==a})||n[0]]:[!0,{name:a,number_formats:e.map(function(d){return d?Ja[d]||d:"General"}),cells:[b.map(function(d){return Y(d,"#FFEEEEEE,#FFEEEEEE")})]}]};
function Ka(a,b){return ya((a||{}).hasOwnProperty("value")?a.value:a,b?(b.properties||{}).date1904?20828448E5:22091616E5:0)}function La(a,b){var e=0;a.forEach(function(k){return k.forEach(function(n){var d=n.S=Ka(n,b);d=n.H=isNaN(d)||0>d||864E5<d?d:d+e-e%864E5;d<e&&(n.H=d+=864E5);e=d})})}
function Ia(a){function b(k){return k.hasOwnProperty("argb")?"#"+k.argb:k.hasOwnProperty("indexed")?"i"+k.indexed:k.hasOwnProperty("theme")?"t"+k.theme:""}try{var e=new self.ExcelJS.Workbook}catch(k){e=new (require("exceljs").Workbook)}return e.xlsx.load(a).then(function(){if(e._worksheets.length){var k=[];e.eachSheet(function(n){var d={name:n.name,cells:[]};k.push(d);n.eachRow({includeEmpty:!0},function(f,c){var p=d.cells[c-1]=[];f.eachCell({includeEmpty:!0},function(h,m){var q="";h.style&&h.style.fill&&
(q=b(h.style.fill.bgColor||{})+","+b(h.style.fill.fgColor||{}));1==q.length&&(q="");if((h.value||{}).getTime){var l=h.value.getTime();if(1==l%1E3||-999==l%1E3)h.value=new Date(l-1);if(-1==l%1E3||999==l%1E3)h.value=new Date(l+1)}p[m-1]=Y(h.value,q)})})});k.forEach(function(n){return La(n.cells,e)});return{file_format:"spreadsheet",spreadsheet:e,sheets:k}}throw Error("empty spreadsheet");})}
function Ea(a){"\ufeff"==a[0]&&(a=a.substr(1));-1==a.search(/[\r\n]$/)&&(a+="\n");if(!a.search(/^(([^",\r\n]*|"([^"]|"")*")(,([^",\r\n]*|"([^"]|"")*"))*(?:\r\n|\r|\n))*$/)){try{var b=new self.ExcelJS.Workbook}catch(c){b=new (require("exceljs").Workbook)}for(var e=b.addWorksheet("Records"),k=b.addWorksheet("Settings"),n=[],d=0,f=[[Y("Setting"),Y("Value")]];!a.search(/^([A-Za-z_][A-Za-z0-9_]*)=[^,]*\n/);)a=a.replace(/([^=]*?)=(.*)\n/,function(c,p,h){f.push([p,h].map(function(m){return Y(m)}));k.addRow([p,
h]);return""});a.replace(/([^",\r\n]*|"([^"]|"")*")(,([^",\r\n]*|"([^"]|"")*"))*(?:\r\n|\r|\n)/g,function(c){var p=e.getRow(++d),h=[],m=0;n.push(h);c.replace(/([^",\r\n]*|"([^"]|"")*")[,\r\n]/g,function(q){var l=p.getCell(++m);l.value='"'==q[0]?q.substr(1,q.length-3).replace(/""/g,'"'):q.substr(0,q.length-1);h.push(Y(l.value))})});La(n);return{spreadsheet:b,sheets:[{name:"Records",cells:n},{name:"Settings",cells:f}]}}}
function Na(a){return void 0===a?"":a.getTime?W(a.getTime()).format("yyyy-MM-ddTHH:mm:ss.SSS")+"Z":-1==a.toString().search(/[",\n]/)?a:'"'+a.replace(/"/g,'""')+'"'}
X.prototype.load=function(a){var b=this,e=a.sheets;if(!e)return!1;var k=this.epoch_offset;this.epoch_offset=(a.spreadsheet.properties||{}).date1904?20828448E5:22091616E5;if(!this.l.every(function(n){return e.some(function(d){var f=d.cells,c="dictionary"==n.type;if(!f.length||c&&2!=f.length)return!1;var p=f[0].slice(0);if(!n.cells.every(function(r){return r.members.every(function(z){return z==(p.shift()||{value:NaN}).value})}))return!1;var h=[];if(!f.slice(1).every(function(r){if(!r.length)return!0;
var z=0,J={};h.push(J);return n.cells.every(function(D){return D["import"](J,r,(z+=D.members.length)-D.members.length)})}))return!1;var m=n.member;if(c)b.h[m]=Object.assign(h[0],b.h[m]||{});else{b.h[m]||(b.h[m]=[]);var q=b.h[m];q.length>=f.length&&q.splice(0,f.length-1);h.forEach(function(r,z){return q[z]=Object.assign(r,q[z])})}var l=[];n.cells.forEach(function(r){return l=l.concat(r.formats)});d.number_formats=l;return!0})}))return this.epoch_offset=k,!1;this.g=a.spreadsheet;this.sheets=e;return!0};
X.prototype.synchronise=function(){var a=this;return this.l.every(function(b){function e(m){var q=[],l=0;p.push(q);return b.cells.every(function(r){return r["export"](m,q,(l+=r.members.length)-r.members.length)})}var k="dictionary"==b.type,n=[],d=[];b.cells.forEach(function(m){n=n.concat(m.members);d=d.concat(m.formats)});var f=a.get_sheet(b.sheet,n,d),c=f[0];f=f[1];var p=f.cells=[n.map(function(m){return Y(m,"#FFEEEEEE,#FFEEEEEE")})],h=a.h[b.member||b.sheet];if(k){if(!e(h))return!1}else if(!h.every(e))return!1;
c&&a.sheets.push(f);return!0})};
X.prototype.serialise=function(){function a(d){switch(d[0]){case "#":return{argb:d.slice(1)};case "i":return{indexed:parseInt(d.slice(1),10)};case "t":return{theme:parseInt(d.slice(1),10)};default:return{}}}var b=this,e=!this.g;if(!this.g){try{this.g=new self.ExcelJS.Workbook}catch(d){this.g=new (require("exceljs").Workbook)}this.epoch_offset=(this.g.properties||{}).date1904?20828448E5:22091616E5}var k=this.epoch_offset,n={};this.sheets.forEach(function(d){return n[d.name]=0});this.g.eachSheet(function(d,
f){n.hasOwnProperty(d.name)?n[d.name]=d:b.g.ga(f)});this.sheets.forEach(function(d){var f=n[d.name]||b.g.addWorksheet(d.name,d.options);f.eachRow({includeEmpty:!0},function(c,p){var h=d.cells[p-1]||[];c.eachCell({includeEmpty:!0},function(m,q){h[q]||(m.value=null,m.style={})})});d.cells.forEach(function(c,p){var h=f.getRow(p+1);c.forEach(function(m,q){var l=h.getCell(q+1);l.value=e&&(m.value||{}).getTime&&0<=m.value.getTime()&&864E5>m.value.getTime()?new Date(m.value.getTime()-k):m.value;m=m.style.split(",");
l=l.style=l.style||{};q=((d.styles||[])[q]||{}).font;m[0]||m[1]||m[2]?(l.fill=l.fill||{},l.fill.type="pattern",l.fill.pattern="solid",m[0]?l.fill.bgColor=a(m[0]):delete l.fill.bgColor,m[1]?l.fill.fgColor=a(m[1]):delete l.fill.fgColor,m[2]?(l.font=l.font||{},l.font.color=a(m[2])):delete l.font):l&&l.fill&&(delete l.fill.bgColor,delete l.fill.fgColor);q&&Object.assign(l.font=l.font||{},q)});h.commit()});d.widths?d.widths.forEach(function(c,p){return f.columns[p].width=c}):f.columns.forEach(function(c){return c.width=
18});d.styles&&d.styles.forEach(function(c,p){return f.columns[p].style=c});(d.number_formats||[]).forEach(function(c,p){return f.getColumn(p+1).numFmt=c})});return this.g.xlsx.writeBuffer()};
function Oa(a){var b=a.l[0];return(a.h.settings||[]).map(function(e){return e.Setting+"="+e.Value+"\n"}).concat([b.cells.map(function(e){return e.members.join(",")}).join(",")+"\n"],a.h[b.member].map(function(e){var k=[],n=0;b.cells.forEach(function(d){return d["export"](e,k,(n+=d.members.length)-d.members.length)});return k.map(function(d){return Na(d.value)}).join(",")+"\n"})).join("")}X.prototype.file_format=function(){return"Spreadsheet"};var Pa={new_sleep_diary:ta,sleepdiary_engines:qa,DiaryLoader:Fa,Spreadsheet:X};"undefined"!==typeof module&&module.exports?module.exports=Pa:Object.keys(Pa).forEach(function(a){return self[a]=Pa[a]});var Qa={Z:"awake",da:"in bed",Y:"asleep","lights off":"lights off","lights on":"lights on",ha:"snack",fa:"meal",X:"alcohol",aa:"chocolate",$:"caffeine",ba:"drink","sleep aid":"sleep aid",ca:"exercise",ja:"toilet",R:"noise",W:"alarm","in bed":"in bed","out of bed":"out of bed"};
function Z(a,b){b&&(this.g=b);a.records&&!a.file_format&&(a={file_format:function(){return"Standard"},contents:a});this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"status",regexp:new RegExp("^("+Object.values(Qa).join("|")+")$"),type:"string"},{member:"start",type:"time",optional:!0},{member:"end",type:"time",optional:!0},{member:"start_timezone",type:"string",optional:!0},{member:"end_timezone",type:"string",optional:!0},{member:"duration",type:"duration",optional:!0},
{members:["tags"],"export":function(h,m,q){return m[q]=Y((h.tags||[]).join("; "))},"import":function(h,m,q){m[q].value&&(h.tags=m[q].value.split(/ *; */));return!0}},{members:["comments"],"export":function(h,m,q){return m[q]=Y((h.comments||[]).map(function(l){return l.time?"TIME="+l.time+" "+l.text:l}).join("; "))},"import":function(h,m,q){m[q].value&&(m=m[q].value.split(/ *; */).map(function(l){var r;l=l.replace(/^TIME=([0-9]*) */,function(z,J){r=parseInt(J,10);return""});return r?{time:r,text:l}:
l}),h.comments=m);return!0}},{member:"day_number",type:"number",optional:!0},{member:"start_of_new_day",type:"boolean",optional:!0},{member:"is_primary_sleep",type:"boolean",optional:!0},{member:"missing_record_after",type:"boolean",optional:!0}]},{sheet:"Settings",member:"settings",type:"dictionary",cells:[{member:"minimum_day_duration",type:"duration"},{member:"maximum_day_duration",type:"duration"}]}]);switch(a.file_format()){case "string":try{a={file_format:function(){return"Standard"},contents:JSON.parse(a.contents)}}catch(h){return T()}if("Standard"!=
a.contents.file_format)return T();default:if(!wa(this,a)){b=a.contents;if("Standard"!=a.file_format()||null===b||"object"!=typeof b||!Array.isArray(b.records))return T();this.records=b.records.map(function(h){return Object.assign({},h)}).sort(function(h,m){return h.start-m.start||h.end-m.end});a=b.settings||b;var e=a.minimum_day_duration||576E5,k=a.maximum_day_duration||2*e;this.settings={minimum_day_duration:e,maximum_day_duration:k};var n=0,d=0,f={status:"",day_number:-1},c=[],p=f;this.records.forEach(function(h){["start",
"end"].forEach(function(q){void 0==h[q]&&delete h[q]});["tags","comments"].forEach(function(q){(h[q]||[]).length||delete h[q]});h.hasOwnProperty("duration")||(h.duration=h.end-h.start,isNaN(h.duration)&&delete h.duration);h.hasOwnProperty("start_of_new_day")?h.start_of_new_day&&(n=h.start):h.start_of_new_day="asleep"==h.status&&h.start>n+e;h.hasOwnProperty("day_number")?d=h.day_number:(h.start_of_new_day&&(d=h.start>n+k?d+2:d+1,n=h.start),h.day_number=d);if("awake"==h.status||"asleep"==h.status)p.hasOwnProperty("missing_record_after")||
(p.missing_record_after=h.status==p.status),p=h;"asleep"==h.status&&(c[h.day_number]||{duration:-Infinity}).duration<h.duration&&(c[h.day_number]=h);if(h.hasOwnProperty("comments")){var m=h.comments;void 0===m?delete h.comments:Array.isArray(m)||(h.comments=[m])}f=h});c.forEach(function(h){h&&!h.hasOwnProperty("is_primary_sleep")&&(h.is_primary_sleep=!0)})}}}L(Z,Q);
Z.prototype.to=function(a){switch(a){case "output":return a=Object.assign({file_format:this.file_format()},this),delete a.spreadsheet,R(this,{file_format:function(){return"string"},contents:JSON.stringify(a)});default:return Q.prototype.to.call(this,a)}};
Z.prototype.merge=function(a){var b={};[this,a.to(this.file_format())].forEach(function(e){return e.records.forEach(function(k){return b[[k.start,k.end,k.status].join()]=k})});this.records=Object.values(b).sort(function(e,k){return e.start-k.start||e.end-k.end});return this};Z.prototype.file_format=function(){return"Standard"};Z.prototype.format_info=function(){return{name:"Standard",title:"Standardised diary format",url:"/src/Standard",extension:".json"}};
function Ra(a,b){function e(q,l){return q+Math.pow(l-m,2)}function k(q,l){return q+l}var n=a.map(function(q){return q[0]}).filter(function(q){return void 0!==q}),d=n.length;if(!d)return null;var f=n.sort(function(q,l){return q-l}),c=f.slice(Math.round(.25*f.length),Math.round(.75*f.length)),p=n.reduce(k)/(d||1),h=c.reduce(k)/(c.length||1);f={average:p,mean:p,interquartile_mean:h,median:f[Math.floor(f.length/2)],interquartile_range:c[c.length-1]-c[0],durations:a.map(function(q){return q?q[0]:void 0}),
timestamps:a.map(function(q){return q?q[1]:void 0}),interquartile_durations:c,rolling_average:a.map(b?function(q,l){if(!(14>l)){q=a.slice(Math.max(0,l-13),l+1).map(function(z){return z[0]}).filter(function(z){return void 0!==z});var r=[0,0];q.forEach(function(z){z<1*b/4?++r[0]:z>3*b/4&&++r[1]});return q.length?(q.reduce(function(z,J){return z+J})+(r[0]<r[1]?r[0]*b:r[1]*-b))/q.length:void 0}}:function(q,l){q=a.slice(Math.max(0,l-13),l+1).map(function(r){return r[0]}).filter(function(r){return void 0!==
r});return 14<=l&&q.length?q.reduce(function(r,z){return r+z})/q.length:void 0})};var m=p;f.standard_deviation=Math.sqrt(n.reduce(e,0)/d);m=h;f.interquartile_standard_deviation=Math.sqrt(c.reduce(e,0)/c.length);return f}Z.prototype.summarise_records=function(a){return Ra((a?this.records.filter(a):this.records).map(function(b){return[b.duration,b.start||b.end]}))};
Z.prototype.summarise_days=function(a){var b=[],e=this.records.length?this.records[this.records.length-1].day_number:0;for((a?this.records.filter(a):this.records).forEach(function(n){var d=n.day_number;(b[d]||0)<n.start&&0<d&&d<e&&(b[d]=n.start)});b.length&&!b[0];)b.shift();a=[];for(var k=1;k<b.length;++k)b[k]&&b[k-1]&&(a[k-1]=[b[k]-b[k-1],b[k-1]]);return Ra(a)};
Z.prototype.total_per_day=function(a,b){var e=[],k=this.records.length?this.records[this.records.length-1].day_number:0;(b?this.records.filter(b):this.records).forEach(function(n){return(e[n.day_number]=e[n.day_number]||[0,n.start])[0]+=a&&!a(n)?0:1});for(e=e.slice(1,k);e.length&&void 0===e[0];)e.shift();return Ra(e)};
Z.prototype.summarise_schedule=function(a,b,e){b=b||864E5;e=e||ra;var k=b/2,n=[],d=[],f=[],c=[];(a?this.records.filter(a):this.records).forEach(function(q){if(q.is_primary_sleep){if(q.start){var l=q.start;l+=6E4*W(l,q.start_timezone||e).offset();n.push([l%b,l]);d.push([(l+k)%b,l])}q.end&&(l=q.end,l+=6E4*W(l,q.end_timezone||e).offset(),f.push([l%b,l]),c.push([(l+k)%b,l]))}});a=Ra(n,b);var p=Ra(d,b),h=Ra(f,b),m=Ra(c,b);[[p,a],[m,h]].forEach(function(q){q[0]&&(["average","mean","interquartile_mean",
"median"].forEach(function(l){return q[0][l]=(q[0][l]+k)%b}),["durations","interquartile_durations"].forEach(function(l){return q[0][l]=q[1][l]}),q[0].rolling_average=q[1].rolling_average)});return{wake:(h||{}).standard_deviation<(m||{}).standard_deviation?h:m,sleep:(a||{}).standard_deviation<(p||{}).standard_deviation?a:p}};
Z.prototype.daily_activities=function(a,b,e,k){function n(F,E){E.time=((E.start||E.end)+(E.end||E.start))/2;E.record=F;E.index=r++;F=q[q.length-1];var H=F.start,M=F.duration;["start","end","time"].forEach(function(v){E[v]&&(E["offset_"+v]=(E[v]-H)/M)});return E}function d(F){for(var E=p;D.unixUtcMillis()<=F;)if(E=p,l=0,++m,c=D,D=D.add(e,z),D.unixUtcMillis()>=p){p=Ca(c.unixUtcMillis(),a);var H=D.add(6E4*(c.offset()-D.offset()),z);if(c.lessThan(H)){var M=D.unixUtcMillis()>F;D=H;if(M)break}}if(!l&&(M=
c.unixUtcMillis(),F=D.unixUtcMillis(),H=q[m]={start:M,end:F,duration:F-M,id:c.toString(),year:c.year(),month:c.month()-1,day:c.day()-1,activities:l=[]},0<k))for(H=H.segments=[];M<F;){var v=new Date(M+S);H.push({dst_state:U?"on":"off",id:v.toISOString().replace(/Z/,h),year:v.getUTCFullYear(),month:v.getUTCMonth(),day:v.getUTCDate()-1,hour:v.getUTCHours(),minute:v.getUTCMinutes(),second:v.getUTCSeconds()});M+=k;M>=E&&(E=W(M,c.zone().name()),H[H.length-1].dst_state="change-"+(U?"back":"forward"),N=E.offsetDuration(),
S=N.milliseconds(),U=!N.equals(c.standardOffsetDuration()),E=Ca(E.unixUtcMillis(),a))}}a=a||ra;b=void 0===b?648E5:b;e=e||864E5;var f=this.records.sort(function(F,E){return(F.start||F.end)-(E.start||E.end)}),c=f.find(function(F){return F.start||F.end}),p=Ca(c?(c.start||c.end)-1:0,a),h=a.replace(/^([A-Za-z])/," $1"),m=0,q=[],l,r,z=Aa().TimeUnit.Millisecond;if(c){c=W(c.start||c.end,a);var J=c.unixUtcMillis()-c.startOfDay().unixUtcMillis();c=c.sub((J<b?864E5:0)+J-b,z);var D=c.add(e,z);b=D.add(6E4*(c.offset()-
D.offset()),z);b.greaterThan(c)&&(D=b);var N=c.offsetDuration();var S=N.milliseconds();var U=!N.equals(c.standardOffsetDuration());f.forEach(function(F){r=0;var E=F.start,H=F.end;if(E)if(d(E),H)if(D.unixUtcMillis()>=H)l.push(n(F,{start:E,end:H,type:"start-end"}));else{for(l.push(n(F,{start:E,end:D.unixUtcMillis(),type:"start-mid"}));;){d(D.unixUtcMillis()+1);if(D.unixUtcMillis()>=H)break;l.push(n(F,{start:c.unixUtcMillis(),end:D.unixUtcMillis(),type:"mid-mid"}))}l.push(n(F,{start:c.unixUtcMillis(),
end:H,type:"mid-end"}))}else l.push(n(F,{start:E,type:"start-unknown"}));else H&&(d(H),l.push(n(F,{end:H,type:"unknown-end"})))})}q.forEach(function(F){var E=F.activity_summaries={};F.activities.forEach(function(H){var M=H.record.status,v=E[M]=E[M]||{duration:0};["start","end"].forEach(function(y){var A=H[y];void 0!==A&&(A=W(A,a).toString(),v["last_"+y]=A,void 0==v["first_"+y]&&(v["first_"+y]=A))});v.duration=H.start&&H.end?v.duration+(H.end-H.start):NaN})});return q};
Z.prototype.latest_sleep_status=function(){for(var a=this.records.length-1;0<=a;--a){var b=this.records[a].status;if("awake"==b||"asleep"==b)return b}return""};ua(Z);function Sa(a,b){function e(g){return g.substr(1,g.length-2)}function k(g){return(new Date(g.substr(1,g.length-2))).getTime()}function n(g){var t=g.match(y);return{string:g,year:parseInt(t[1],10),month:parseInt(t[2],10),day:parseInt(t[3],10),hour:parseInt(t[4],10),minute:parseInt(t[5],10),offset:("-"==t[6]?-1:1)*(60*parseInt(t[7],10)+parseInt(t[8],10))}}function d(g,t){g=W(g,t);t=g.offset();return{string:'"'+g.year()+"-"+V(g.month())+"-"+V(g.day())+" "+V(g.hour())+":"+V(g.minute())+(0>t?"-":"+")+
V(Math.abs(Math.round(t/60)))+V(Math.abs(t%60))+'"',year:g.year(),month:g.month(),day:g.day(),hour:g.hour(),minute:g.minute(),offset:t}}function f(g,t){var x=Math.floor(t/60),w=Math.floor(t%60);g=new Date((g.getTime?g.getTime():g)+6E4*(60*x+w));return{string:'"'+g.getUTCFullYear()+"-"+V(g.getUTCMonth()+1)+"-"+V(g.getUTCDate())+" "+V(g.getUTCHours())+":"+V(g.getUTCMinutes())+("-"==t[0]?"":"+")+V(Math.floor(t/60),2)+V(Math.floor(t%60),2)+'"',year:g.getUTCFullYear(),month:g.getUTCMonth()+1,day:g.getUTCDate(),
hour:g.getUTCHours(),minute:g.getUTCMinutes(),offset:t}}function c(g){var t=[];if(""!=g){g=g.split("|");for(var x=0;x!=g.length;++x){var w=g[x].split("-");t.push({wake:parseInt(w[0],10),sleep:parseInt(w[1],10)})}}return t}function p(g){var t=[];if(g.length&&"NONE"!=g){g=g.split("|");for(var x=0;x!=g.length;++x){var w=g[x].split(":");t.push({type:w[0],mood:parseInt(w[1],10),themes:w.slice(2)})}}return t}function h(g){return g.length&&"NONE"!=g?g.split("|"):[]}function m(g){g=g.match(E);return{custom_aid_id:g[1],
"class":g[2],name:e(g[3])}}function q(g){g=g.match(H);return{custom_hindrance_id:g[1],"class":g[2],name:e(g[3])}}function l(g){g=g.match(M);return{custom_tag_id:g[1],name:e(g[2])}}function r(g){g=g.match(v);var t=c(g[28]);return{start:k(g[19]),end:k(g[1]),duration:t.reduce(function(x,w){return x+w.sleep-w.wake},k(g[1])-k(g[10])),wake:n(g[1]),sleep:n(g[10]),bedtime:n(g[19]),holes:t,type:g[34],dreams:p(g[35]),aids:h(g[47]),hindrances:h(g[51]),tags:h(g[55]),quality:parseInt(g[59],10),notes:e(g[60])}}
function z(g){var t=!0,x={D:[],F:[],G:[],u:[]};g=g.split("\n");for(var w=0;w!=g.length;++w){var O=g[w];if(t){switch(O){case "custom_aid_id,class,name":var B=x.D;var I=E;break;case "custom_hindrance_id,class,name":B=x.F;I=H;break;case "custom_tag_id,name":B=x.G;I=M;break;case "wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes":B=x.u;I=v;break;default:if(B)B[B.length-1]+="\n",--w;else return va(this)}t=!1}else if(""==g[w])t=!0;else{for(;'"'!=O.substr(O.length-1);){if(++w==g.length)return va(this);
O+="\n"+g[w]}if(I.test(O))B.push(O);else if(B.length)B[B.length-1]+="\n"+O;else return va(this)}}return x}b&&(this.g=b);var J="ALCOHOL AMBIEN AMBIEN_CR AROMATHERAPY BENADRYL CHAMOMILE CIRCADIN CPAP DOZILE EAR_PLUGS EXERCISE GABA IMOVANE LUNESTA MAGNESIUM MARIJUANA MEDITATION MELATONIN MILK MUSIC NYQUIL READING RESTAVIT ROZEREM SEX SOUND_MACHINE ST_JOHNS_WORT TV TYLENOL TYLENOL_PM UNISOM UNISOM2 VALERIAN ZIMOVANE".split(" "),D="ALARM_CLOCK ANGER ANXIETY ARGUMENT BABY_CRYING BATHROOM_BREAK TOO_BRIGHT BUNKMATE_SNORING CAFFEINE TOO_COLD DOG_BARKING FIRE_ANTS HEARTBURN TOO_HOT HUNGER LOUD_NEIGHBOR MIND_RACING PAIN PHONE_RANG RESTLESS_LEGS SCARY_MOVIE SICK SQUIRRELS_ON_ROOF STORM STRESS SUGAR VIDEO_GAME WIND".split(" "),
N="ALONE BUNKMATE CAMPING COUCH GOING_FISHING HOTEL OUT_OF_TOWN PASSED_OUT_DRUNK SCHOOL_NIGHT SLEEP_TALKING SLEEP_WALKING SLEPT_AT_FRIENDS_PLACE SLEPT_IN_CAR WORK_NIGHT".split(" ");b=J.join("|")+"|CUSTOM_[0-9]*";var S=D.join("|")+"|CUSTOM_[0-9]*",U=N.join("|")+"|CUSTOM_[0-9]*",F={};[J,D,N].forEach(function(g,t){return g.forEach(function(x){return F[x]=t})});J=/^CUSTOM_[0-9]*$/;var E=/^(CUSTOM_[0-9]*),(AIRWAY|BEVERAGE|DRUG|EXERTION|HERBAL|READING|RELAXATION|SENSORY_DEPRIVATION|SOUND),("(.|\n)*")$/,
H=/^(CUSTOM_[0-9]*),(ENVIRONMENTAL|MENTAL|NOISE|OBLIGATION|PHYSICAL|STIMULANT),("(.|\n)*")$/,M=/^(CUSTOM_[0-9]*),("(.|\n)*")$/,v=new RegExp('^("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),(|([1-9][0-9]*)-([1-9][0-9]*)(\\|([1-9][0-9]*)-([1-9][0-9]*))*),(NIGHT_SLEEP|NAP),(NONE|((UNKNOWN|GOOD|EROTIC|NEUTRAL|STRANGE|CREEPY|TROUBLING|NIGHTMARE):(-[1-5]|[0-5])(:(CHASE|COMPENSATORY|DAILY_LIFE|DEATH|EPIC|FALLING|FALSE_AWAKENING|FLYING|LUCID|MURDER|MUTUAL|NAKED_IN_PUBLIC|ORGASMIC|PHYSIOLOGICAL|PRECOGNITIVE|PROGRESSIVE|RECURRING|RELIGIOUS|SIGNAL|TEETH|TEST|MONEY))*)(\\|((UNKNOWN|GOOD|EROTIC|NEUTRAL|STRANGE|CREEPY|TROUBLING|NIGHTMARE):(-[1-5]|[0-5])(:(CHASE|COMPENSATORY|DAILY_LIFE|DEATH|EPIC|FALLING|FALSE_AWAKENING|FLYING|LUCID|MURDER|MUTUAL|NAKED_IN_PUBLIC|ORGASMIC|PHYSIOLOGICAL|PRECOGNITIVE|PROGRESSIVE|RECURRING|RELIGIOUS|SIGNAL|TEETH|TEST|MONEY))*))*),(NONE|('+
(b+")(\\|("+b+"))*),(NONE|(")+(S+")(\\|("+S+"))*),(NONE|(")+(U+")(\\|("+U+'))*),([0-9]|10),("(.|\n)*")$')),y=/"([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"/;this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{members:["start","start_offset"],formats:["time",null],"export":function(g,t,x){t[x]=Y(new Date(g.start));t[x+1]=Y(g.bedtime.offset);return!0},"import":function(g,t,x){g.start=t[x].value.getTime();return g.bedtime=f(t[x].value,
t[x+1].value)}},{members:["end","end_offset"],formats:["time",null],"export":function(g,t,x){t[x]=Y(new Date(g.end));t[x+1]=Y(g.wake.offset);return!0},"import":function(g,t,x){g.end=t[x].value.getTime();return g.wake=f(t[x].value,t[x+1].value)}},{member:"duration",type:"duration"},{members:["sleep","sleep_offset"],formats:["time",null],"export":function(g,t,x){t[x]=Y(new Date(g.sleep.string.substr(1,g.sleep.string.length-2)));t[x+1]=Y(g.sleep.offset);return!0},"import":function(g,t,x){return g.sleep=
f(t[x].value,t[x+1].value)}},{members:["holes"],regexp:/^([0-9]*-[0-9]*)*$/,"export":function(g,t,x){t[x]=Y(g.holes.map(function(w){return w.wake+"-"+w.sleep}).join("|"));return!0},"import":function(g,t,x){g.holes=c(t[x].value);return!0}},{member:"type",regexp:/^(NIGHT_SLEEP|NAP)$/},{members:["dreams"],"export":function(g,t,x){t[x]=Y(g.dreams.map(function(w){return[w.type,w.mood].concat(w.themes).join(":")}).join("|"));return!0},"import":function(g,t,x){return g.dreams=p(t[x].value)}},{members:["aids"],
"export":function(g,t,x){t[x]=Y(g.aids.join("|"));return!0},"import":function(g,t,x){g.aids=h(t[x].value);return!0}},{members:["hindrances"],"export":function(g,t,x){t[x]=Y(g.hindrances.join("|"));return!0},"import":function(g,t,x){g.hindrances=h(t[x].value);return!0}},{members:["tags"],"export":function(g,t,x){t[x]=Y(g.tags.join("|"));return!0},"import":function(g,t,x){g.tags=h(t[x].value);return!0}},{member:"quality",regexp:/^[0-9]*$/},{member:"notes"}]},{sheet:"Custom Aids",member:"custom_aids",
cells:[{member:"custom_aid_id",regexp:J},{member:"class",regexp:/^(AIRWAY|BEVERAGE|DRUG|EXERTION|HERBAL|READING|RELAXATION|SENSORY_DEPRIVATION|SOUND)$/},{member:"name"}]},{sheet:"Custom Hindrances",member:"custom_hindrances",cells:[{member:"custom_hindrance_id",regexp:J},{member:"class",regexp:/^(ENVIRONMENTAL|MENTAL|NOISE|OBLIGATION|PHYSICAL|STIMULANT)$/},{member:"name"}]},{sheet:"Custom Tags",member:"custom_tags",cells:[{member:"custom_tag_id",regexp:J},{member:"name"}]}]);b=[];S=[];var A=[],u=
[];switch(a.file_format()){case "string":if(-1==a.contents.search("wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes"))return T();a=z(a.contents);b=a.D.map(m);S=a.F.map(q);A=a.G.map(l);u=a.u.map(r);break;default:if(wa(this,a))return;var C={};a.to("Standard").records.forEach(function(g){switch(g.status){case "in bed":C[g.end]=[g.start,g.start_timezone];break;case "asleep":var t=[[],[],[]],x=C[g.start]||[g.start,g.start_timezone];(g.tags||[]).forEach(function(w){if(F.hasOwnProperty(w))t[F[w]].push(w);
else{var O=A.find(function(B){return w==B.name});O?t[2].push(O.custom_tag_id):(O="CUSTOM_"+V(A.length+1,4),A.push({custom_tag_id:O,name:w}),t[2].push(O))}});u.push({start:x[0],end:g.end,duration:g.duration,wake:d(g.end,g.end_timezone),sleep:d(g.start,g.start_timezone),bedtime:d(x[0],x[1]),holes:[],type:g.is_primary_sleep?"NIGHT_SLEEP":"NAP",dreams:[],aids:t[0],hindrances:t[1],tags:t[2],quality:5,notes:(g.comments||[]).join("; ")})}})}this.custom_aids=b;this.custom_hindrances=S;this.custom_tags=A;
this.records=u}L(Sa,Q);
Sa.prototype.to=function(a){switch(a){case "output":var b="";this.custom_aids.length&&(b+="custom_aid_id,class,name\n",this.custom_aids.forEach(function(c){return b+=c.custom_aid_id+","+c["class"]+',"'+c.name+'"\n'}),b+="\n");this.custom_hindrances.length&&(b+="custom_hindrance_id,class,name\n",this.custom_hindrances.forEach(function(c){return b+=c.custom_hindrance_id+","+c["class"]+',"'+c.name+'"\n'}),b+="\n");this.custom_tags.length&&(b+="custom_tag_id,name\n",this.custom_tags.forEach(function(c){return b+=c.custom_tag_id+
',"'+c.name+'"\n'}),b+="\n");b+="wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes\n";this.records.forEach(function(c){return b+=[c.wake.string,c.sleep.string,c.bedtime.string,c.holes.map(function(p){return p.wake+"-"+p.sleep}).join("|"),c.type,c.dreams.map(function(p){return[p.type,p.mood].concat(p.themes).join(":")}).join("|")||"NONE",c.aids.join("|")||"NONE",c.hindrances.join("|")||"NONE",c.tags.join("|")||"NONE",c.quality,'"'+c.notes+'"'].join()+"\n"});return R(this,{file_format:function(){return"string"},
contents:b});case "Standard":var e=function(c){c=Math.round(c.offset/60);return 0>c?"Etc/GMT+"+Math.abs(c):0<c?"Etc/GMT-"+c:"Etc/GMT"},k={},n={},d={},f=[];this.custom_aids.forEach(function(c){return k[c.custom_aid_id]=c.name});this.custom_hindrances.forEach(function(c){return n[c.custom_hindrance_id]=c.name});this.custom_tags.forEach(function(c){return d[c.custom_tag_id]=c.name});this.records.forEach(function(c){var p=c.sleep;p=(new Date(p.string.substr(1,p.string.length-2))).getTime();c.start<p&&
f.push({status:"in bed",start:c.start,end:p,start_timezone:e(c.bedtime),end_timezone:e(c.sleep)});var h=[];c.aids.forEach(function(m){return h.push(k[m]||m)});c.hindrances.forEach(function(m){return h.push(n[m]||m)});c.tags.forEach(function(m){return h.push(d[m]||m)});f.push(Object.assign({status:"asleep",start:void 0===c.start?p||void 0:Math.max(c.start,p),end:c.end,start_timezone:e(c.sleep),end_timezone:e(c.wake),tags:h,comments:c.notes.length?[c.notes]:[]},void 0===c.duration?{}:{duration:c.duration},
"NIGHT_SLEEP"==c.type?{is_primary_sleep:!0}:{}))});return new Z({records:f},this.g);default:return Q.prototype.to.call(this,a)}};
Sa.prototype.merge=function(a){var b=this,e={},k={},n={};a=a.to(this.file_format());this.custom_aids.length&&a.custom_aids.length?a.custom_aids.forEach(function(d){var f=b.custom_aids.find(function(p){return p["class"]==d["class"]&&p.name==d.name});if(!f){var c="CUSTOM_0001";for(f=2;b.custom_aids.some(function(p){return p.custom_aid_id==c});++f)c="CUSTOM_"+V(f,4);f={custom_aid_id:c,"class":d["class"],name:d.name};b.custom_aids.push(f)}e[d.custom_aid_id]=f.custom_aid_id}):a.custom_aids.forEach(function(d){return e[d.custom_aid_id]=
d.custom_aid_id});this.custom_hindrances.length&&a.custom_hindrances.length?a.custom_hindrances.forEach(function(d){var f=b.custom_hindrances.find(function(p){return p["class"]==d["class"]&&p.name==d.name});if(!f){var c="CUSTOM_0001";for(f=2;b.custom_hindrances.some(function(p){return p.custom_hindrance_id==c});++f)c="CUSTOM_"+V(f,4);f={custom_hindrance_id:c,"class":d["class"],name:d.name};b.custom_hindrances.push(f)}k[d.custom_hindrance_id]=f.custom_hindrance_id}):a.custom_hindrances.forEach(function(d){return k[d.custom_hindrance_id]=
d.custom_hindrance_id});this.custom_tags.length&&a.custom_tags.length?a.custom_tags.forEach(function(d){var f=b.custom_tags.find(function(p){return p.name==d.name});if(!f){var c="CUSTOM_0001";for(f=2;b.custom_tags.some(function(p){return p.custom_tag_id==c});++f)c="CUSTOM_"+V(f,4);f={custom_tag_id:c,name:d.name};b.custom_tags.push(f)}n[d.custom_tag_id]=f.custom_tag_id}):a.custom_tags.forEach(function(d){return n[d.custom_tag_id]=d.custom_tag_id});this.records=this.records.concat(za(this.records,a.records,
function(d){return[d.wake.string,d.sleep.string,d.bedtime.string].join()}).map(function(d){return Object.assign({},d,{aids:d.aids.map(function(f){return e[f]||f}),hindrances:d.hindrances.map(function(f){return k[f]||f}),tags:d.tags.map(function(f){return n[f]||f})})})).sort(function(d,f){return d.wake-f.wake});return this};Sa.prototype.file_format=function(){return"Sleepmeter"};
Sa.prototype.format_info=function(){return{name:"Sleepmeter",title:"Sleepmeter",url:"/src/Sleepmeter",statuses:["in bed","asleep"],extension:".csv",logo:"http://www.squalllinesoftware.com/sites/squalllinesoftware.com/files/sleepmeter_logo_128x128.png"}};ua(Sa);function Ta(a,b){function e(u){return u.substr(1,u.length-2).replace(E,'"').replace(H,"\n")}function k(u){var C=[];u.replace(U,function(g,t){3<t.length&&("_2x"==t.substr(t.length-3)?C.push({count:2,value:t.substr(0,t.length-3)}):"_3x"==t.substr(t.length-3)?C.push({count:3,value:t.substr(0,t.length-3)}):C.push({count:1,value:t}))});return C}function n(u){var C=u.match(J);return{string:u,year:parseInt(C[3],10),month:parseInt(C[2],10),day:parseInt(C[1],10),hour:parseInt(C[4],10),minute:parseInt(C[5],
10)}}function d(u,C){u=W(u,C);return{string:'"'+V(u.day())+". "+V(u.month())+". "+u.year()+" "+u.hour()+":"+V(u.minute())+'"',year:u.year(),month:u.month(),day:u.day(),hour:u.hour(),minute:u.minute()}}function f(u,C){return C.some(function(g){return g==u})?null:p(u)}function c(u,C){return C.some(function(g){return g==u})?null:p(u)}function p(u){return parseFloat(u.substr(1,u.length-2))}function h(u,C){return C.some(function(g){return g==u})?null:e(u)}function m(u){var C={},g=xa(u).documentElement;
u=Array.from(g.getElementsByTagName("long"));var t=Array.from(g.getElementsByTagName("int")),x=Array.from(g.getElementsByTagName("boolean"));g=Array.from(g.getElementsByTagName("string"));u.forEach(function(w){return C[w.getAttribute("name")]=parseInt(w.getAttribute("value"),10)});t.forEach(function(w){return C[w.getAttribute("name")]=parseInt(w.getAttribute("value"),10)});x.forEach(function(w){return C[w.getAttribute("name")]="true"==w.getAttribute("value")});g.forEach(function(w){return C[w.getAttribute("name")]=
w.textContent});return C}function q(u){var C=[];u=u.split("\n");""==u[u.length-1]&&u.pop();for(var g={},t=0;t!=u.length;g={i:g.i,s:g.s,m:g.m,v:g.v,o:g.o},t+=2){var x=function(B){return function(I){return W(["year","month","day"].map(function(ea){return V(I[ea])}).join("-")+"T"+["hour","minute"].map(function(ea){return V(I[ea])}).join(":"),B.i.Tz).unixUtcMillis()}}(g),w=u[t].match(l);g.s=[];g.m=[];if(!w)return va(this);w[1].replace(D,function(B){return function(I,ea,Ba){B.s.push({header_string:I,hours:parseInt(ea,
10),minutes:parseInt(Ba,10),actigraphy:null,noise:null})}}(g));w[5].replace(/"Event"/g,function(B){return function(){B.m.push({label:null,timestamp:null})}}(g));w=u[t+1].match(r);if(!w)return va(this);g.v=0;g.o=0;var O=e(w[27]);g.i={Id:e(w[1]),Tz:e(w[3]),From:n(w[5]),To:n(w[11]),Sched:n(w[17]),Hours:p(w[23]),Rating:p(w[25]),Comment:{string:O,tags:k(O),notags:O.replace(F,"")},Framerate:e(w[29]),Snore:f(w[31],['"-1"']),Noise:c(w[32],['"-1.0"']),Cycles:f(w[34],['"-1"']),DeepSleep:c(w[35],['"-1.0"','"-2.0"']),
LenAdjust:c(w[37],['"-1.0"']),Geo:h(w[39],[""]),times:g.s,events:g.m};g.i.start=parseInt(g.i.Id,10);g.i.end=g.i.start+36E5*g.i.Hours;g.i.duration=Math.round(6E4*(60*g.i.Hours+("-1.0"==w[37]?0:g.i.LenAdjust)));g.i.alarm=6E4*Math.round((g.i.end+x(g.i.Sched)-x(g.i.To))/6E4);w[40].replace(N,function(B){return function(I){B.s[B.v++].V=p(I)}}(g));w[43].replace(S,function(B){return function(I,ea,Ba,$a,Ma){B.m[B.o].label=ea;B.m[B.o].timestamp=parseInt(Ba,10);Ma&&(B.m[B.o].value=parseFloat(Ma));++B.o}}(g));
if(x=u[t+2]?u[t+2].match(z):0)g.v=0,x[1].replace(N,function(B){return function(I){B.s[B.v++].R=p(I)}}(g)),++t;C.push(g.i)}return C}b&&(this.g=b);var l=/^Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)$/,r=/^("([^"]|"")*"),("([^"]|"")*"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(.[0-9]*)?"),("[0-9]*(.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(.[0-9]*)?"),("-?[0-9]*"),("(-[12].0|0.[0-9]*|1.0)"),("-?[0-9]*(.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(.[0-9]*)?")*)((,"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)$/,
z=/^,,,,,,,,,,,,((,"-?[0-9]*(.[0-9]*)?")*)$/;b=/^(Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)\n("([^"]|"")*"),("([^"]|"")*"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(.[0-9]*)?"),("[0-9]*(.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(.[0-9]*)?"),("-?[0-9]*"),("(-[12].0|0.[0-9]*|1.0)"),("-?[0-9]*(.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(.[0-9]*)?")*)((,"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)\n(,,,,,,,,,,,,((,"-?[0-9]*(.[0-9]*)?")*)\n)?)*(Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)\n("([^"]|"")*"),("([^"]|"")*"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(.[0-9]*)?"),("[0-9]*(.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(.[0-9]*)?"),("-?[0-9]*"),("(-[12].0|0.[0-9]*|1.0)"),("-?[0-9]*(.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(.[0-9]*)?")*)((,"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)(\n,,,,,,,,,,,,((,"-?[0-9]*(.[0-9]*)?")*))?)\n?$/;
var J=/"([0-9]*). ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"/,D=/"([0-9]*):([0-9]*)"/g,N=/"-?[0-9]*(.[0-9]*)?"/g,S=/"([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?"/g,U=/#([^ ",][^ ",]*)/g,F=/ *#([^ ",][^ ",]*)/g,E=/""/g,H=/ \\n /g,M={},v=[];this.spreadsheet=new X(this,[]);var y=a.contents;switch(a.file_format()){case "spreadsheet":if(!a.sheets.some(function(u){u=u.cells;if(!u.length)return!1;A=[];var C=1,g,t,x;return u.every(function(w){if("Id,Tz,From,To,Sched,Hours,Rating,Comment,Tags,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo"==
w.slice(0,16).map(function(B){return B.value}).join())t=[],x=[],g={times:t,events:x},A.push(g),C=2,w.slice(16).forEach(function(B){if("Event"==B.value)x.push({label:null,timestamp:null});else if("number"==typeof B.value){var I=Math.floor(24*B.value);B=Math.floor(1440*B.value)%60;t.push({header_string:I+":"+V(B),hours:I,minutes:B,actigraphy:null,noise:null})}else return!1});else if(2==C){C=3;["Id","Tz",,,,"Hours","Rating","Comment","Tags","Framerate","Snore","Noise","Cycles","DeepSleep","LenAdjust",
"Geo"].forEach(function(B,I){return g[B]=w[I]?w[I].value:null});g.Comment=g.Comment&&g.Tags?{string:g.Comment+" "+g.Tags,tags:k(g.Tags),notags:g.Comment}:g.Comment?{string:g.Comment,tags:[],notags:g.Comment}:g.Tags?{string:g.Tags,tags:k(g.Tags),notags:""}:{string:"",tags:[],notags:""};delete g.Tags;var O=w[1].value;g.start=w[2].value.getTime();g.From=d(w[2].value.getTime(),O);g.end=w[3].value.getTime();g.To=d(w[3].value.getTime(),O);g.alarm=w[4].value.getTime();g.Sched=d(w[4].value.getTime(),O);g.duration=
Math.round(6E4*(60*g.Hours+(g.LenAdjust||0)));t.forEach(function(B,I){w[16+I]&&(B.actigraphy=w[16+I].value)});x.forEach(function(B,I){w[16+t.length+I]&&(I=w[16+t.length+I].value.split("-"),B.label=I[0],B.timestamp=I[1],2<I.length&&(B.value=I[2]))})}else if(3==C)C=1,t.forEach(function(B,I){w[16+I]&&(B.noise=w[16+I].value)});else return!1;return!0})})||!a.sheets.some(function(u){u=u.cells;if(!u.length||"Alarm"!=u[0][0].value)return!1;v=u.slice(1).map(function(C){return JSON.parse(C[0].value)});return!0})||
!a.sheets.some(function(u){u=u.cells;if(!u.length||"Preferences"!=u[0][0].value)return!1;M=JSON.parse(u[1][0].value);return!0}))return T();break;case "string":if(!b.test(y))return T();var A=q.call(this,y);break;case "archive":if(y.hasOwnProperty("sleep-export.csv")&&y["prefs.xml"]&&y["alarms.json"]){A=q.call(this,y["sleep-export.csv"]);M=m(y["prefs.xml"]);v=JSON.parse(y["alarms.json"]);break}else return T();default:if(wa(this,a))return;A=a.to("Standard").records.filter(function(u){return"asleep"==
u.status}).map(function(u){return{start:u.start,end:u.end,duration:u.duration,alarm:6E4*Math.round(u.end/6E4),Id:(u.start||0).toString(),Tz:u.start_timezone||u.end_timezone||"Etc/GMT",From:d(u.start,u.start_timezone||u.end_timezone),To:d(u.end,u.end_timezone||u.start_timezone),Sched:d(u.end,u.end_timezone||u.start_timezone),Hours:(u.end-u.start)/36E5,Rating:2.5,Comment:{string:(u.comments||[]).join("\n")+(u.tags||[]).map(function(C){return"#"+C}).join(" "),tags:(u.tags||[]).map(function(C){return{count:1,
value:C}}),notags:(u.comments||[]).join("\n")},Framerate:"10000",Snore:null,Noise:null,Cycles:null,DeepSleep:null,LenAdjust:null,Geo:"",times:[],events:[]}})}this.records=A;this.prefs=M;this.alarms=v}L(Ta,Q);
Ta.prototype.to=function(a){var b=this,e=["Id","Tz","From","To","Sched"],k=["Hours","Rating"],n="Framerate Snore Noise Cycles DeepSleep LenAdjust Geo".split(" ");switch(a){case "output":var d=function(p,h){return'"'+(null===p?h:p)+'"'};a=JSON.stringify(this.alarms);var f="<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n<map>"+Object.keys(this.prefs).map(function(p){var h=b.prefs[p];switch(typeof h){case "boolean":return'\n\t<boolean name="'+p+'" value="'+h+'" />\n';case "number":return"\n\t<"+
(Math.abs(h)>=Math.pow(2,31)?"long":"int")+' name="'+p+'" value="'+h+'" />\n';default:return'\n\t<string name="'+p+'"><![CDATA['+h+"]]\x3e</string>\n"}}).join("")+"\n</map>\n",c=this.records.map(function(p){return[].concat(e,k,["Comment"],n,p.times.map(function(h){return',"'+h.header_string+'"'}),p.events.map(function(){return',"Event"'})).join(",")+"\n"+['"'+p.Id+'"','"'+p.Tz+'"'].concat(["start","end","alarm"].map(function(h){h=W(p[h],p.Tz);return'"'+V(h.day())+". "+V(h.month())+". "+h.year()+" "+
h.hour()+":"+V(h.minute())+'"'}),k.map(function(h){return'"'+p[h]+'"'}),['"'+p.Comment.string.replace(/"/g,'""').replace(/\n/g," \\n ")+'"','"'+p.Framerate+'"',d(p.Snore,"-1"),d(p.Noise,"-1.0"),d(p.Cycles,"-1"),d(p.DeepSleep,"-1.0"),d(p.LenAdjust,"-1.0"),d(p.Geo,"")],p.times.map(function(h){return'"'+h.actigraphy+'"'}),p.events.map(function(h){return'"'+h.label+"-"+h.timestamp+(h.hasOwnProperty("value")?"-"+h.value:"")+'"'})).join(",")+"\n"+(p.times.length?",,,,,,,,,,,,,"+p.times.map(function(h){return'"'+
h.noise+'"'}).join(",")+"\n":"")}).join("");return R(this,{file_format:function(){return"archive"},contents:{"sleep-export.csv":c,"prefs.xml":f,"alarms.json":a}});case "Standard":return new Z({records:this.records.map(function(p){return Object.assign({status:"asleep",start:p.start,end:p.end,start_timezone:p.Tz,end_timezone:p.Tz,tags:p.Comment.tags.map(function(h){return h.value}),comments:p.Comment.notags.length?[p.Comment.notags]:void 0},void 0===p.duration?{}:{duration:p.duration})})},this.g);default:return Q.prototype.to.call(this,
a)}};
Ta.prototype.to_async=function(a){var b=["Id","Tz","From","To","Sched"],e=["Hours","Rating"],k="Framerate Snore Noise Cycles DeepSleep LenAdjust Geo".split(" ");switch(a){case "spreadsheet":a=this.spreadsheet;var n=this.records.length?Math.max.apply(0,this.records.map(function(h){return h.times.length})):0,d=a.get_sheet("Records",b.concat(e,["Comment","Tags"],k),[null,null,"time","time","time",null,null,null,null,null,null,null,null,null,null].concat(Array(n).fill("duration")));n=d[0];d=d[1];var f=
d.cells;f.splice(0);this.records.forEach(function(h){f.push([].concat(b,e,["Comment","Tags"],k,h.times.map(function(m){return(60*m.hours+m.minutes)/1440}),h.events.map(function(){return"Event"})).map(function(m){return Y(m,"#FFEEEEEE,#FFEEEEEE")}));f.push([h.Id,h.Tz].concat(["start","end","alarm"].map(function(m){return new Date(h[m])}),e.map(function(m){return h[m]}),[h.Comment.notags,h.Comment.tags.map(function(m){return"#"+m.value+(1==m.count?"":"_"+m.count+"x")}).join(" "),h.Framerate,h.Snore,
h.Noise,h.Cycles,h.DeepSleep,h.LenAdjust,h.Geo],h.times.map(function(m){return m.actigraphy}),h.events.map(function(m){return m.label+"-"+m.timestamp+(m.hasOwnProperty("value")?"-"+m.value:"")})).map(function(m){return Y(m)}));h.times.some(function(m){return m.noise})&&f.push([].concat(Array(13).fill(""),h.times.map(function(m){return m.noise})).map(function(m){return Y(m)}))});d.cells=f;n&&a.sheets.push(d);d=a.get_sheet("Alarms",["Alarm"],[""]);n=d[0];d=d[1];var c=d.cells;c.splice(1);this.alarms.forEach(function(h){return c.push([Y(JSON.stringify(h))])});
n&&a.sheets.push(d);d=a.get_sheet("Preferences",["Preferences"],[""]);n=d[0];d=d[1];var p=d.cells;p.splice(1);p.push([Y(JSON.stringify(this.prefs))]);n&&a.sheets.push(d);return a.serialise();default:return Q.prototype.to_async.call(this,a)}};Ta.prototype.merge=function(a){a=a.to(this.file_format());this.records=this.records.concat(za(this.records,a.records,["Id"]));return this};Ta.prototype.file_format=function(){return"SleepAsAndroid"};
Ta.prototype.format_info=function(){return{name:"SleepAsAndroid",title:"Sleep as Android",url:"/src/SleepAsAndroid",statuses:["asleep"],extension:".zip",logo:"https://docs.sleep.urbandroid.org/assets/images/logo.png"}};ua(Ta);function Ua(a,b){b&&(this.g=b);this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"sid",regexp:/^[1-9][0-9]*$/,type:"number"},{member:"start",type:"time"},{member:"stop",type:"time"},{member:"rating",regexp:/^[0-5]$/,type:"number"}]}]);wa(this,a)||(this.records=a.to("Standard").records.filter(function(e){return"asleep"==e.status}).map(function(e,k){return{start:e.start,stop:e.end,sid:k+1,rating:0}}))}L(Ua,Q);
Ua.prototype.to=function(a){switch(a){case "output":return R(this,{file_format:function(){return"string"},contents:"sid,start,stop,rating\n"+this.records.map(function(b){return[b.sid,b.start,b.stop,b.rating].join()+"\n"}).join("")});case "Standard":return new Z({records:this.records.map(function(b){return{status:"asleep",start:b.start,end:b.stop}})},this.g);default:return Q.prototype.to.call(this,a)}};
Ua.prototype.merge=function(a){a=a.to(this.file_format());this.records=this.records.concat(za(this.records,a.records,["start","stop"]));this.records.forEach(function(b,e){return b.sid=e+1});return this};Ua.prototype.file_format=function(){return"PleesTracker"};Ua.prototype.format_info=function(){return{name:"PleesTracker",title:"Plees Tracker",url:"/src/PleesTracker",statuses:["asleep"],extension:".csv",logo:"https://raw.githubusercontent.com/vmiklos/plees-tracker/master/app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png"}};
ua(Ua);function Va(a,b){b&&(this.g=b);b=[];this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"start",type:"time"},{member:"end",type:"time"},{member:"forced awakening",type:"boolean"},{member:"delayed retirement",type:"boolean"}]}]);switch(a.file_format()){case "array":a=a.contents;if(a.byteLength%12)return T();for(var e=new Float32Array(a),k=new Uint8Array(a),n=1,d=0;d<a.byteLength/12;++d){var f=e[3*d],c=e[3*d+1],p=!k[12*d+8],h=!k[12*d+9];if(f<n||c<=f)return T();n=c;b.push({start:6E4*
Math.round(15776640+1440*f),end:6E4*Math.round(15776640+1440*c),"forced awakening":p,"delayed retirement":h})}break;default:if(wa(this,a))return;b=a.to("Standard").records.filter(function(m){return"asleep"==m.status}).map(function(m){return{start:m.start,end:m.end,"forced awakening":(m.tags||[]).some(function(q){return-1!=q.search(/forced awakening/i)}),"delayed retirement":(m.tags||[]).some(function(q){return-1!=q.search(/delayed retirement/i)})}})}this.records=b}L(Va,Q);
Va.prototype.to=function(a){switch(a){case "output":var b=new Float32Array(3*this.records.length),e=new Uint8Array(b.buffer);this.records.forEach(function(k,n){b[3*n]=(k.start-9465984E5)/864E5;b[3*n+1]=(k.end-9465984E5)/864E5;e[12*n+8]=k["forced awakening"]?0:255;e[12*n+9]=k["delayed retirement"]?0:255});return R(this,{file_format:function(){return"array"},contents:b.buffer});case "Standard":return new Z({records:this.records.map(function(k){return{status:"asleep",start:k.start,end:k.end,tags:[].concat(k["forced awakening"]?
["forced awakening"]:[],k["delayed retirement"]?["delayed retirement"]:[])}})},this.g);default:return Q.prototype.to.call(this,a)}};Va.prototype.merge=function(a){a=a.to(this.file_format());var b=1;this.records=this.records.concat(a.records).sort(function(e,k){return e.start-k.start}).filter(function(e){if(e.start<b||e.start>=e.end)return!1;b=e.end;return!0});return this};Va.prototype.file_format=function(){return"SleepChart1"};
Va.prototype.format_info=function(){return{name:"SleepChart1",title:"SleepChart 1.0",url:"/src/SleepChart1",statuses:["asleep"],extension:".tim",logo:"https://www.supermemo.com/assets/images/frontpage2/intro/icon4.svg"}};ua(Va);function Wa(a,b){b&&(this.g=b);this.spreadsheet=new X(this,[{sheet:"Activities",member:"activities",cells:[{member:"ActivityStart",type:"time"},{member:"ActivityEnd",type:"time"}]},{sheet:"Settings",member:"settings",cells:[{member:"Setting",type:"text"},{member:"Value",type:"number"}]}]);wa(this,a)?Xa(this,[]):(this.records=a.to("Standard").records.filter(function(e){return"awake"==e.status||"asleep"==e.status}).map(function(e){return{status:e.status,start:e.start,end:e.end}}),this.activities=this.records.map(function(e){return{ActivityStart:e.start,
ActivityEnd:e.end}}),this.settings=[{Setting:"maximum_day_length_ms",Value:6E4}])}L(Wa,Q);
function Xa(a,b){var e=a.records=[],k=[{}],n=1152E5,d=NaN,f=NaN,c=1;a.settings.forEach(function(r){"maximum_day_length_ms"==r.Setting&&(n=r.Value)});a.activities.concat(b).sort(function(r,z){return r.ActivityStart-z.ActivityStart}).forEach(function(r){f>=r.ActivityStart-6E4?k[k.length-1].ActivityEnd=r.ActivityEnd:k.push({ActivityStart:r.ActivityStart,ActivityEnd:f=r.ActivityEnd})});for(a.activities=k.slice(1);c<k.length;){a=k[c];b=a.ActivityStart;for(var p=a.ActivityEnd,h=0,m=++c;m<k.length;){var q=
k[m],l=q.ActivityStart-a.ActivityEnd;h<l&&(h=l,p=a.ActivityEnd,c=m);if(q.ActivityEnd-b>n)break;a=q;++m}36E5<p-b&&(b-d<n&&e.push({start:f+1,end:b-1,status:"asleep"}),e.push({start:b,end:m==k.length?k[m-1].ActivityEnd:p,status:"awake"}),d=b,f=p);if(m==k.length)break}}
Wa.prototype.to=function(a){switch(a){case "output":return R(this,{file_format:function(){return"string"},contents:Oa(this.spreadsheet)});case "Standard":return new Z({records:this.records},this.g);default:return Q.prototype.to.call(this,a)}};Wa.prototype.merge=function(a){a=a.to(this.file_format());Xa(this,a.activities);return this};Wa.prototype.file_format=function(){return"ActivityLog"};
Wa.prototype.format_info=function(){return{name:"ActivityLog",title:"Activity Log",url:"/src/ActivityLog",statuses:["awake","asleep"],extension:".csv"}};ua(Wa);function Ya(a,b){function e(m){return{type:"text",member:"status",regexp:new RegExp(f.map(function(q){return"("+q[1]+")"}).join("|"),"i"),"export":function(q,l,r){return l[r]=Y(q[m])},"import":function(q,l,r){return f.some(function(z){return-1!=l[r].value.toString().search(new RegExp(z[1],"i"))&&(q[m]=z[0])})}}}function k(m){return{"export":function(q,l,r){q[m].forEach(function(z){return l[r++]=Y(z)});return!0},"import":function(q,l,r){for(q=q[m]=c.map(function(){return(l[r++]||{}).value});q.length&&
!q[q.length-1];)q.pop();return!0}}}b&&(this.g=b);var n=[],d={},f=Da();b={members:[],"export":function(){return!0},"import":function(m){return m.status="asleep"}};var c=[];if("url"==a.file_format()&&"SpreadsheetTable"==a.contents.file_format)d=a.contents.contents.member_map,Object.keys(d).forEach(function(m){var q=d[m];switch(m){case "start":case "end":n[q[1]]={member:q[0],type:"time",optional:!0};break;case "status":n[q[1]]=Object.assign({members:[q[0]]},e(q[0]));break;case "comments":c=q[2];1==c.length?
n[q[1]]={member:q[0],type:"text"}:n.push(Object.assign({members:c},k(q[0])));break;default:return T()}}),d.status||n.push(b);else if("Standard"==a.file_format())d={start:["start",0],end:["end",1],status:["status",2],comments:["comments",3]},n=[{member:"start",type:"time",optional:!0},{member:"end",type:"time",optional:!0},e("status"),{members:["comments"],"export":function(m,q,l){return q[l]=Y((m.comments||[]).join("; "))},"import":function(m,q,l){q[l].value&&(m.comments=q[l].value.split(/ *; */));
return!0}}];else if(a.sheets&&a.sheets[0]&&a.sheets[0].cells[0]){if(a.sheets[0].cells[0].map(function(m,q){return[m,q]}).filter(function(m){var q=m[0].value;"string"!=typeof q&&(q="");if(![["end",/w.ke|stop|end/i],["start",/sleep|start|begin/i]].some(function(l){if(-1==q.search(l[1]))return!1;d.hasOwnProperty(l[0])||(d[l[0]]=[q,m[1]],n[m[1]]={member:q,type:"time",optional:!0});return!0}))if(-1!=q.search(/event|activity|stat(e|us)/i))d.hasOwnProperty("status")||(d.status=[q,m[1]],n[m[1]]=Object.assign({members:[q]},
e(q)));else{if(q&&-1==q.search(/comment|note/i))return!0;c.push(m)}return!1}).filter(function(m){var q=m[0].value;if(d.hasOwnProperty("start"))if(d.hasOwnProperty("end"))if(/date|time/i.test(q))n[m[1]]={member:q,optional:!0,ea:!0};else return!0;else d.end=[q,m[1]],n[m[1]]={member:q,type:"time",optional:!0};else d.start=[q,m[1]],n[m[1]]={member:q,type:"time",optional:!0};return!1}).length||!d.hasOwnProperty("start")||!d.hasOwnProperty("end"))return T();for(var p=0;p!=n.length;++p)if(!n[p])return T();
if(c.length)if(d.comments=[c[0][0].value,c[0][1],c.map(function(m){return m[0].value})],1==c.length)n[c[0][1]]={member:c[0][0].value,type:"text"};else{if(c[0][1]!=n.length)return T();for(p=1;p<c.length;++p)if(c[p][1]!=c[p-1][1]+1)return T();n.push(Object.assign({members:c.map(function(m){return m[0].value})},k(c[0][0].value)))}d.hasOwnProperty("status")||n.push(b)}else return T();this.member_map=d;this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:n}],!0);if(!wa(this,a)){var h=this.member_map;
a=a.to("Standard").records;h.hasOwnProperty("status")||(a=a.filter(function(m){return"asleep"==m.status}));h.hasOwnProperty("comments")&&(a=a.map(function(m){m.comments&&(m=Object.assign({},m),m.comments=m.comments.map(function(q){return"string"==typeof q?q:q.text}),1==c.length&&(m.comments=m.comments[0]));return m}));this.records=a.map(function(m){var q={};Object.keys(h).forEach(function(l){return q[h[l][0]]=m[l]});return q})}}L(Ya,Q);
Ya.prototype.to=function(a){switch(a){case "output":var b=[],e=[];Object.values(this.member_map).forEach(function(n){e[n[1]]=n[0];n[2]?b=b.concat(n[2]):b[n[1]]=n[0]});return R(this,{file_format:function(){return"string"},contents:b.filter(function(n){return void 0!==n}).join()+"\n"+this.records.map(function(n){var d=[];e.forEach(function(f){f=n[f];Array.isArray(f)?d=d.concat(f.map(Na)):d.push(Na(f))});return d.join()+"\n"}).join("")});case "Standard":var k=this.member_map;return new Z({records:this.records.map(function(n){return{status:n[(k.status||
["status"])[0]],start:n[(k.start||["start"])[0]],end:n[(k.end||["end"])[0]],comments:n[(k.comments||["comments"])[0]]||[]}})},this.g);default:return Q.prototype.to.call(this,a)}};
Ya.prototype.merge=function(a){function b(n){return["status","start","end"].map(function(d){return n[(e[d]||[d])[0]]}).join()}a=a.to("Standard");var e=this.member_map,k={};this.records.forEach(function(n){return k[b(n)]=1});this.records=this.records.concat(a.records.map(function(n){var d={};Object.keys(e).forEach(function(f){n.hasOwnProperty(f)&&(d[e[f][0]]=n[f])});return d}).filter(function(n){return!k.hasOwnProperty(b(n))}));return this};Ya.prototype.file_format=function(){return"SpreadsheetTable"};
Ya.prototype.format_info=function(){return{name:"SpreadsheetTable",title:"Spreadsheet Table",url:"/src/SpreadsheetTable",extension:".xlsx",icon:"mdi-file-excel"}};ua(Ya);function Za(a,b){b&&(this.g=b);var e=Da(),k={};this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"start",type:"time"},{member:"end",type:"time"},{member:"status",type:"text"},{members:["comments"],"export":function(v,y,A){return y[A]=Y(v.comments.join("; "))},"import":function(v,y,A){return v.comments=y[A].value.split(/\s*;\s*/)}}]}]);if(a.sheets&&a.sheets[0]&&a.sheets[0].cells){var n=a.sheets[0].cells,d=0,f=0,c=n[0].map(function(v){return Ka(v,a.spreadsheet)});b=n.map(function(v){return Ka(v[0],
a.spreadsheet)});var p=Infinity,h=0,m=Infinity,q=0;n.forEach(function(v,y){return v.forEach(function(A,u){A.style&&(p=Math.min(p,u),h=Math.max(h,u),m=Math.min(m,y),q=Math.max(q,y))})});var l=[c,b].map(function(v){for(var y="number"!=typeof v[0]||isNaN(v[0])?[[1]]:[[0,v[0]]],A=1;A<v.length;++A)432E5<=v[A-1]&&432E5>v[A]&&(v[A]+=432E5),"number"!=typeof v[A]||isNaN(v[A])?y.push([A+1]):y[y.length-1].push(v[A]);v=y.sort(function(g,t){return t.length-g.length})[0];y=v.slice(1);var u;if(4<y.length)y.some(function(g){return 0>
g||864E5<=g})?u=1:23<y.length&&(u=2);else{var C=(new Date).getTime();y.length&&y.every(function(g){return 864E5<=g&&g<=C})&&(u=1)}return{lines:1,start:v[0],j:y,type:u}});switch(l[0].type){case 0:l[1].type&&(d=l[1]);break;case 1:switch(l[1].type){case 2:d=l[1];case 0:f=l[0];break;default:l[0].j.length>l[1].j.length?f=l[0]:d=l[1]}break;case 2:switch(l[1].type){case 1:d=l[1];case 0:f=l[0];break;default:l[0].j.length%24<l[1].j.length%24?f=l[0]:d=l[1]}}if(!f)if((l=d?1:0)?1==d.type:24<=c.length){var r=
[];c=c.length-l;c-=c%24;for(var z=0;z!=c;++z)r.push(864E5*z/c);f={lines:0,start:l,j:r,type:2}}else{r=[];c=(new Date).getTime();c-=c%864E5;for(z=Math.max(l+1,p);z<=h;++z)r.push(c-864E5*(h-z));f={lines:0,start:l,j:r,type:2}}if(!d)if(l=f.lines,1==f.type){r=[];b=b.length-l;b-=b%24;for(c=0;c!=b;++c)r.push(864E5*c/b);d={lines:0,start:l,j:r,type:2}}else{b=[];r=(new Date).getTime();r-=r%864E5;for(c=l=Math.max(l,m);c<=q;++c)b.push(r-864E5*(q-c));d={lines:0,start:l,j:b,type:2}}if(!f.j.length||!d.j.length)return T();
var J=[];d.j.forEach(function(v,y){var A=n[d.start+y];f.j.forEach(function(u,C){C=A[f.start+C]||{style:""};J.push({start:v+u,style:C.style||"",comments:C.value?[C.value]:[]})})});if(!J.length)return T();J=J.sort(function(v,y){return v.start-y.start});var D=[{style:NaN}];J.forEach(function(v){v.style==D[D.length-1].style?D[D.length-1].comments=D[D.length-1].comments.concat(v.comments):(D[D.length-1].end=v.start-1,D.push(v))});D.shift();var N={};D.forEach(function(v){var y=N[v.style]=N[v.style]||{u:[],
duration:0};y.u.push(v);v.end&&v.start&&(y.duration+=v.end-v.start)});var S=[],U=[];n.forEach(function(v,y){v.forEach(function(A,u){if(y<d.start-f.lines||y>=d.start+d.j.length||u<f.start-d.lines||u>=f.start+f.j.length)A.value&&U.push([y,u,A.value]),A.style&&S.push([y,u,A.style])})});var F=[];S.forEach(function(v){return F=F.concat(U.map(function(y){return[Math.abs(y[0]-v[0])+Math.abs(y[1]-v[1]),v[2],y[2]]}))});var E={};e.forEach(function(v){return E[v[0]]=new RegExp(v[1],"i")});var H={};F.sort(function(v,
y){return v[0]-y[0]}).forEach(function(v){if(N[v[1]]&&!H[v[2]]){H[v[2]]=1;var y=Object.keys(E).find(function(A){return-1!=v[2].search(E[A])});y?delete E[y]:y=v[2];k[y]=v[1];N[v[1]].u.forEach(function(A){delete A.style;A.status=y});delete N[v[1]]}});var M=0;Object.values(N).sort(function(v,y){return y.duration-v.duration}).forEach(function(v){var y=e.find(function(A){return E[A[0]]});y?(y=y[0],delete E[y]):y="Unknown status #"+ ++M;v.u.forEach(function(A){k[y]=A.style;A.status=y;delete A.style})})}else{if(wa(this,
a))return;D=a.to("Standard").records.map(function(v){var y={comments:[]};["start","end","status","comments"].forEach(function(A){return v.hasOwnProperty(A)&&(y[A]=v[A])});k[v.status]=e.find(function(A){return A[0]==v.status})[2];return y})}this.records=D;this.status_map=k}L(Za,Q);
Za.prototype.to=function(a){switch(a){case "output":throw Error("Please use to_async() to generate output for SpreadsheetGraph");case "Standard":return new Z({records:this.records},this.g);default:return Q.prototype.to.call(this,a)}};
Za.prototype.to_async=function(a){var b=this;switch(a){case "output":var e=this.records,k=this.status_map,n=[60,30,15,5].map(function(l){return 6E4*l}).find(function(l){return!e.filter(function(r){return r.start%l}).length})||3E5,d=Infinity,f=0;e.forEach(function(l){d=Math.min(d,l.start);f=Math.max(f,l.end||l.start+1)});Infinity==d&&(d=f);d-=d%864E5;f-=f%864E5;var c=[[Y()]];a=["YYYY-MM-DD"];for(var p=[11],h=[{font:{size:10}}],m=0;864E5!=m;m+=n)c[0].push(Y(m/864E5,"#FFEEEEEE,#FFEEEEEE")),a.push("H:MM"),
p.push(5),h.push({font:{size:10}});for(m=d;m<=f;m+=864E5)c.push([Y(new Date(m),"#FFEEEEEE,#FFEEEEEE")]);e.forEach(function(l){var r=l.start,z=l.end||r+1,J=k[l.status];l=(l.comments||[]).slice(0);for(var D=Math.ceil(l.length/Math.max((z-r)/n)),N=r;N<Math.max(z,r+1);N+=n){var S=N%864E5;c[(N-S-d)/864E5+1][Math.floor(S/n)+1]=Y(l.splice(0,D).join("; "),J)}});var q={};e.forEach(function(l){var r=l.status;k[r]&&((q[r]=q[r]||[0,k[r],r])[0]+=l.end-l.start)});Object.values(q).sort(function(l,r){return r[0]-
l[0]}).forEach(function(l,r){r=c[r+1]=c[r+1]||[];r[c[0].length+2]=Y(void 0,l[1]);r[c[0].length+3]=Y(l[2])});this.spreadsheet.sheets[0]={name:"Sleep Graph",number_formats:a,cells:c,widths:p,styles:h,options:{properties:{defaultRowHeight:12.5},pageSetup:{paperSize:9,orientation:"landscape"}}};return this.spreadsheet.serialise().then(function(l){return R(b,{file_format:function(){return"array"},contents:l})});default:return Q.prototype.to_async.call(this,a)}};
Za.prototype.merge=function(a){function b(d){return["status","start","end"].map(function(f){return d[f]}).join()}a=a.to(this.file_format());var e={};this.records.forEach(function(d){return e[b(d)]=1});this.records=this.records.concat(a.records.filter(function(d){return!e.hasOwnProperty(b(d))}));var k=a.status_map,n=this.status_map;Object.keys(k).forEach(function(d){n.hasOwnProperty(d)||(n[d]=k[d])});return this};Za.prototype.file_format=function(){return"SpreadsheetGraph"};
Za.prototype.format_info=function(){return{name:"SpreadsheetGraph",title:"Spreadsheet Graph",url:"/src/SpreadsheetGraph",extension:".xlsx",icon:"mdi-file-excel-outline"}};ua(Za);}).call(this);
//# sourceMappingURL=sleepdiary-core.min.js.map
