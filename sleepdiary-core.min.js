(function(){/*
 Copyright 2020-2022 Sleepdiary Developers <sleepdiary@pileofstuff.org>

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use, copy,
 modify, merge, publish, distribute, sublicense, and/or sell copies
 of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
 BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
 ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.
*/
function aa(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}function ca(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):{next:aa(a)}}var da="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b},ea="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};
function fa(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");}var ha=fa(this);function H(a,b){if(b)a:{var c=ha;a=a.split(".");for(var k=0;k<a.length-1;k++){var h=a[k];if(!(h in c))break a;c=c[h]}a=a[a.length-1];k=c[a];b=b(k);b!=k&&null!=b&&ea(c,a,{configurable:!0,writable:!0,value:b})}}var ia;
if("function"==typeof Object.setPrototypeOf)ia=Object.setPrototypeOf;else{var ja;a:{var ka={a:!0},la={};try{la.__proto__=ka;ja=la.a;break a}catch(a){}ja=!1}ia=ja?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var ma=ia;
function L(a,b){a.prototype=da(b.prototype);a.prototype.constructor=a;if(ma)ma(a,b);else for(var c in b)if("prototype"!=c)if(Object.defineProperties){var k=Object.getOwnPropertyDescriptor(b,c);k&&Object.defineProperty(a,c,k)}else a[c]=b[c];a.ia=b.prototype}
H("Symbol",function(a){function b(e){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new c(k+(e||"")+"_"+h++,e)}function c(e,f){this.g=e;ea(this,"description",{configurable:!0,writable:!0,value:f})}if(a)return a;c.prototype.toString=function(){return this.g};var k="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",h=0;return b});
H("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),c=0;c<b.length;c++){var k=ha[b[c]];"function"===typeof k&&"function"!=typeof k.prototype[a]&&ea(k.prototype,a,{configurable:!0,writable:!0,value:function(){return na(aa(this))}})}return a});function na(a){a={next:a};a[Symbol.iterator]=function(){return this};return a}
function oa(a,b){a instanceof String&&(a+="");var c=0,k=!1,h={next:function(){if(!k&&c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}k=!0;return{done:!0,value:void 0}}};h[Symbol.iterator]=function(){return h};return h}H("Array.prototype.keys",function(a){return a?a:function(){return oa(this,function(b){return b})}});H("Math.log10",function(a){return a?a:function(b){return Math.log(b)/Math.LN10}});
var pa="function"==typeof Object.assign?Object.assign:function(a,b){for(var c=1;c<arguments.length;c++){var k=arguments[c];if(k)for(var h in k)Object.prototype.hasOwnProperty.call(k,h)&&(a[h]=k[h])}return a};H("Object.assign",function(a){return a||pa});
H("Array.from",function(a){return a?a:function(b,c,k){c=null!=c?c:function(d){return d};var h=[],e="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];if("function"==typeof e){b=e.call(b);for(var f=0;!(e=b.next()).done;)h.push(c.call(k,e.value,f++))}else for(e=b.length,f=0;f<e;f++)h.push(c.call(k,b[f],f));return h}});
H("Promise",function(a){function b(f){this.h=0;this.l=void 0;this.g=[];this.K=!1;var d=this.A();try{f(d.resolve,d.reject)}catch(p){d.reject(p)}}function c(){this.g=null}function k(f){return f instanceof b?f:new b(function(d){d(f)})}if(a)return a;c.prototype.h=function(f){if(null==this.g){this.g=[];var d=this;this.l(function(){d.B()})}this.g.push(f)};var h=ha.setTimeout;c.prototype.l=function(f){h(f,0)};c.prototype.B=function(){for(;this.g&&this.g.length;){var f=this.g;this.g=[];for(var d=0;d<f.length;++d){var p=
f[d];f[d]=null;try{p()}catch(m){this.A(m)}}}this.g=null};c.prototype.A=function(f){this.l(function(){throw f;})};b.prototype.A=function(){function f(m){return function(n){p||(p=!0,m.call(d,n))}}var d=this,p=!1;return{resolve:f(this.N),reject:f(this.B)}};b.prototype.N=function(f){if(f===this)this.B(new TypeError("A Promise cannot resolve to itself"));else if(f instanceof b)this.P(f);else{a:switch(typeof f){case "object":var d=null!=f;break a;case "function":d=!0;break a;default:d=!1}d?this.M(f):this.J(f)}};
b.prototype.M=function(f){var d=void 0;try{d=f.then}catch(p){this.B(p);return}"function"==typeof d?this.R(d,f):this.J(f)};b.prototype.B=function(f){this.L(2,f)};b.prototype.J=function(f){this.L(1,f)};b.prototype.L=function(f,d){if(0!=this.h)throw Error("Cannot settle("+f+", "+d+"): Promise already settled in state"+this.h);this.h=f;this.l=d;2===this.h&&this.O();this.T()};b.prototype.O=function(){var f=this;h(function(){if(f.U()){var d=ha.console;"undefined"!==typeof d&&d.error(f.l)}},1)};b.prototype.U=
function(){if(this.K)return!1;var f=ha.CustomEvent,d=ha.Event,p=ha.dispatchEvent;if("undefined"===typeof p)return!0;"function"===typeof f?f=new f("unhandledrejection",{cancelable:!0}):"function"===typeof d?f=new d("unhandledrejection",{cancelable:!0}):(f=ha.document.createEvent("CustomEvent"),f.initCustomEvent("unhandledrejection",!1,!0,f));f.promise=this;f.reason=this.l;return p(f)};b.prototype.T=function(){if(null!=this.g){for(var f=0;f<this.g.length;++f)e.h(this.g[f]);this.g=null}};var e=new c;
b.prototype.P=function(f){var d=this.A();f.C(d.resolve,d.reject)};b.prototype.R=function(f,d){var p=this.A();try{f.call(d,p.resolve,p.reject)}catch(m){p.reject(m)}};b.prototype.then=function(f,d){function p(l,r){return"function"==typeof l?function(x){try{m(l(x))}catch(G){n(G)}}:r}var m,n,q=new b(function(l,r){m=l;n=r});this.C(p(f,m),p(d,n));return q};b.prototype.catch=function(f){return this.then(void 0,f)};b.prototype.C=function(f,d){function p(){switch(m.h){case 1:f(m.l);break;case 2:d(m.l);break;
default:throw Error("Unexpected state: "+m.h);}}var m=this;null==this.g?e.h(p):this.g.push(p);this.K=!0};b.resolve=k;b.reject=function(f){return new b(function(d,p){p(f)})};b.race=function(f){return new b(function(d,p){for(var m=ca(f),n=m.next();!n.done;n=m.next())k(n.value).C(d,p)})};b.all=function(f){var d=ca(f),p=d.next();return p.done?k([]):new b(function(m,n){function q(x){return function(G){l[x]=G;r--;0==r&&m(l)}}var l=[],r=0;do l.push(void 0),r++,k(p.value).C(q(l.length-1),n),p=d.next();while(!p.done)})};
return b});H("Array.prototype.find",function(a){return a?a:function(b,c){a:{var k=this;k instanceof String&&(k=String(k));for(var h=k.length,e=0;e<h;e++){var f=k[e];if(b.call(c,f,e,k)){b=f;break a}}b=void 0}return b}});H("Object.values",function(a){return a?a:function(b){var c=[],k;for(k in b)Object.prototype.hasOwnProperty.call(b,k)&&c.push(b[k]);return c}});
H("Array.prototype.fill",function(a){return a?a:function(b,c,k){var h=this.length||0;0>c&&(c=Math.max(0,h+c));if(null==k||k>h)k=h;k=Number(k);0>k&&(k=Math.max(0,h+k));for(c=Number(c||0);c<k;c++)this[c]=b;return this}});function M(a){return a?a:Array.prototype.fill}H("Int8Array.prototype.fill",M);H("Uint8Array.prototype.fill",M);H("Uint8ClampedArray.prototype.fill",M);H("Int16Array.prototype.fill",M);H("Uint16Array.prototype.fill",M);H("Int32Array.prototype.fill",M);
H("Uint32Array.prototype.fill",M);H("Float32Array.prototype.fill",M);H("Float64Array.prototype.fill",M);var qa={},ra=[],sa,ta=(new Intl.DateTimeFormat).resolvedOptions().timeZone;sa="UTC"==ta?"Etc/GMT":ta;function O(a,b){b&&(this.g=b)}O.file_format=function(){return"DiaryBase"};O.prototype.merge=function(){return this};O.prototype.clone=function(){return ua({file_format:"storage-line",contents:{file_format:this.file_format(),contents:JSON.parse(JSON.stringify(this,function(a,b){return"spreadsheet"==a?void 0:b}))}},this.g)};
O.prototype.to=function(a){switch(a){case this.file_format():return this;case "url":return"sleepdiary="+encodeURIComponent(JSON.stringify({file_format:this.file_format(),contents:this},function(b,c){return"spreadsheet"==b?void 0:c}));case "json":return JSON.stringify(this,function(b,c){return"spreadsheet"==b?void 0:c});case "storage-line":return"storage-line:"+this.file_format()+":"+JSON.stringify(this,function(b,c){return"spreadsheet"==b?void 0:c});default:if(qa.hasOwnProperty(a))return new qa[a](this.to("Standard"),
this.g);throw Error(this.file_format()+" cannot be converted to "+a);}};O.prototype.to_async=function(a){switch(a){case "spreadsheet":if(!this.spreadsheet.synchronise())throw Error("Could not synchronise data");return this.spreadsheet.serialise();default:var b=this.to(a);return b.then?b:{then:function(c){return c(b)}}}};function Q(a,b){return a.g?a.g(b):b}
function R(a){var b=a.prototype.format_info();b.constructor=a;ra.push(b);"/"==b.url[0]&&(b.url="https://sleepdiary.github.io/core"+b.url);"Standard"!=b.name&&(qa[b.name]=b.constructor)}function U(){throw null;}function va(a){throw Error("Does not appear to be a valid "+a.file_format()+" file");}
function wa(a,b){switch(b.file_format()){case "url":return b=b.contents,a.file_format()==b.file_format?(Object.keys(b.contents).forEach(function(c){return a[c]=b.contents[c]}),!0):U();case "string":case "spreadsheet":if(a.spreadsheet.load(b))return!0;case "archive":case "array":U()}return!1}function V(a,b){var c="";if(a)for(b=Math.pow(10,(b||2)-1);b>a;b/=10)c+="0";else for(var k=1;k<(b||2);++k)c+="0";return c+a}
function xa(a){try{var b=self.DOMParser;if(!b)throw"";}catch(c){b=require("@xmldom/xmldom").DOMParser}return(new b).parseFromString(a,"application/xml")}
function ya(a,b){if(null===a||void 0===a)return NaN;if(a.getTime)return a=a.getTime(),864E5>=a&&(a+=b||0),a;if(a.match){if(b=a.match(/^((?:19|20)[0-9]{2})[-.]?([0-9]{2})[-.]?([0-9]{2})[T ]?([0-9]{2})[.:]?([0-9]{2})(?:[.:]?([0-9]{2}))?Z?$/))return(new Date(b[1]+"-"+b[2]+"-"+b[3]+"T"+(b[4]||"00")+":"+(b[5]||"00")+":"+(b[6]||"00")+"."+(b[7]||0)+"Z")).getTime();a.search(/^[0-9]{4,}$/)||(a=parseInt(a,10))}if("number"==typeof a)return b=12-Math.floor(Math.log10(a)),a*Math.pow(10,a&&2<Math.abs(b)?b:0);if(!a||
!a.search)return NaN;b=(-1==a.search(/[a-su-y]/i)&&-1!=a.search(/-.*-/)?a:a.replace(/\s*(-|to).*/,"")).replace(/([ap])\s*(m)/i,"$1$2").toLowerCase();if(-1!=b.search(/midnight/i))return 0;if(-1!=b.search(/midd?ay|noon|12pm/i))return 432E5;var c=b.match(/^([0-9]*)(:([0-9]*))?\s*([ap])m$/);return c?36E5*(parseInt(c[1],10)+parseInt(c[3]||"0",10)/60+("p"==c[4]?12:0)):(c=b.match(/^([0-9]*)(:([0-9]*))?(:([0-9]*))?$/))?36E5*(parseInt(c[1],10)+parseInt(c[3]||"0",10)/60+parseInt(c[5]||"0",10)/3600):Date.parse(b)||
Date.parse(a)}function za(a,b,c){if("function"!=typeof c){var k=c;c=function(e){return k.map(function(f){return e[f]}).join("\ue000")}}var h={};a.forEach(function(e){return h[c(e)]=1});return b.filter(function(e){return!h.hasOwnProperty(c(e))})}function Aa(){try{var a=self.tc;if(!a)throw"";}catch(b){a=require("timezonecomplete")}return a}function W(a,b){var c=Aa();a=new c.DateTime(a||0,c.zone("Etc/UTC"));return b?a.toZone(c.zone(b)):a}
function Ba(a,b){for(var c=Aa().TzDatabase.instance(),k=a-1728E5;k<a;k+=36E5)try{var h=c.nextDstChange(b,k);if(!h)return Infinity;if(h>a)return h}catch(e){return Infinity}return c.nextDstChange(b,a)||Infinity}
function Da(){return[["awake","w.ke",""],["asleep","sle*p(?!.*aid)","#FFFFFF00,#FF0000FF,#FFFFFFFF"],["lights off","light.*(?:out|off)","#FFFFFFFF,#FF000080,#FFFFFFFF"],["lights on","light.*on","#FFFFFFFF,#FFE6E6FF"],["snack","snack","#FFFF7FFF,#FF7FFF7F"],["meal","meal|eat","#FFFF00FF,#FF00FF00"],["alcohol","alco","#FF1FAFEF,#FFE05010,#FFFFFFFF"],["chocolate","choc","#FF84C0FF,#FF7B3F00,#FFFFFFFF"],["caffeine","caffeine|coffee|tea|cola","#FF0B3B8B,#FFF4C474"],["drink","drink","#FFDF8F5F,#FF2070a0,#FFFFFFFF"],
["sleep aid","sle*p.*aid|pill|tranq","#FFAFFF7F,#FF500080,#FFFFFFFF"],["exercise","exercise","#FF00C0C0,#FFFF3F3F"],["toilet","toilet|bathroom|loo","#FF363636,#FFC9C9C9"],["noise","noise","#FF8F8F8F,#FF707070,#FFFFFFFF"],["alarm","alarm","#FF000000,#FFFF0000"],["in bed","down|(in|to).*bed","#FFA0A000,#FF5f5fff"],["out of bed","up|out.*bed","#FF0000FF,#FFFFFFCC"]]}O.prototype.timezones=function(){return Object.keys(self.tzdata.zones).sort()};O.prototype.software_version=function(){return"88cbff6"};
function ua(a,b){var c=Error("This does not appear to be a sleep diary"),k=a.file_format;if("string"==typeof a)k="string",a={file_format:function(){return"string"},contents:a};else if(k)"string"==typeof k?a.file_format=function(){return k}:k=k(),"url"==k?a.contents=JSON.parse(decodeURIComponent(a.contents.replace(/^sleep-?diary=/,""))):"storage-line"==k&&(k="url");else throw c;"string"==k&&Object.assign(a,Ea(a.contents));for(var h=0;h!=ra.length;++h)try{return new ra[h].constructor(a,b)}catch(e){e&&
(c=e)}throw c;};function Fa(a,b,c){function k(f){return function(){(history.state||{})["sleepdiary-core-processed"]||location.hash.replace(/(?:^#|[?&])(sleep-?diary=[^&]*)/g,function(d,p){history.replaceState(Object.assign({"sleepdiary-core-processed":c},history.state||{}),"");e.load({file_format:"url",contents:p},f)})}}this.success_callback=a||function(){};this.error_callback=b||function(){};var h,e=this;2!=c&&(h=setInterval(function(){self.tc&&(clearInterval(h),self.addEventListener("hashchange",k("hashchange"),
!1),k("hash")())},100));Ga()}function Ha(){return[[self.JSZip,"https://cdn.jsdelivr.net/npm/jszip@3.6.x/dist/jszip.min.js"],[self.tc,"https://cdn.jsdelivr.net/npm/tzdata@1.0.x/tzdata.js","https://cdn.jsdelivr.net/npm/timezonecomplete@5.12.x/dist/timezonecomplete.min.js"],[self.ExcelJS,"https://cdn.jsdelivr.net/npm/exceljs@4.2.x/dist/exceljs.min.js"]]}
function Ga(){try{var a=[];Ha().forEach(function(b){b[0]||(a=a.concat(b.slice(1)))});self.importScripts?self.importScripts.apply(self,a):a.forEach(function(b){var c=document.createElement("script");c.src=b;document.head.appendChild(c)})}catch(b){}}
Fa.prototype.load=function(a,b){var c=this;if(Ha().some(function(f){return!f[0]}))return setTimeout(function(){return c.load(a,b)},100);var k=self.JSZip;if(!k)return setTimeout(function(){return c.load(a,b)},100);if("string"==typeof a&&!a.search(/^(blob|data):/)){var h=new XMLHttpRequest;h.responseType="blob";h.onload=function(){return c.load([h.response],b)};h.open("GET",a);return h.send()}b||(b=a);a.target&&a.target.files&&(a=a.target.files);a.replace&&a.replace(/^storage-line:([^:]+):(.*)/,function(f,
d,p){a={file_format:"storage-line",contents:{file_format:d,contents:JSON.parse(p)}}});if("string"!=typeof a&&a.length)Array.from(a).forEach(function(f){var d=new FileReader,p=new k;d.onload=function(){return Ia(d.result).then(function(m){return c.load(m,b)},function(){return p.loadAsync(d.result).then(function(m){function n(){l.length?m.file(l[0]).async("string").then(function(r){q[l[0]]=r;l.shift();n()}):c.load({file_format:"archive",contents:q},b)}var q={},l=Object.keys(m.files);n()},function(){var m=
c.error_callback;try{c.error_callback=function(){},c.load({file_format:"array",contents:d.result},b),c.error_callback=m}catch(n){c.error_callback=m,d.onload=function(){return c.load({file_format:"string",contents:d.result},b)},d.readAsText(f)}})})};d.readAsArrayBuffer(f)});else{try{var e=self.new_sleep_diary(a,Fa.serialiser)}catch(f){throw this.error_callback(a,b),f;}e?this.success_callback(e,b):this.error_callback(a,b)}};
Fa.serialiser=function(a){switch(a.file_format()){case "array":return a.contents;case "string":return btoa(unescape(encodeURIComponent(a.contents)));case "archive":var b=function(c,k){var h=self.JSZip;if(!h)return setTimeout(function(){return b(c,k)},100);var e=new h;Object.keys(a.contents).forEach(function(f){return e.file(f,a.contents[f])});return e.generateAsync({type:"base64",compression:"DEFLATE"}).then(c,k)};Ga();return new Promise(b);default:throw Error("Unsupported output format: "+a.file_format());
}};Fa.to_url=function(a){if("string"==typeof a)return"data:application/octet-stream;base64,"+a;a.file_format&&a.contents&&("archive"==a.file_format()?a=JSON.stringify(a):a=a.contents);return URL.createObjectURL(new Blob([a]))};var Ja={number:"General",time:'YYYY-MM-DD" "HH:MM',duration:"[h]:mm"};
function X(a,b,c){function k(f){var d=f.member;switch(f.type){case "time":var p=function(n,q,l){return q[l]=Y(void 0===n[d]?void 0:new Date(n[d]))};break;case "duration":p=function(n,q,l){return q[l]=Y(void 0===n[d]?void 0:n[d]/864E5)};break;default:p=function(n,q,l){return q[l]=Y(n[d])}}if(f.optional){var m=p;p=function(n,q,l){return void 0===n[d]||m(n,q,l)}}return p}function h(f,d){var p=f.member;switch(f.type){case "time":var m=c?function(l,r,x){return!isNaN(l[p]=r[x].I)}:function(l,r,x){return!isNaN(l[p]=
r[x].S)};break;case "duration":m=function(l,r,x){return!isNaN(l[p]=r[x].value.getTime()+d.epoch_offset)};break;case "number":m=function(l,r,x){return!isNaN(l[p]=parseFloat(r[x].value))};break;case "boolean":m=function(l,r,x){return!isNaN(l[p]=!!r[x].value)};break;default:m=function(l,r,x){l[p]=r[x].value;return!0}}if(f.regexp){var n=m;m=function(l,r,x){return f.regexp.test(r[x].value)&&n(l,r,x)}}if(f.optional){var q=m;m=function(l,r,x){return!r[x]||null==r[x].value||q(l,r,x)||""==r[x].value}}return m}
var e=this;this.g=null;this.h=a;this.l=b.map(function(f){return{sheet:f.sheet||f.member,member:f.member||f.sheet,type:f.type||"list",optional:!!f.optional,cells:f.cells.map(function(d){if(d.members){for(d.formats=(d.formats||[]).map(function(p){return Ja[p]||p});d.formats.length<d.members.length;)d.formats.push("General");return d}return{members:[d.member],regexp:d.regexp||RegExp(""),formats:[Ja[d.type]||"General"],"export":k(d),"import":h(d,e)}})}});this.epoch_offset=0;this.sheets=[]}
function Y(a,b){return{value:a,style:b||""}}X.prototype.get_sheet=function(a,b,c){var k=b.join("\x00"),h=this.sheets.filter(function(e){return e.cells[0]&&e.cells[0].map(function(f){return f.value}).join("\x00")==k});return h.length?[!1,h.find(function(e){return e.name==a})||h[0]]:[!0,{name:a,number_formats:c.map(function(e){return e?Ja[e]||e:"General"}),cells:[b.map(function(e){return Y(e,"#FFEEEEEE,#FFEEEEEE")})]}]};
function Ka(a,b){return ya((a||{}).hasOwnProperty("value")?a.value:a,b?(b.properties||{}).date1904?20828448E5:22091616E5:0)}function La(a,b){var c=0;a.forEach(function(k){return k.forEach(function(h){var e=h.S=Ka(h,b);e=h.I=isNaN(e)||0>e||864E5<e?e:e+c-c%864E5;e<c&&(h.I=e+=864E5);c=e})})}
function Ia(a){function b(k){return k.hasOwnProperty("argb")?"#"+k.argb:k.hasOwnProperty("indexed")?"i"+k.indexed:k.hasOwnProperty("theme")?"t"+k.theme:""}try{var c=new self.ExcelJS.Workbook}catch(k){c=new (require("exceljs").Workbook)}return c.xlsx.load(a).then(function(){if(c._worksheets.length){var k=[];c.eachSheet(function(h){var e={name:h.name,cells:[]};k.push(e);h.eachRow({includeEmpty:!0},function(f,d){var p=e.cells[d-1]=[];f.eachCell({includeEmpty:!0},function(m,n){var q="";m.style&&m.style.fill&&
(q=b(m.style.fill.bgColor||{})+","+b(m.style.fill.fgColor||{}));1==q.length&&(q="");if((m.value||{}).getTime){var l=m.value.getTime();if(1==l%1E3||-999==l%1E3)m.value=new Date(l-1);if(-1==l%1E3||999==l%1E3)m.value=new Date(l+1)}p[n-1]=Y(m.value,q)})})});k.forEach(function(h){return La(h.cells,c)});return{file_format:"spreadsheet",spreadsheet:c,sheets:k}}throw Error("empty spreadsheet");})}
function Ea(a){var b=RegExp('^(?:[^",\\r\\n]*|"(?:[^"]|"")*")(?:,(?:[^",\\r\\n]*|"(?:[^"]|"")*"))*(?:\r\n|\r|\n)');"\ufeff"==a[0]&&(a=a.substr(1));a=a.replace(/[\r\n]*$/,"\n");for(var c=0;c!=a.length;){var k=a.substr(c).match(b);if(!k)return;c+=k[0].length}try{var h=new self.ExcelJS.Workbook}catch(n){h=new (require("exceljs").Workbook)}for(var e=h.addWorksheet("Records"),f=h.addWorksheet("Settings"),d=[],p=0,m=[[Y("Setting"),Y("Value")]];!a.search(/^([A-Za-z_][A-Za-z0-9_]*)=[^,]*\n/);)a=a.replace(/([^=]*?)=(.*)\n/,
function(n,q,l){m.push([q,l].map(function(r){return Y(r)}));f.addRow([q,l]);return""});a.replace(RegExp('(?:[^",\\r\\n]*|"(?:[^"]|"")*")(?:,(?:[^",\\r\\n]*|"(?:[^"]|"")*"))*(?:\r\n|\r|\n)',"g"),function(n){var q=e.getRow(++p),l=[],r=0;d.push(l);n.replace(RegExp('(?:[^",\\r\\n]*|"(?:[^"]|"")*")[,\r\n]',"g"),function(x){var G=q.getCell(++r);G.value='"'==x[0]?x.substr(1,x.length-3).replace(/""/g,'"'):x.substr(0,x.length-1);l.push(Y(G.value))})});La(d);return{spreadsheet:h,sheets:[{name:"Records",cells:d},
{name:"Settings",cells:m}]}}function Ma(a){return void 0===a?"":a.getTime?W(a.getTime()).format("yyyy-MM-ddTHH:mm:ss.SSS")+"Z":-1==a.toString().search(/[",\n]/)?a:'"'+a.replace(/"/g,'""')+'"'}
X.prototype.load=function(a){var b=this,c=a.sheets;if(!c)return!1;var k=this.epoch_offset;this.epoch_offset=(a.spreadsheet.properties||{}).date1904?20828448E5:22091616E5;if(!this.l.every(function(h){return c.some(function(e){var f=e.cells,d="dictionary"==h.type;if(!f.length||d&&2!=f.length)return!1;var p=f[0].slice(0);if(!h.cells.every(function(r){return r.members.every(function(x){return x==(p.shift()||{value:NaN}).value})}))return!1;var m=[];if(!f.slice(1).every(function(r){if(!r.length)return!0;
var x=0,G={};m.push(G);return h.cells.every(function(C){return C["import"](G,r,(x+=C.members.length)-C.members.length)})}))return!1;var n=h.member;if(d)b.h[n]=Object.assign(m[0],b.h[n]||{});else{b.h[n]||(b.h[n]=[]);var q=b.h[n];q.length>=f.length&&q.splice(0,f.length-1);m.forEach(function(r,x){return q[x]=Object.assign(r,q[x])})}var l=[];h.cells.forEach(function(r){return l=l.concat(r.formats)});e.number_formats=l;return!0})}))return this.epoch_offset=k,!1;this.g=a.spreadsheet;this.sheets=c;return!0};
X.prototype.synchronise=function(){var a=this;return this.l.every(function(b){function c(n){var q=[],l=0;p.push(q);return b.cells.every(function(r){return r["export"](n,q,(l+=r.members.length)-r.members.length)})}var k="dictionary"==b.type,h=[],e=[];b.cells.forEach(function(n){h=h.concat(n.members);e=e.concat(n.formats)});var f=a.get_sheet(b.sheet,h,e),d=f[0];f=f[1];var p=f.cells=[h.map(function(n){return Y(n,"#FFEEEEEE,#FFEEEEEE")})],m=a.h[b.member||b.sheet];if(k){if(!c(m))return!1}else if(!m.every(c))return!1;
d&&a.sheets.push(f);return!0})};
X.prototype.serialise=function(){function a(e){switch(e[0]){case "#":return{argb:e.slice(1)};case "i":return{indexed:parseInt(e.slice(1),10)};case "t":return{theme:parseInt(e.slice(1),10)};default:return{}}}var b=this,c=!this.g;if(!this.g){try{this.g=new self.ExcelJS.Workbook}catch(e){this.g=new (require("exceljs").Workbook)}this.epoch_offset=(this.g.properties||{}).date1904?20828448E5:22091616E5}var k=this.epoch_offset,h={};this.sheets.forEach(function(e){return h[e.name]=0});this.g.eachSheet(function(e,
f){h.hasOwnProperty(e.name)?h[e.name]=e:b.g.ga(f)});this.sheets.forEach(function(e){var f=h[e.name]||b.g.addWorksheet(e.name,e.options);f.eachRow({includeEmpty:!0},function(d,p){var m=e.cells[p-1]||[];d.eachCell({includeEmpty:!0},function(n,q){m[q]||(n.value=null,n.style={})})});e.cells.forEach(function(d,p){var m=f.getRow(p+1);d.forEach(function(n,q){var l=m.getCell(q+1);l.value=c&&(n.value||{}).getTime&&0<=n.value.getTime()&&864E5>n.value.getTime()?new Date(n.value.getTime()-k):n.value;n=n.style.split(",");
l=l.style=l.style||{};q=((e.styles||[])[q]||{}).font;n[0]||n[1]||n[2]?(l.fill=l.fill||{},l.fill.type="pattern",l.fill.pattern="solid",n[0]?l.fill.bgColor=a(n[0]):delete l.fill.bgColor,n[1]?l.fill.fgColor=a(n[1]):delete l.fill.fgColor,n[2]?(l.font=l.font||{},l.font.color=a(n[2])):delete l.font):l&&l.fill&&(delete l.fill.bgColor,delete l.fill.fgColor);q&&Object.assign(l.font=l.font||{},q)});m.commit()});e.widths?e.widths.forEach(function(d,p){return f.columns[p].width=d}):f.columns.forEach(function(d){return d.width=
18});e.styles&&e.styles.forEach(function(d,p){return f.columns[p].style=d});(e.number_formats||[]).forEach(function(d,p){return f.getColumn(p+1).numFmt=d})});return this.g.xlsx.writeBuffer()};
function Oa(a){var b=a.l[0];return(a.h.settings||[]).map(function(c){return c.Setting+"="+c.Value+"\n"}).concat([b.cells.map(function(c){return c.members.join(",")}).join(",")+"\n"],a.h[b.member].map(function(c){var k=[],h=0;b.cells.forEach(function(e){return e["export"](c,k,(h+=e.members.length)-e.members.length)});return k.map(function(e){return Ma(e.value)}).join(",")+"\n"})).join("")}X.prototype.file_format=function(){return"Spreadsheet"};var Pa={new_sleep_diary:ua,sleepdiary_engines:ra,DiaryLoader:Fa,Spreadsheet:X};"undefined"!==typeof module&&module.exports?module.exports=Pa:Object.keys(Pa).forEach(function(a){return self[a]=Pa[a]});var Qa={Y:"awake",ca:"in bed",X:"asleep","lights off":"lights off","lights on":"lights on",ha:"snack",ea:"meal",W:"alcohol",$:"chocolate",Z:"caffeine",aa:"drink","sleep aid":"sleep aid",ba:"exercise",ja:"toilet",fa:"noise",V:"alarm","in bed":"in bed","out of bed":"out of bed"};
function Z(a,b){b&&(this.g=b);a.records&&!a.file_format&&(a={file_format:function(){return"Standard"},contents:a});this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"status",regexp:new RegExp("^("+Object.values(Qa).join("|")+")$"),type:"string"},{member:"start",type:"time",optional:!0},{member:"end",type:"time",optional:!0},{member:"start_timezone",type:"string",optional:!0},{member:"end_timezone",type:"string",optional:!0},{member:"duration",type:"duration",optional:!0},
{members:["tags"],"export":function(m,n,q){return n[q]=Y((m.tags||[]).join("; "))},"import":function(m,n,q){n[q].value&&(m.tags=n[q].value.split(/ *; */));return!0}},{members:["comments"],"export":function(m,n,q){return n[q]=Y((m.comments||[]).map(function(l){return l.time?"TIME="+l.time+" "+l.text:l}).join("; "))},"import":function(m,n,q){n[q].value&&(n=n[q].value.split(/ *; */).map(function(l){var r;l=l.replace(/^TIME=([0-9]*) */,function(x,G){r=parseInt(G,10);return""});return r?{time:r,text:l}:
l}),m.comments=n);return!0}},{member:"day_number",type:"number",optional:!0},{member:"start_of_new_day",type:"boolean",optional:!0},{member:"is_primary_sleep",type:"boolean",optional:!0},{member:"missing_record_after",type:"boolean",optional:!0}]},{sheet:"Settings",member:"settings",type:"dictionary",cells:[{member:"minimum_day_duration",type:"duration"},{member:"maximum_day_duration",type:"duration"}]}]);switch(a.file_format()){case "string":try{a={file_format:function(){return"Standard"},contents:JSON.parse(a.contents)}}catch(m){return U()}if("Standard"!=
a.contents.file_format)return U();default:if(!wa(this,a)){b=a.contents;if("Standard"!=a.file_format()||null===b||"object"!=typeof b||!Array.isArray(b.records))return U();this.records=b.records.map(function(m){return Object.assign({},m)}).sort(function(m,n){return m.start-n.start||m.end-n.end});a=b.settings||b;var c=a.minimum_day_duration||576E5,k=a.maximum_day_duration||2*c;this.settings={minimum_day_duration:c,maximum_day_duration:k};var h=0,e=0,f={status:"",day_number:-1},d=[],p=f;this.records.forEach(function(m){["start",
"end"].forEach(function(q){void 0==m[q]&&delete m[q]});["tags","comments"].forEach(function(q){(m[q]||[]).length||delete m[q]});m.hasOwnProperty("duration")||(m.duration=m.end-m.start,isNaN(m.duration)&&delete m.duration);m.hasOwnProperty("start_of_new_day")?m.start_of_new_day&&(h=m.start):m.start_of_new_day="asleep"==m.status&&m.start>h+c;m.hasOwnProperty("day_number")?e=m.day_number:(m.start_of_new_day&&(e=m.start>h+k?e+2:e+1,h=m.start),m.day_number=e);if("awake"==m.status||"asleep"==m.status)p.hasOwnProperty("missing_record_after")||
(p.missing_record_after=m.status==p.status),p=m;"asleep"==m.status&&(d[m.day_number]||{duration:-Infinity}).duration<m.duration&&(d[m.day_number]=m);if(m.hasOwnProperty("comments")){var n=m.comments;void 0===n?delete m.comments:Array.isArray(n)||(m.comments=[n])}f=m});d.forEach(function(m){m&&!m.hasOwnProperty("is_primary_sleep")&&(m.is_primary_sleep=!0)})}}}L(Z,O);
Z.prototype.to=function(a){switch(a){case "output":return a=Object.assign({file_format:this.file_format()},this),delete a.spreadsheet,Q(this,{file_format:function(){return"string"},contents:JSON.stringify(a)});default:return O.prototype.to.call(this,a)}};
Z.prototype.merge=function(a){var b={};[this,a.to(this.file_format())].forEach(function(c){return c.records.forEach(function(k){return b[[k.start,k.end,k.status].join()]=k})});this.records=Object.values(b).sort(function(c,k){return c.start-k.start||c.end-k.end});return this};Z.prototype.file_format=function(){return"Standard"};Z.prototype.format_info=function(){return{name:"Standard",title:"Standardised diary format",url:"/src/Standard",extension:".json",timezone:"yes"}};
function Ra(a,b){function c(q,l){return q+Math.pow(l-n,2)}function k(q,l){return q+l}var h=a.map(function(q){return q[0]}).filter(function(q){return void 0!==q}),e=h.length;if(!e)return null;var f=h.sort(function(q,l){return q-l}),d=f.slice(Math.round(.25*f.length),Math.round(.75*f.length)),p=h.reduce(k)/(e||1),m=d.reduce(k)/(d.length||1);f={average:p,mean:p,interquartile_mean:m,median:f[Math.floor(f.length/2)],interquartile_range:d[d.length-1]-d[0],durations:a.map(function(q){return q?q[0]:void 0}),
timestamps:a.map(function(q){return q?q[1]:void 0}),interquartile_durations:d,rolling_average:a.map(b?function(q,l){if(!(14>l)){q=a.slice(Math.max(0,l-13),l+1).map(function(x){return x[0]}).filter(function(x){return void 0!==x});var r=[0,0];q.forEach(function(x){x<1*b/4?++r[0]:x>3*b/4&&++r[1]});return q.length?(q.reduce(function(x,G){return x+G})+(r[0]<r[1]?r[0]*b:r[1]*-b))/q.length:void 0}}:function(q,l){q=a.slice(Math.max(0,l-13),l+1).map(function(r){return r[0]}).filter(function(r){return void 0!==
r});return 14<=l&&q.length?q.reduce(function(r,x){return r+x})/q.length:void 0})};var n=p;f.standard_deviation=Math.sqrt(h.reduce(c,0)/e);n=m;f.interquartile_standard_deviation=Math.sqrt(d.reduce(c,0)/d.length);return f}Z.prototype.summarise_records=function(a){return Ra((a?this.records.filter(a):this.records).map(function(b){return[b.duration,b.start||b.end]}))};
Z.prototype.summarise_days=function(a){var b=[];for((a?this.records.filter(a):this.records).forEach(function(k){var h=k.day_number;k.start_of_new_day&&h&&(b[h]=k.start)});b.length&&!b[0];)b.shift();a=[];for(var c=1;c<b.length;++c)b[c]&&b[c-1]&&(a[c-1]=[b[c]-b[c-1],b[c-1]]);return Ra(a)};
Z.prototype.total_per_day=function(a,b){var c=[],k=this.records.length?this.records[this.records.length-1].day_number:0;(b?this.records.filter(b):this.records).forEach(function(h){return(c[h.day_number]=c[h.day_number]||[0,h.start])[0]+=a&&!a(h)?0:1});for(c=c.slice(1,k);c.length&&void 0===c[0];)c.shift();return Ra(c)};
Z.prototype.summarise_schedule=function(a,b,c){b=b||864E5;c=c||sa;var k=b/2,h=[],e=[],f=[],d=[];(a?this.records.filter(a):this.records).forEach(function(q){if(q.is_primary_sleep){if(q.start){var l=q.start;l+=6E4*W(l,q.start_timezone||c).offset();h.push([l%b,l]);e.push([(l+k)%b,l])}q.end&&(l=q.end,l+=6E4*W(l,q.end_timezone||c).offset(),f.push([l%b,l]),d.push([(l+k)%b,l]))}});a=Ra(h,b);var p=Ra(e,b),m=Ra(f,b),n=Ra(d,b);[[p,a],[n,m]].forEach(function(q){q[0]&&(["average","mean","interquartile_mean",
"median"].forEach(function(l){return q[0][l]=(q[0][l]+k)%b}),["durations","interquartile_durations"].forEach(function(l){return q[0][l]=q[1][l]}),q[0].rolling_average=q[1].rolling_average)});return{wake:(m||{}).standard_deviation<(n||{}).standard_deviation?m:n,sleep:(a||{}).standard_deviation<(p||{}).standard_deviation?a:p}};
Z.prototype.daily_activities=function(a,b,c,k){function h(F,E){E.time=((E.start||E.end)+(E.end||E.start))/2;E.record=F;E.index=r++;F=q[q.length-1];var I=F.start,N=F.duration;["start","end","time"].forEach(function(v){E[v]&&(E["offset_"+v]=(E[v]-I)/N)});return E}function e(F){for(var E=p;C.unixUtcMillis()<=F;)if(E=p,l=0,++n,d=C,C=C.add(c,x),C.unixUtcMillis()>=p){p=Ba(d.unixUtcMillis(),a);var I=C.add(6E4*(d.offset()-C.offset()),x);if(d.lessThan(I)){var N=C.unixUtcMillis()>F;C=I;if(N)break}}if(!l&&(N=
d.unixUtcMillis(),F=C.unixUtcMillis(),I=q[n]={start:N,end:F,duration:F-N,id:d.toString(),year:d.year(),month:d.month()-1,day:d.day()-1,activities:l=[]},0<k))for(I=I.segments=[];N<F;){var v=new Date(N+T);I.push({dst_state:S?"on":"off",id:v.toISOString().replace(/Z/,m),year:v.getUTCFullYear(),month:v.getUTCMonth(),day:v.getUTCDate()-1,hour:v.getUTCHours(),minute:v.getUTCMinutes(),second:v.getUTCSeconds()});N+=k;N>=E&&(E=W(N,d.zone().name()),I[I.length-1].dst_state="change-"+(S?"back":"forward"),K=E.offsetDuration(),
T=K.milliseconds(),S=!K.equals(d.standardOffsetDuration()),E=Ba(E.unixUtcMillis(),a))}}a=a||sa;b=void 0===b?648E5:b;c=c||864E5;var f=this.records.sort(function(F,E){return(F.start||F.end)-(E.start||E.end)}),d=f.find(function(F){return F.start||F.end}),p=Ba(d?(d.start||d.end)-1:0,a),m=a.replace(/^([A-Za-z])/," $1"),n=0,q=[],l,r,x=Aa().TimeUnit.Millisecond;if(d){d=W(d.start||d.end,a);var G=d.unixUtcMillis()-d.startOfDay().unixUtcMillis();d=d.sub((G<b?864E5:0)+G-b,x);var C=d.add(c,x);b=C.add(6E4*(d.offset()-
C.offset()),x);b.greaterThan(d)&&(C=b);var K=d.offsetDuration();var T=K.milliseconds();var S=!K.equals(d.standardOffsetDuration());f.forEach(function(F){r=0;var E=F.start,I=F.end;if(E)if(e(E),I)if(C.unixUtcMillis()>=I)l.push(h(F,{start:E,end:I,type:"start-end"}));else{for(l.push(h(F,{start:E,end:C.unixUtcMillis(),type:"start-mid"}));;){e(C.unixUtcMillis()+1);if(C.unixUtcMillis()>=I)break;l.push(h(F,{start:d.unixUtcMillis(),end:C.unixUtcMillis(),type:"mid-mid"}))}l.push(h(F,{start:d.unixUtcMillis(),
end:I,type:"mid-end"}))}else l.push(h(F,{start:E,type:"start-unknown"}));else I&&(e(I),l.push(h(F,{end:I,type:"unknown-end"})))})}q.forEach(function(F){var E=F.activity_summaries={};F.activities.forEach(function(I){var N=I.record.status,v=E[N]=E[N]||{duration:0};["start","end"].forEach(function(z){var B=I[z];void 0!==B&&(B=W(B,a).toString(),v["last_"+z]=B,void 0==v["first_"+z]&&(v["first_"+z]=B))});v.duration=I.start&&I.end?v.duration+(I.end-I.start):NaN})});return q};
Z.prototype.latest_sleep_status=function(){for(var a=this.records.length-1;0<=a;--a){var b=this.records[a].status;if("awake"==b||"asleep"==b)return b}return""};Z.prototype.latest_daytime_midpoint=function(){for(var a,b=NaN,c=this.records.length-1;0<=c;--c){var k=this.records[c];if(k.is_primary_sleep){if(k.end&&k.day_number==b)return(k.end+a)/2;k.start&&(a=k.start,b=k.day_number-1)}}};
Z.prototype.update_timezone=function(a){a=a||sa;this.records.forEach(function(b){return["start","end"].forEach(function(c){b[c]&&(b[c+"_timezone"]=a)})})};Z.prototype.reset_to_timezone=function(a){var b=this;a=a||sa;["start","end"].forEach(function(c){var k=0,h;b.records.filter(function(e){return e[c]}).sort(function(e,f){return e[c]-f[c]}).forEach(function(e){e[c]>=k&&(h=W(e[c],a).offsetDuration().milliseconds(),k=Ba(e[c]+1,a));e[c]-=h;e[c+"_timezone"]=a})})};R(Z);function Sa(a,b){function c(g){return g.substr(1,g.length-2)}function k(g){return(new Date(g.substr(1,g.length-2))).getTime()}function h(g){var t=g.match(z);return{string:g,year:parseInt(t[1],10),month:parseInt(t[2],10),day:parseInt(t[3],10),hour:parseInt(t[4],10),minute:parseInt(t[5],10),offset:("-"==t[6]?-1:1)*(60*parseInt(t[7],10)+parseInt(t[8],10))}}function e(g,t){g=W(g,t);t=g.offset();return{string:'"'+g.year()+"-"+V(g.month())+"-"+V(g.day())+" "+V(g.hour())+":"+V(g.minute())+(0>t?"-":"+")+
V(Math.abs(Math.round(t/60)))+V(Math.abs(t%60))+'"',year:g.year(),month:g.month(),day:g.day(),hour:g.hour(),minute:g.minute(),offset:t}}function f(g,t){var y=Math.floor(t/60),w=Math.floor(t%60);g=new Date((g.getTime?g.getTime():g)+6E4*(60*y+w));return{string:'"'+g.getUTCFullYear()+"-"+V(g.getUTCMonth()+1)+"-"+V(g.getUTCDate())+" "+V(g.getUTCHours())+":"+V(g.getUTCMinutes())+("-"==t[0]?"":"+")+V(Math.floor(t/60),2)+V(Math.floor(t%60),2)+'"',year:g.getUTCFullYear(),month:g.getUTCMonth()+1,day:g.getUTCDate(),
hour:g.getUTCHours(),minute:g.getUTCMinutes(),offset:t}}function d(g){var t=[];if(""!=g){g=g.split("|");for(var y=0;y!=g.length;++y){var w=g[y].split("-");t.push({wake:parseInt(w[0],10),sleep:parseInt(w[1],10)})}}return t}function p(g){var t=[];if(g.length&&"NONE"!=g){g=g.split("|");for(var y=0;y!=g.length;++y){var w=g[y].split(":");t.push({type:w[0],mood:parseInt(w[1],10),themes:w.slice(2)})}}return t}function m(g){return g.length&&"NONE"!=g?g.split("|"):[]}function n(g){g=g.match(E);return{custom_aid_id:g[1],
"class":g[2],name:c(g[3])}}function q(g){g=g.match(I);return{custom_hindrance_id:g[1],"class":g[2],name:c(g[3])}}function l(g){g=g.match(N);return{custom_tag_id:g[1],name:c(g[2])}}function r(g){g=g.match(v);var t=d(g[28]);return{start:k(g[19]),end:k(g[1]),duration:t.reduce(function(y,w){return y+w.sleep-w.wake},k(g[1])-k(g[10])),wake:h(g[1]),sleep:h(g[10]),bedtime:h(g[19]),holes:t,type:g[34],dreams:p(g[35]),aids:m(g[47]),hindrances:m(g[51]),tags:m(g[55]),quality:parseInt(g[59],10),notes:c(g[60])}}
function x(g){var t=!0,y={F:[],G:[],H:[],u:[]};g=g.split("\n");for(var w=0;w!=g.length;++w){var P=g[w];if(t){switch(P){case "custom_aid_id,class,name":var A=y.F;var J=E;break;case "custom_hindrance_id,class,name":A=y.G;J=I;break;case "custom_tag_id,name":A=y.H;J=N;break;case "wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes":A=y.u;J=v;break;default:if(A)A[A.length-1]+="\n",--w;else return va(this)}t=!1}else if(""==g[w])t=!0;else{for(;'"'!=P.substr(P.length-1);){if(++w==g.length)return va(this);
P+="\n"+g[w]}if(J.test(P))A.push(P);else if(A.length)A[A.length-1]+="\n"+P;else return va(this)}}return y}b&&(this.g=b);var G="ALCOHOL AMBIEN AMBIEN_CR AROMATHERAPY BENADRYL CHAMOMILE CIRCADIN CPAP DOZILE EAR_PLUGS EXERCISE GABA IMOVANE LUNESTA MAGNESIUM MARIJUANA MEDITATION MELATONIN MILK MUSIC NYQUIL READING RESTAVIT ROZEREM SEX SOUND_MACHINE ST_JOHNS_WORT TV TYLENOL TYLENOL_PM UNISOM UNISOM2 VALERIAN ZIMOVANE".split(" "),C="ALARM_CLOCK ANGER ANXIETY ARGUMENT BABY_CRYING BATHROOM_BREAK TOO_BRIGHT BUNKMATE_SNORING CAFFEINE TOO_COLD DOG_BARKING FIRE_ANTS HEARTBURN TOO_HOT HUNGER LOUD_NEIGHBOR MIND_RACING PAIN PHONE_RANG RESTLESS_LEGS SCARY_MOVIE SICK SQUIRRELS_ON_ROOF STORM STRESS SUGAR VIDEO_GAME WIND".split(" "),
K="ALONE BUNKMATE CAMPING COUCH GOING_FISHING HOTEL OUT_OF_TOWN PASSED_OUT_DRUNK SCHOOL_NIGHT SLEEP_TALKING SLEEP_WALKING SLEPT_AT_FRIENDS_PLACE SLEPT_IN_CAR WORK_NIGHT".split(" ");b=G.join("|")+"|CUSTOM_[0-9]*";var T=C.join("|")+"|CUSTOM_[0-9]*",S=K.join("|")+"|CUSTOM_[0-9]*",F={};[G,C,K].forEach(function(g,t){return g.forEach(function(y){return F[y]=t})});G=RegExp("^CUSTOM_[0-9]*$");var E=RegExp('^(CUSTOM_[0-9]*),(AIRWAY|BEVERAGE|DRUG|EXERTION|HERBAL|READING|RELAXATION|SENSORY_DEPRIVATION|SOUND),("(.|\n)*")$'),
I=RegExp('^(CUSTOM_[0-9]*),(ENVIRONMENTAL|MENTAL|NOISE|OBLIGATION|PHYSICAL|STIMULANT),("(.|\n)*")$'),N=RegExp('^(CUSTOM_[0-9]*),("(.|\n)*")$'),v=new RegExp('^("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),("([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"),(|([1-9][0-9]*)-([1-9][0-9]*)(\\|([1-9][0-9]*)-([1-9][0-9]*))*),(NIGHT_SLEEP|NAP),(NONE|((UNKNOWN|GOOD|EROTIC|NEUTRAL|STRANGE|CREEPY|TROUBLING|NIGHTMARE):(-[1-5]|[0-5])(:(CHASE|COMPENSATORY|DAILY_LIFE|DEATH|EPIC|FALLING|FALSE_AWAKENING|FLYING|LUCID|MURDER|MUTUAL|NAKED_IN_PUBLIC|ORGASMIC|PHYSIOLOGICAL|PRECOGNITIVE|PROGRESSIVE|RECURRING|RELIGIOUS|SIGNAL|TEETH|TEST|MONEY))*)(\\|((UNKNOWN|GOOD|EROTIC|NEUTRAL|STRANGE|CREEPY|TROUBLING|NIGHTMARE):(-[1-5]|[0-5])(:(CHASE|COMPENSATORY|DAILY_LIFE|DEATH|EPIC|FALLING|FALSE_AWAKENING|FLYING|LUCID|MURDER|MUTUAL|NAKED_IN_PUBLIC|ORGASMIC|PHYSIOLOGICAL|PRECOGNITIVE|PROGRESSIVE|RECURRING|RELIGIOUS|SIGNAL|TEETH|TEST|MONEY))*))*),(NONE|('+
(b+")(\\|("+b+"))*),(NONE|(")+(T+")(\\|("+T+"))*),(NONE|(")+(S+")(\\|("+S+'))*),([0-9]|10),("(.|\n)*")$')),z=RegExp('"([0-9][0-9]*)-([0-9][0-9]?)-([0-9][0-9]?) ([0-9][0-9]?):([0-9][0-9])?([-+])([0-9][0-9]*)([0-9][0-9])"');this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{members:["start","start_offset"],formats:["time",null],"export":function(g,t,y){t[y]=Y(new Date(g.start));t[y+1]=Y(g.bedtime.offset);return!0},"import":function(g,t,y){g.start=t[y].value.getTime();return g.bedtime=
f(t[y].value,t[y+1].value)}},{members:["end","end_offset"],formats:["time",null],"export":function(g,t,y){t[y]=Y(new Date(g.end));t[y+1]=Y(g.wake.offset);return!0},"import":function(g,t,y){g.end=t[y].value.getTime();return g.wake=f(t[y].value,t[y+1].value)}},{member:"duration",type:"duration"},{members:["sleep","sleep_offset"],formats:["time",null],"export":function(g,t,y){t[y]=Y(new Date(g.sleep.string.substr(1,g.sleep.string.length-2)));t[y+1]=Y(g.sleep.offset);return!0},"import":function(g,t,y){return g.sleep=
f(t[y].value,t[y+1].value)}},{members:["holes"],regexp:/^([0-9]*-[0-9]*(\|[0-9]*-[0-9]*)*)?$/,"export":function(g,t,y){t[y]=Y(g.holes.map(function(w){return w.wake+"-"+w.sleep}).join("|"));return!0},"import":function(g,t,y){g.holes=d(t[y].value);return!0}},{member:"type",regexp:/^(NIGHT_SLEEP|NAP)$/},{members:["dreams"],"export":function(g,t,y){t[y]=Y(g.dreams.map(function(w){return[w.type,w.mood].concat(w.themes).join(":")}).join("|"));return!0},"import":function(g,t,y){return g.dreams=p(t[y].value)}},
{members:["aids"],"export":function(g,t,y){t[y]=Y(g.aids.join("|"));return!0},"import":function(g,t,y){g.aids=m(t[y].value);return!0}},{members:["hindrances"],"export":function(g,t,y){t[y]=Y(g.hindrances.join("|"));return!0},"import":function(g,t,y){g.hindrances=m(t[y].value);return!0}},{members:["tags"],"export":function(g,t,y){t[y]=Y(g.tags.join("|"));return!0},"import":function(g,t,y){g.tags=m(t[y].value);return!0}},{member:"quality",regexp:/^[0-9]*$/},{member:"notes"}]},{sheet:"Custom Aids",member:"custom_aids",
cells:[{member:"custom_aid_id",regexp:G},{member:"class",regexp:RegExp("^(AIRWAY|BEVERAGE|DRUG|EXERTION|HERBAL|READING|RELAXATION|SENSORY_DEPRIVATION|SOUND)$")},{member:"name"}]},{sheet:"Custom Hindrances",member:"custom_hindrances",cells:[{member:"custom_hindrance_id",regexp:G},{member:"class",regexp:RegExp("^(ENVIRONMENTAL|MENTAL|NOISE|OBLIGATION|PHYSICAL|STIMULANT)$")},{member:"name"}]},{sheet:"Custom Tags",member:"custom_tags",cells:[{member:"custom_tag_id",regexp:G},{member:"name"}]}]);b=[];
T=[];var B=[],u=[];switch(a.file_format()){case "string":if(-1==a.contents.search("wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes"))return U();a=x(a.contents);b=a.F.map(n);T=a.G.map(q);B=a.H.map(l);u=a.u.map(r);break;default:if(wa(this,a))return;var D={};a.to("Standard").records.forEach(function(g){switch(g.status){case "in bed":D[g.end]=[g.start,g.start_timezone];break;case "asleep":var t=[[],[],[]],y=D[g.start]||[g.start,g.start_timezone];(g.tags||[]).forEach(function(w){if(F.hasOwnProperty(w))t[F[w]].push(w);
else{var P=B.find(function(A){return w==A.name});P?t[2].push(P.custom_tag_id):(P="CUSTOM_"+V(B.length+1,4),B.push({custom_tag_id:P,name:w}),t[2].push(P))}});u.push({start:y[0],end:g.end,duration:g.duration,wake:e(g.end,g.end_timezone),sleep:e(g.start,g.start_timezone),bedtime:e(y[0],y[1]),holes:[],type:g.is_primary_sleep?"NIGHT_SLEEP":"NAP",dreams:[],aids:t[0],hindrances:t[1],tags:t[2],quality:5,notes:(g.comments||[]).join("; ")})}})}this.custom_aids=b;this.custom_hindrances=T;this.custom_tags=B;
this.records=u}L(Sa,O);
Sa.prototype.to=function(a){switch(a){case "output":var b="";this.custom_aids.length&&(b+="custom_aid_id,class,name\n",this.custom_aids.forEach(function(d){return b+=d.custom_aid_id+","+d["class"]+',"'+d.name+'"\n'}),b+="\n");this.custom_hindrances.length&&(b+="custom_hindrance_id,class,name\n",this.custom_hindrances.forEach(function(d){return b+=d.custom_hindrance_id+","+d["class"]+',"'+d.name+'"\n'}),b+="\n");this.custom_tags.length&&(b+="custom_tag_id,name\n",this.custom_tags.forEach(function(d){return b+=d.custom_tag_id+
',"'+d.name+'"\n'}),b+="\n");b+="wake,sleep,bedtime,holes,type,dreams,aid,hindrances,tags,quality,notes\n";this.records.forEach(function(d){return b+=[d.wake.string,d.sleep.string,d.bedtime.string,d.holes.map(function(p){return p.wake+"-"+p.sleep}).join("|"),d.type,d.dreams.map(function(p){return[p.type,p.mood].concat(p.themes).join(":")}).join("|")||"NONE",d.aids.join("|")||"NONE",d.hindrances.join("|")||"NONE",d.tags.join("|")||"NONE",d.quality,'"'+d.notes+'"'].join()+"\n"});return Q(this,{file_format:function(){return"string"},
contents:b});case "Standard":var c=function(d){d=Math.round(d.offset/60);return 0>d?"Etc/GMT+"+Math.abs(d):0<d?"Etc/GMT-"+d:"Etc/GMT"},k={},h={},e={},f=[];this.custom_aids.forEach(function(d){return k[d.custom_aid_id]=d.name});this.custom_hindrances.forEach(function(d){return h[d.custom_hindrance_id]=d.name});this.custom_tags.forEach(function(d){return e[d.custom_tag_id]=d.name});this.records.forEach(function(d){var p=d.sleep;p=(new Date(p.string.substr(1,p.string.length-2))).getTime();d.start<p&&
f.push({status:"in bed",start:d.start,end:p,start_timezone:c(d.bedtime),end_timezone:c(d.sleep)});var m=[];d.aids.forEach(function(n){return m.push(k[n]||n)});d.hindrances.forEach(function(n){return m.push(h[n]||n)});d.tags.forEach(function(n){return m.push(e[n]||n)});f.push(Object.assign({status:"asleep",start:void 0===d.start?p||void 0:Math.max(d.start,p),end:d.end,start_timezone:c(d.sleep),end_timezone:c(d.wake),tags:m,comments:d.notes.length?[d.notes]:[]},void 0===d.duration?{}:{duration:d.duration},
"NIGHT_SLEEP"==d.type?{is_primary_sleep:!0}:{}))});return new Z({records:f},this.g);default:return O.prototype.to.call(this,a)}};
Sa.prototype.merge=function(a){var b=this,c={},k={},h={};a=a.to(this.file_format());this.custom_aids.length&&a.custom_aids.length?a.custom_aids.forEach(function(e){var f=b.custom_aids.find(function(p){return p["class"]==e["class"]&&p.name==e.name});if(!f){var d="CUSTOM_0001";for(f=2;b.custom_aids.some(function(p){return p.custom_aid_id==d});++f)d="CUSTOM_"+V(f,4);f={custom_aid_id:d,"class":e["class"],name:e.name};b.custom_aids.push(f)}c[e.custom_aid_id]=f.custom_aid_id}):a.custom_aids.forEach(function(e){return c[e.custom_aid_id]=
e.custom_aid_id});this.custom_hindrances.length&&a.custom_hindrances.length?a.custom_hindrances.forEach(function(e){var f=b.custom_hindrances.find(function(p){return p["class"]==e["class"]&&p.name==e.name});if(!f){var d="CUSTOM_0001";for(f=2;b.custom_hindrances.some(function(p){return p.custom_hindrance_id==d});++f)d="CUSTOM_"+V(f,4);f={custom_hindrance_id:d,"class":e["class"],name:e.name};b.custom_hindrances.push(f)}k[e.custom_hindrance_id]=f.custom_hindrance_id}):a.custom_hindrances.forEach(function(e){return k[e.custom_hindrance_id]=
e.custom_hindrance_id});this.custom_tags.length&&a.custom_tags.length?a.custom_tags.forEach(function(e){var f=b.custom_tags.find(function(p){return p.name==e.name});if(!f){var d="CUSTOM_0001";for(f=2;b.custom_tags.some(function(p){return p.custom_tag_id==d});++f)d="CUSTOM_"+V(f,4);f={custom_tag_id:d,name:e.name};b.custom_tags.push(f)}h[e.custom_tag_id]=f.custom_tag_id}):a.custom_tags.forEach(function(e){return h[e.custom_tag_id]=e.custom_tag_id});this.records=this.records.concat(za(this.records,a.records,
function(e){return[e.wake.string,e.sleep.string,e.bedtime.string].join()}).map(function(e){return Object.assign({},e,{aids:e.aids.map(function(f){return c[f]||f}),hindrances:e.hindrances.map(function(f){return k[f]||f}),tags:e.tags.map(function(f){return h[f]||f})})})).sort(function(e,f){return e.wake-f.wake});return this};Sa.prototype.file_format=function(){return"Sleepmeter"};
Sa.prototype.format_info=function(){return{name:"Sleepmeter",title:"Sleepmeter",url:"/src/Sleepmeter",statuses:["in bed","asleep"],extension:".csv",logo:"http://www.squalllinesoftware.com/sites/squalllinesoftware.com/files/sleepmeter_logo_128x128.png",timezone:"offset"}};R(Sa);function Ta(a,b){function c(u){return u.substr(1,u.length-2).replace(E,'"').replace(I,"\n")}function k(u){var D=[];u.replace(S,function(g,t){3<t.length&&("_2x"==t.substr(t.length-3)?D.push({count:2,value:t.substr(0,t.length-3)}):"_3x"==t.substr(t.length-3)?D.push({count:3,value:t.substr(0,t.length-3)}):D.push({count:1,value:t}))});return D}function h(u){var D=u.match(G);return{string:u,year:parseInt(D[3],10),month:parseInt(D[2],10),day:parseInt(D[1],10),hour:parseInt(D[4],10),minute:parseInt(D[5],
10)}}function e(u,D){u=W(u,D);return{string:'"'+V(u.day())+". "+V(u.month())+". "+u.year()+" "+u.hour()+":"+V(u.minute())+'"',year:u.year(),month:u.month(),day:u.day(),hour:u.hour(),minute:u.minute()}}function f(u,D){return D.some(function(g){return g==u})?null:p(u)}function d(u,D){return D.some(function(g){return g==u})?null:p(u)}function p(u){return parseFloat(u.substr(1,u.length-2))}function m(u,D){return D.some(function(g){return g==u})?null:c(u)}function n(u){var D={},g=xa(u).documentElement;
u=Array.from(g.getElementsByTagName("long"));var t=Array.from(g.getElementsByTagName("int")),y=Array.from(g.getElementsByTagName("boolean"));g=Array.from(g.getElementsByTagName("string"));u.forEach(function(w){return D[w.getAttribute("name")]=parseInt(w.getAttribute("value"),10)});t.forEach(function(w){return D[w.getAttribute("name")]=parseInt(w.getAttribute("value"),10)});y.forEach(function(w){return D[w.getAttribute("name")]="true"==w.getAttribute("value")});g.forEach(function(w){return D[w.getAttribute("name")]=
w.textContent});return D}function q(u){var D=[];u=u.split("\n");""==u[u.length-1]&&u.pop();for(var g={},t=0;t!=u.length;g={i:g.i,s:g.s,m:g.m,D:g.D,o:g.o,v:g.v},t+=2){var y=function(A){return function(J){return W(["year","month","day"].map(function(ba){return V(J[ba])}).join("-")+"T"+["hour","minute"].map(function(ba){return V(J[ba])}).join(":"),A.i.Tz).unixUtcMillis()}}(g),w=u[t].match(l);g.s=[];g.m=[];if(!w)return va(this);w[1].replace(C,function(A){return function(J,ba,Ca){A.s.push({header_string:J,
hours:parseInt(ba,10),minutes:parseInt(Ca,10),actigraphy:null,noise:null})}}(g));w[5].replace(/"Event"/g,function(A){return function(){A.m.push({label:null,timestamp:null})}}(g));w=u[t+1].match(r);if(!w)return va(this);g.D=0;g.o=0;var P=c(w[27]);g.i={Id:c(w[1]),Tz:c(w[3]),From:h(w[5]),To:h(w[11]),Sched:h(w[17]),Hours:p(w[23]),Rating:p(w[25]),Comment:{string:P,tags:k(P),notags:P.replace(F,"")},Framerate:c(w[29]),Snore:f(w[31],['"-1"']),Noise:d(w[32],['"-1.0"']),Cycles:f(w[34],['"-1"']),DeepSleep:d(w[35],
['"-1.0"','"-2.0"']),LenAdjust:d(w[37],['"-1.0"']),Geo:m(w[39],[""]),times:g.s,events:g.m};g.i.start=parseInt(g.i.Id,10);g.i.end=g.i.start+36E5*g.i.Hours;g.i.duration=Math.round(6E4*(60*g.i.Hours+("-1.0"==w[37]?0:g.i.LenAdjust)));g.i.alarm=6E4*Math.round((g.i.end+y(g.i.Sched)-y(g.i.To))/6E4);w[40].replace(K,function(A){return function(J){A.s[A.D++].actigraphy=p(J)}}(g));w[43].replace(T,function(A){return function(J,ba,Ca,ab,Na){A.m[A.o]&&(A.m[A.o].label=ba,A.m[A.o].timestamp=parseInt(Ca,10),Na&&(A.m[A.o].value=
parseFloat(Na)),++A.o)}}(g));y=u[t+2]?u[t+2].match(x):0;g.v=[];y&&(y[1].replace(K,function(A){return function(J){return A.v.push(p(J))}}(g)),g.s.length==g.v.length?g.s.forEach(function(A){return function(J,ba){return J.noise=A.v[ba]}}(g)):console.warn("Ignoring third line data with unexpected length:",y),++t);D.push(g.i)}return D}b&&(this.g=b);var l=RegExp('^Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)$'),r=RegExp('^("([^"]|"")*"),("([^"]|"")*"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(\\.[0-9]*)?"),("[0-9]*(\\.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(\\.[0-9]*)?"),("-?[0-9]*"),("(-[12]\\.0|0\\.[0-9]*|1\\.0)"),("-?[0-9]*(\\.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(\\.[0-9]*)?")*)((,"[-0-9E.]*|([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)$'),
x=RegExp('^,,,,,,,,,,,,((,"-?[0-9]*(\\.[0-9]*)?")*)$');b=RegExp('^(Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)\n("([^"]|"")*"),("([^"]|"")*"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(\\.[0-9]*)?"),("[0-9]*(\\.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(\\.[0-9]*)?"),("-?[0-9]*"),("(-[12]\\.0|0\\.[0-9]*|1\\.0)"),("-?[0-9]*(\\.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(\\.[0-9]*)?")*)((,"[-0-9E.]*|([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)\n(,,,,,,,,,,,,((,"-?[0-9]*(\\.[0-9]*)?")*)\n)?)*(Id,Tz,From,To,Sched,Hours,Rating,Comment,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo((,"([0-9]*):([0-9]*)")*)((,"Event")*)\n("([^"]|"")*"),("([^"]|"")*"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"),("[0-9]*(\\.[0-9]*)?"),("[0-9]*(\\.[0-9]*)?"),("([^"]|"")*"),("([^"]|"")*"),("-?[0-9]*"),("-?[0-9]*(\\.[0-9]*)?"),("-?[0-9]*"),("(-[12]\\.0|0\\.[0-9]*|1\\.0)"),("-?[0-9]*(\\.[0-9]*)?"),("[0-9a-f]*")((,"-?[0-9]*(\\.[0-9]*)?")*)((,"[-0-9E.]*|([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?")*)(\n,,,,,,,,,,,,((,"-?[0-9]*(\\.[0-9]*)?")*))?)\n?$');
var G=RegExp('"([0-9]*)\\. ([0-9]*). ([0-9]*) ([0-9]*):([0-9]*)"'),C=RegExp('"([0-9]*):([0-9]*)"',"g"),K=RegExp('"-?[0-9]*(\\.[0-9]*)?"',"g"),T=RegExp('"[-0-9E.]*|([A-Z_]*)-([0-9]*)(-([-0-9E.]*))?"',"g"),S=RegExp('#([^ ",][^ ",]*)',"g"),F=RegExp(' *#([^ ",][^ ",]*)',"g"),E=RegExp('""',"g"),I=RegExp(" \\\\n ","g"),N={},v=[];this.spreadsheet=new X(this,[]);var z=a.contents;switch(a.file_format()){case "spreadsheet":if(!a.sheets.some(function(u){u=u.cells;if(!u.length)return!1;B=[];var D=1,g,t,y;return u.every(function(w){if("Id,Tz,From,To,Sched,Hours,Rating,Comment,Tags,Framerate,Snore,Noise,Cycles,DeepSleep,LenAdjust,Geo"==
w.slice(0,16).map(function(A){return A.value}).join())t=[],y=[],g={times:t,events:y},B.push(g),D=2,w.slice(16).forEach(function(A){if("Event"==A.value)y.push({label:null,timestamp:null});else if("number"==typeof A.value){var J=Math.floor(24*A.value);A=Math.floor(1440*A.value)%60;t.push({header_string:J+":"+V(A),hours:J,minutes:A,actigraphy:null,noise:null})}else return!1});else if(2==D){D=3;["Id","Tz",,,,"Hours","Rating","Comment","Tags","Framerate","Snore","Noise","Cycles","DeepSleep","LenAdjust",
"Geo"].forEach(function(A,J){return g[A]=w[J]?w[J].value:null});g.Comment=g.Comment&&g.Tags?{string:g.Comment+" "+g.Tags,tags:k(g.Tags),notags:g.Comment}:g.Comment?{string:g.Comment,tags:[],notags:g.Comment}:g.Tags?{string:g.Tags,tags:k(g.Tags),notags:""}:{string:"",tags:[],notags:""};delete g.Tags;var P=w[1].value;g.start=w[2].value.getTime();g.From=e(w[2].value.getTime(),P);g.end=w[3].value.getTime();g.To=e(w[3].value.getTime(),P);g.alarm=w[4].value.getTime();g.Sched=e(w[4].value.getTime(),P);g.duration=
Math.round(6E4*(60*g.Hours+(g.LenAdjust||0)));t.forEach(function(A,J){w[16+J]&&(A.actigraphy=w[16+J].value)});y.forEach(function(A,J){w[16+t.length+J]&&(J=w[16+t.length+J].value.split("-"),A.label=J[0],A.timestamp=J[1],2<J.length&&(A.value=J[2]))})}else if(3==D)D=1,t.forEach(function(A,J){w[16+J]&&(A.noise=w[16+J].value)});else return!1;return!0})})||!a.sheets.some(function(u){u=u.cells;if(!u.length||"Alarm"!=u[0][0].value)return!1;v=u.slice(1).map(function(D){return JSON.parse(D[0].value)});return!0})||
!a.sheets.some(function(u){u=u.cells;if(!u.length||"Preferences"!=u[0][0].value)return!1;N=JSON.parse(u[1][0].value);return!0}))return U();break;case "string":if(!b.test(z))return U();var B=q.call(this,z);break;case "archive":if(z.hasOwnProperty("sleep-export.csv")&&z["prefs.xml"]&&z["alarms.json"]){B=q.call(this,z["sleep-export.csv"]);N=n(z["prefs.xml"]);v=JSON.parse(z["alarms.json"]);break}else return U();default:if(wa(this,a))return;B=a.to("Standard").records.filter(function(u){return"asleep"==
u.status}).map(function(u){return{start:u.start,end:u.end,duration:u.duration,alarm:6E4*Math.round(u.end/6E4),Id:(u.start||0).toString(),Tz:u.start_timezone||u.end_timezone||"Etc/GMT",From:e(u.start,u.start_timezone||u.end_timezone),To:e(u.end,u.end_timezone||u.start_timezone),Sched:e(u.end,u.end_timezone||u.start_timezone),Hours:(u.end-u.start)/36E5,Rating:2.5,Comment:{string:(u.comments||[]).join("\n")+(u.tags||[]).map(function(D){return"#"+D}).join(" "),tags:(u.tags||[]).map(function(D){return{count:1,
value:D}}),notags:(u.comments||[]).join("\n")},Framerate:"10000",Snore:null,Noise:null,Cycles:null,DeepSleep:null,LenAdjust:null,Geo:"",times:[],events:[]}})}this.records=B;this.prefs=N;this.alarms=v}L(Ta,O);
Ta.prototype.to=function(a){var b=this,c=["Id","Tz","From","To","Sched"],k=["Hours","Rating"],h="Framerate Snore Noise Cycles DeepSleep LenAdjust Geo".split(" ");switch(a){case "output":var e=function(p,m){return'"'+(null===p?m:p)+'"'};a=JSON.stringify(this.alarms);var f="<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n<map>"+Object.keys(this.prefs).map(function(p){var m=b.prefs[p];switch(typeof m){case "boolean":return'\n\t<boolean name="'+p+'" value="'+m+'" />\n';case "number":return"\n\t<"+
(Math.abs(m)>=Math.pow(2,31)?"long":"int")+' name="'+p+'" value="'+m+'" />\n';default:return'\n\t<string name="'+p+'"><![CDATA['+m+"]]\x3e</string>\n"}}).join("")+"\n</map>\n",d=this.records.map(function(p){return[].concat(c,k,["Comment"],h,p.times.map(function(m){return',"'+m.header_string+'"'}),p.events.map(function(){return',"Event"'})).join(",")+"\n"+['"'+p.Id+'"','"'+p.Tz+'"'].concat(["start","end","alarm"].map(function(m){m=W(p[m],p.Tz);return'"'+V(m.day())+". "+V(m.month())+". "+m.year()+" "+
m.hour()+":"+V(m.minute())+'"'}),k.map(function(m){return'"'+p[m]+'"'}),['"'+p.Comment.string.replace(/"/g,'""').replace(/\n/g," \\n ")+'"','"'+p.Framerate+'"',e(p.Snore,"-1"),e(p.Noise,"-1.0"),e(p.Cycles,"-1"),e(p.DeepSleep,"-1.0"),e(p.LenAdjust,"-1.0"),e(p.Geo,"")],p.times.map(function(m){return'"'+m.actigraphy+'"'}),p.events.map(function(m){return'"'+m.label+"-"+m.timestamp+(m.hasOwnProperty("value")?"-"+m.value:"")+'"'})).join(",")+"\n"+(p.times.length?",,,,,,,,,,,,,"+p.times.map(function(m){return'"'+
m.noise+'"'}).join(",")+"\n":"")}).join("");return Q(this,{file_format:function(){return"archive"},contents:{"sleep-export.csv":d,"prefs.xml":f,"alarms.json":a}});case "Standard":return new Z({records:this.records.map(function(p){return Object.assign({status:"asleep",start:p.start,end:p.end,start_timezone:p.Tz,end_timezone:p.Tz,tags:p.Comment.tags.map(function(m){return m.value}),comments:p.Comment.notags.length?[p.Comment.notags]:void 0},void 0===p.duration?{}:{duration:p.duration})})},this.g);default:return O.prototype.to.call(this,
a)}};
Ta.prototype.to_async=function(a){var b=["Id","Tz","From","To","Sched"],c=["Hours","Rating"],k="Framerate Snore Noise Cycles DeepSleep LenAdjust Geo".split(" ");switch(a){case "spreadsheet":a=this.spreadsheet;var h=this.records.length?Math.max.apply(0,this.records.map(function(m){return m.times.length})):0,e=a.get_sheet("Records",b.concat(c,["Comment","Tags"],k),[null,null,"time","time","time",null,null,null,null,null,null,null,null,null,null].concat(Array(h).fill("duration")));h=e[0];e=e[1];var f=
e.cells;f.splice(0);this.records.forEach(function(m){f.push([].concat(b,c,["Comment","Tags"],k,m.times.map(function(n){return(60*n.hours+n.minutes)/1440}),m.events.map(function(){return"Event"})).map(function(n){return Y(n,"#FFEEEEEE,#FFEEEEEE")}));f.push([m.Id,m.Tz].concat(["start","end","alarm"].map(function(n){return new Date(m[n])}),c.map(function(n){return m[n]}),[m.Comment.notags,m.Comment.tags.map(function(n){return"#"+n.value+(1==n.count?"":"_"+n.count+"x")}).join(" "),m.Framerate,m.Snore,
m.Noise,m.Cycles,m.DeepSleep,m.LenAdjust,m.Geo],m.times.map(function(n){return n.actigraphy}),m.events.map(function(n){return n.label+"-"+n.timestamp+(n.hasOwnProperty("value")?"-"+n.value:"")})).map(function(n){return Y(n)}));m.times.some(function(n){return n.noise})&&f.push([].concat(Array(13).fill(""),m.times.map(function(n){return n.noise})).map(function(n){return Y(n)}))});e.cells=f;h&&a.sheets.push(e);e=a.get_sheet("Alarms",["Alarm"],[""]);h=e[0];e=e[1];var d=e.cells;d.splice(1);this.alarms.forEach(function(m){return d.push([Y(JSON.stringify(m))])});
h&&a.sheets.push(e);e=a.get_sheet("Preferences",["Preferences"],[""]);h=e[0];e=e[1];var p=e.cells;p.splice(1);p.push([Y(JSON.stringify(this.prefs))]);h&&a.sheets.push(e);return a.serialise();default:return O.prototype.to_async.call(this,a)}};Ta.prototype.merge=function(a){a=a.to(this.file_format());this.records=this.records.concat(za(this.records,a.records,["Id"]));return this};Ta.prototype.file_format=function(){return"SleepAsAndroid"};
Ta.prototype.format_info=function(){return{name:"SleepAsAndroid",title:"Sleep as Android",url:"/src/SleepAsAndroid",statuses:["asleep"],extension:".zip",logo:"https://docs.sleep.urbandroid.org/assets/images/logo.png",timezone:"tzdata"}};R(Ta);function Ua(a,b){b&&(this.g=b);this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"sid",regexp:/^[1-9][0-9]*$/,type:"number"},{member:"start",type:"time"},{member:"stop",type:"time"},{member:"rating",regexp:/^[0-5]$/,type:"number"}]}]);wa(this,a)||(this.records=a.to("Standard").records.filter(function(c){return"asleep"==c.status}).map(function(c,k){return{start:c.start,stop:c.end,sid:k+1,rating:0}}))}L(Ua,O);
Ua.prototype.to=function(a){switch(a){case "output":return Q(this,{file_format:function(){return"string"},contents:"sid,start,stop,rating\n"+this.records.map(function(b){return[b.sid,b.start,b.stop,b.rating].join()+"\n"}).join("")});case "Standard":return new Z({records:this.records.map(function(b){return{status:"asleep",start:b.start,end:b.stop}})},this.g);default:return O.prototype.to.call(this,a)}};
Ua.prototype.merge=function(a){a=a.to(this.file_format());this.records=this.records.concat(za(this.records,a.records,["start","stop"]));this.records.forEach(function(b,c){return b.sid=c+1});return this};Ua.prototype.file_format=function(){return"PleesTracker"};
Ua.prototype.format_info=function(){return{name:"PleesTracker",title:"Plees Tracker",url:"/src/PleesTracker",statuses:["asleep"],extension:".csv",logo:"https://raw.githubusercontent.com/vmiklos/plees-tracker/master/app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png",timezone:"UTC"}};R(Ua);function Va(a,b){b&&(this.g=b);b=[];this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"start",type:"time"},{member:"end",type:"time"},{member:"forced awakening",type:"boolean"},{member:"delayed retirement",type:"boolean"}]}]);switch(a.file_format()){case "array":a=a.contents;if(a.byteLength%12)return U();for(var c=new Float32Array(a),k=new Uint8Array(a),h=1,e=0;e<a.byteLength/12;++e){var f=c[3*e],d=c[3*e+1],p=!k[12*e+8],m=!k[12*e+9];if(f<h||d<=f)return U();h=d;b.push({start:6E4*
Math.round(15776640+1440*f),end:6E4*Math.round(15776640+1440*d),"forced awakening":p,"delayed retirement":m})}break;default:if(wa(this,a))return;b=a.to("Standard").records.filter(function(n){return"asleep"==n.status}).map(function(n){return{start:n.start,end:n.end,"forced awakening":(n.tags||[]).some(function(q){return-1!=q.search(/forced awakening/i)}),"delayed retirement":(n.tags||[]).some(function(q){return-1!=q.search(/delayed retirement/i)})}})}this.records=b}L(Va,O);
Va.prototype.to=function(a){switch(a){case "output":var b=new Float32Array(3*this.records.length),c=new Uint8Array(b.buffer);this.records.forEach(function(k,h){b[3*h]=(k.start-9465984E5)/864E5;b[3*h+1]=(k.end-9465984E5)/864E5;c[12*h+8]=k["forced awakening"]?0:255;c[12*h+9]=k["delayed retirement"]?0:255});return Q(this,{file_format:function(){return"array"},contents:b.buffer});case "Standard":return new Z({records:this.records.map(function(k){return{status:"asleep",start:k.start,end:k.end,tags:[].concat(k["forced awakening"]?
["forced awakening"]:[],k["delayed retirement"]?["delayed retirement"]:[])}})},this.g);default:return O.prototype.to.call(this,a)}};Va.prototype.merge=function(a){a=a.to(this.file_format());var b=1;this.records=this.records.concat(a.records).sort(function(c,k){return c.start-k.start}).filter(function(c){if(c.start<b||c.start>=c.end)return!1;b=c.end;return!0});return this};Va.prototype.file_format=function(){return"SleepChart1"};
Va.prototype.format_info=function(){return{name:"SleepChart1",title:"SleepChart 1.0",url:"/src/SleepChart1",statuses:["asleep"],extension:".tim",logo:"https://www.supermemo.com/assets/images/frontpage2/intro/icon4.svg",timezone:"no"}};R(Va);function Wa(a,b){b&&(this.g=b);this.spreadsheet=new X(this,[{sheet:"Activities",member:"activities",cells:[{member:"ActivityStart",type:"time"},{member:"ActivityEnd",type:"time"}]},{sheet:"Settings",member:"settings",cells:[{member:"Setting",type:"text"},{member:"Value",type:"number"}]}]);wa(this,a)?Xa(this,[]):(this.records=a.to("Standard").records.filter(function(c){return"awake"==c.status||"asleep"==c.status}).map(function(c){return{status:c.status,start:c.start,end:c.end}}),this.activities=this.records.map(function(c){return{ActivityStart:c.start,
ActivityEnd:c.end}}),this.settings=[{Setting:"maximum_day_length_ms",Value:6E4}])}L(Wa,O);
function Xa(a,b){var c=a.records=[],k=[{}],h=1152E5,e=NaN,f=NaN,d=1;a.settings.forEach(function(r){"maximum_day_length_ms"==r.Setting&&(h=r.Value)});a.activities.concat(b).sort(function(r,x){return r.ActivityStart-x.ActivityStart}).forEach(function(r){f>=r.ActivityStart-6E4?k[k.length-1].ActivityEnd=r.ActivityEnd:k.push({ActivityStart:r.ActivityStart,ActivityEnd:f=r.ActivityEnd})});for(a.activities=k.slice(1);d<k.length;){a=k[d];b=a.ActivityStart;for(var p=a.ActivityEnd,m=0,n=++d;n<k.length;){var q=
k[n],l=q.ActivityStart-a.ActivityEnd;m<l&&(m=l,p=a.ActivityEnd,d=n);if(q.ActivityEnd-b>h)break;a=q;++n}36E5<p-b&&(b-e<h&&c.push({start:f+1,end:b-1,status:"asleep"}),c.push({start:b,end:n==k.length?k[n-1].ActivityEnd:p,status:"awake"}),e=b,f=p);if(n==k.length)break}}
Wa.prototype.to=function(a){switch(a){case "output":return Q(this,{file_format:function(){return"string"},contents:Oa(this.spreadsheet)});case "Standard":return new Z({records:this.records},this.g);default:return O.prototype.to.call(this,a)}};Wa.prototype.merge=function(a){a=a.to(this.file_format());Xa(this,a.activities);return this};Wa.prototype.file_format=function(){return"ActivityLog"};
Wa.prototype.format_info=function(){return{name:"ActivityLog",title:"Activity Log",url:"/src/ActivityLog",statuses:["awake","asleep"],extension:".csv",timezone:"UTC"}};R(Wa);function Ya(a,b){function c(h){return"N/A"==h?null:parseInt(h.replace(/,/g,""),10)}b&&(this.g=b);var k=[];this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"Start Time",type:"time"},{member:"End Time",type:"time"},{member:"Minutes Asleep",type:"number"},{member:"Minutes Awake",type:"number"},{member:"Number of Awakenings",type:"number",optional:!0},{member:"Time in Bed",type:"number",optional:!0},{member:"Minutes REM Sleep",type:"number",optional:!0},{member:"Minutes Light Sleep",
type:"number",optional:!0},{member:"Minutes Deep Sleep",type:"number",optional:!0},{members:[],"export":function(){return!0},"import":function(h){h.end=h["End Time"];h.start=h["Start Time"];return!0}}]}]);b=RegExp('^Sleep\nStart Time,End Time,Minutes Asleep,Minutes Awake,Number of Awakenings,Time in Bed,Minutes REM Sleep,Minutes Light Sleep,Minutes Deep Sleep\n(?:"(([0-9][0-9]*)-([0-9][0-9]*)-([0-9][0-9]*) ([0-9][0-9]*):([0-9][0-9]*) *([AP])M)","(([0-9][0-9]*)-([0-9][0-9]*)-([0-9][0-9]*) ([0-9][0-9]*):([0-9][0-9]*) *([AP])M)","([0-9][0-9,]*)","([0-9][0-9,]*)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)"\n)*\n$',
"i");switch(a.file_format()){case "string":a=a.contents;if(b.test(a))a.replace(RegExp('"(([0-9][0-9]*)-([0-9][0-9]*)-([0-9][0-9]*) ([0-9][0-9]*):([0-9][0-9]*) *([AP])M)","(([0-9][0-9]*)-([0-9][0-9]*)-([0-9][0-9]*) ([0-9][0-9]*):([0-9][0-9]*) *([AP])M)","([0-9][0-9,]*)","([0-9][0-9,]*)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)","([0-9][0-9,]*|N/A)"\n',"gi"),function(h,e,f,d,p,m,n,q,l,r,x,G,C,K,T,S,F,E,I,N,v,z){h=T.toUpperCase();r=parseInt(r,10);x=parseInt(x,
10);G=parseInt(G,10);C=parseInt(C,10);12==C?"A"==h&&(C=0):"P"==h&&(C+=12);K=parseInt(K,10);K=31<G?(new Date(G,x-1,r,C,K)).getTime():(new Date(r,x-1,G,C,K)).getTime();S={"End Time":K,"Minutes Asleep":parseInt(S.replace(/,/g,""),10),"Minutes Awake":parseInt(F.replace(/,/g,""),10),"Number of Awakenings":c(E),"Time in Bed":c(I),"Minutes REM Sleep":c(N),"Minutes Light Sleep":c(v),"Minutes Deep Sleep":c(z),end:K};S["Start Time"]=S.start=K-6E4*(S["Minutes Asleep"]+S["Minutes Awake"]);k.push(S)}),this.records=
k;else return U();break;default:wa(this,a)?this.records.forEach(function(h){return["Number of Awakenings","Time in Bed","Minutes REM Sleep","Minutes Light Sleep","Minutes Deep Sleep"].forEach(function(e){return Object.prototype.hasOwnProperty.call(h,e)||(h[e]=null)})}):this.records=a.to("Standard").records.filter(function(h){return"asleep"==h.status}).map(function(h){return{start:h.start,end:h.end,"Start Time":h.start,"End Time":h.end,"Minutes Asleep":Math.round((h.end-h.start)/6E4),"Minutes Awake":0,
"Number of Awakenings":null,"Time in Bed":null,"Minutes REM Sleep":null,"Minutes Light Sleep":null,"Minutes Deep Sleep":null}})}}L(Ya,O);
Ya.prototype.to=function(a){switch(a){case "output":return Q(this,{file_format:function(){return"string"},contents:["Sleep","Start Time,End Time,Minutes Asleep,Minutes Awake,Number of Awakenings,Time in Bed,Minutes REM Sleep,Minutes Light Sleep,Minutes Deep Sleep"].concat(this.records.map(function(b){return["Start Time","End Time"].map(function(c){c=new Date(b[c]);var k=c.getHours();return'"'+c.getFullYear()+"-"+V(c.getMonth()+1)+"-"+V(c.getDate())+" "+(k%12||12)+":"+V(c.getMinutes())+(12<=k?"PM":
"AM")+'"'}).concat("Minutes Asleep;Minutes Awake;Number of Awakenings;Time in Bed;Minutes REM Sleep;Minutes Light Sleep;Minutes Deep Sleep".split(";").map(function(c){return null===b[c]?'"N/A"':'"'+b[c].toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+'"'})).join(",")}),"\n").join("\n")});case "Standard":return new Z({records:this.records.map(function(b){return{status:"asleep",start:b.start,end:b.end,duration:b.end-b.start}})},this.g);default:return O.prototype.to.call(this,a)}};
Ya.prototype.merge=function(a){a=a.to(this.file_format());this.records=this.records.concat(za(this.records,a.records,["start","end"])).sort(function(b,c){return c.start-b.start});return this};Ya.prototype.file_format=function(){return"Fitbit"};Ya.prototype.format_info=function(){return{name:"Fitbit",title:"fitbit",url:"/src/Fitbit",statuses:["asleep"],extension:".csv",logo:"https://community.fitbit.com/html/assets/fitbit_logo_1200.png",timezone:"tzdata"}};R(Ya);function Za(a,b){function c(n){return{type:"text",member:"status",regexp:new RegExp(f.map(function(q){return"("+q[1]+")"}).join("|"),"i"),"export":function(q,l,r){return l[r]=Y(q[n])},"import":function(q,l,r){return f.some(function(x){return-1!=l[r].value.toString().search(new RegExp(x[1],"i"))&&(q[n]=x[0])})}}}function k(n){return{"export":function(q,l,r){q[n].forEach(function(x){return l[r++]=Y(x)});return!0},"import":function(q,l,r){for(q=q[n]=d.map(function(){return(l[r++]||{}).value});q.length&&
!q[q.length-1];)q.pop();return!0}}}b&&(this.g=b);var h=[],e={},f=Da();b={members:[],"export":function(){return!0},"import":function(n){return n.status="asleep"}};var d=[];if("url"==a.file_format()&&"SpreadsheetTable"==a.contents.file_format)e=a.contents.contents.member_map,Object.keys(e).forEach(function(n){var q=e[n];switch(n){case "start":case "end":h[q[1]]={member:q[0],type:"time",optional:!0};break;case "status":h[q[1]]=Object.assign({members:[q[0]]},c(q[0]));break;case "comments":d=q[2];1==d.length?
h[q[1]]={member:q[0],type:"text"}:h.push(Object.assign({members:d},k(q[0])));break;default:return U()}}),e.status||h.push(b);else if("Standard"==a.file_format())e={start:["start",0],end:["end",1],status:["status",2],comments:["comments",3]},h=[{member:"start",type:"time",optional:!0},{member:"end",type:"time",optional:!0},c("status"),{members:["comments"],"export":function(n,q,l){return q[l]=Y((n.comments||[]).join("; "))},"import":function(n,q,l){q[l].value&&(n.comments=q[l].value.split(/ *; */));
return!0}}];else if(a.sheets&&a.sheets[0]&&a.sheets[0].cells[0]){if(a.sheets[0].cells[0].map(function(n,q){return[n,q]}).filter(function(n){var q=n[0].value;"string"!=typeof q&&(q="");if(![["end",/w.ke|stop|end/i],["start",/sleep|start|begin/i]].some(function(l){if(-1==q.search(l[1]))return!1;e.hasOwnProperty(l[0])||(e[l[0]]=[q,n[1]],h[n[1]]={member:q,type:"time",optional:!0});return!0}))if(-1!=q.search(/event|activity|stat(e|us)/i))e.hasOwnProperty("status")||(e.status=[q,n[1]],h[n[1]]=Object.assign({members:[q]},
c(q)));else{if(q&&-1==q.search(/comment|note/i))return!0;d.push(n)}return!1}).filter(function(n){var q=n[0].value;if(e.hasOwnProperty("start"))if(e.hasOwnProperty("end"))if(/date|time/i.test(q))h[n[1]]={member:q,optional:!0,da:!0};else return!0;else e.end=[q,n[1]],h[n[1]]={member:q,type:"time",optional:!0};else e.start=[q,n[1]],h[n[1]]={member:q,type:"time",optional:!0};return!1}).length||!e.hasOwnProperty("start")||!e.hasOwnProperty("end"))return U();for(var p=0;p!=h.length;++p)if(!h[p])return U();
if(d.length)if(e.comments=[d[0][0].value,d[0][1],d.map(function(n){return n[0].value})],1==d.length)h[d[0][1]]={member:d[0][0].value,type:"text"};else{if(d[0][1]!=h.length)return U();for(p=1;p<d.length;++p)if(d[p][1]!=d[p-1][1]+1)return U();h.push(Object.assign({members:d.map(function(n){return n[0].value})},k(d[0][0].value)))}e.hasOwnProperty("status")||h.push(b)}else return U();this.member_map=e;this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:h}],!0);if(!wa(this,a)){var m=this.member_map;
a=a.to("Standard").records;m.hasOwnProperty("status")||(a=a.filter(function(n){return"asleep"==n.status}));m.hasOwnProperty("comments")&&(a=a.map(function(n){n.comments&&(n=Object.assign({},n),n.comments=n.comments.map(function(q){return"string"==typeof q?q:q.text}),1==d.length&&(n.comments=n.comments[0]));return n}));this.records=a.map(function(n){var q={};Object.keys(m).forEach(function(l){return q[m[l][0]]=n[l]});return q})}}L(Za,O);
Za.prototype.to=function(a){switch(a){case "output":var b=[],c=[];Object.values(this.member_map).forEach(function(h){c[h[1]]=h[0];h[2]?b=b.concat(h[2]):b[h[1]]=h[0]});return Q(this,{file_format:function(){return"string"},contents:b.filter(function(h){return void 0!==h}).join()+"\n"+this.records.map(function(h){var e=[];c.forEach(function(f){f=h[f];Array.isArray(f)?e=e.concat(f.map(Ma)):e.push(Ma(f))});return e.join()+"\n"}).join("")});case "Standard":var k=this.member_map;return new Z({records:this.records.map(function(h){return{status:h[(k.status||
["status"])[0]],start:h[(k.start||["start"])[0]],end:h[(k.end||["end"])[0]],comments:h[(k.comments||["comments"])[0]]||[]}})},this.g);default:return O.prototype.to.call(this,a)}};
Za.prototype.merge=function(a){function b(h){return["status","start","end"].map(function(e){return h[(c[e]||[e])[0]]}).join()}a=a.to("Standard");var c=this.member_map,k={};this.records.forEach(function(h){return k[b(h)]=1});this.records=this.records.concat(a.records.map(function(h){var e={};Object.keys(c).forEach(function(f){h.hasOwnProperty(f)&&(e[c[f][0]]=h[f])});return e}).filter(function(h){return!k.hasOwnProperty(b(h))}));return this};Za.prototype.file_format=function(){return"SpreadsheetTable"};
Za.prototype.format_info=function(){return{name:"SpreadsheetTable",title:"Spreadsheet Table",url:"/src/SpreadsheetTable",extension:".xlsx",icon:"mdi-file-excel",timezone:"no"}};R(Za);function $a(a,b){b&&(this.g=b);var c=Da(),k={};this.spreadsheet=new X(this,[{sheet:"Records",member:"records",cells:[{member:"start",type:"time"},{member:"end",type:"time"},{member:"status",type:"text"},{members:["comments"],"export":function(v,z,B){return z[B]=Y(v.comments.join("; "))},"import":function(v,z,B){return v.comments=z[B].value.split(/\s*;\s*/)}}]}]);if(a.sheets&&a.sheets[0]&&a.sheets[0].cells){var h=a.sheets[0].cells,e=0,f=0,d=h[0].map(function(v){return Ka(v,a.spreadsheet)});b=h.map(function(v){return Ka(v[0],
a.spreadsheet)});var p=Infinity,m=0,n=Infinity,q=0;h.forEach(function(v,z){return v.forEach(function(B,u){B.style&&(p=Math.min(p,u),m=Math.max(m,u),n=Math.min(n,z),q=Math.max(q,z))})});var l=[d,b].map(function(v){for(var z="number"!=typeof v[0]||isNaN(v[0])?[[1]]:[[0,v[0]]],B=1;B<v.length;++B)432E5<=v[B-1]&&432E5>v[B]&&(v[B]+=432E5),"number"!=typeof v[B]||isNaN(v[B])?z.push([B+1]):z[z.length-1].push(v[B]);v=z.sort(function(g,t){return t.length-g.length})[0];z=v.slice(1);var u;if(4<z.length)z.some(function(g){return 0>
g||864E5<=g})?u=1:23<z.length&&(u=2);else{var D=(new Date).getTime();z.length&&z.every(function(g){return 864E5<=g&&g<=D})&&(u=1)}return{lines:1,start:v[0],j:z,type:u}});switch(l[0].type){case 0:l[1].type&&(e=l[1]);break;case 1:switch(l[1].type){case 2:e=l[1];case 0:f=l[0];break;default:l[0].j.length>l[1].j.length?f=l[0]:e=l[1]}break;case 2:switch(l[1].type){case 1:e=l[1];case 0:f=l[0];break;default:l[0].j.length%24<l[1].j.length%24?f=l[0]:e=l[1]}}if(!f)if((l=e?1:0)?1==e.type:24<=d.length){var r=
[];d=d.length-l;d-=d%24;for(var x=0;x!=d;++x)r.push(864E5*x/d);f={lines:0,start:l,j:r,type:2}}else{r=[];d=(new Date).getTime();d-=d%864E5;for(x=Math.max(l+1,p);x<=m;++x)r.push(d-864E5*(m-x));f={lines:0,start:l,j:r,type:2}}if(!e)if(l=f.lines,1==f.type){r=[];b=b.length-l;b-=b%24;for(d=0;d!=b;++d)r.push(864E5*d/b);e={lines:0,start:l,j:r,type:2}}else{b=[];r=(new Date).getTime();r-=r%864E5;for(d=l=Math.max(l,n);d<=q;++d)b.push(r-864E5*(q-d));e={lines:0,start:l,j:b,type:2}}if(!f.j.length||!e.j.length)return U();
var G=[];e.j.forEach(function(v,z){var B=h[e.start+z];f.j.forEach(function(u,D){D=B[f.start+D]||{style:""};G.push({start:v+u,style:D.style||"",comments:D.value?[D.value]:[]})})});if(!G.length)return U();G=G.sort(function(v,z){return v.start-z.start});var C=[{style:NaN}];G.forEach(function(v){v.style==C[C.length-1].style?C[C.length-1].comments=C[C.length-1].comments.concat(v.comments):(C[C.length-1].end=v.start-1,C.push(v))});C.shift();var K={};C.forEach(function(v){var z=K[v.style]=K[v.style]||{u:[],
duration:0};z.u.push(v);v.end&&v.start&&(z.duration+=v.end-v.start)});var T=[],S=[];h.forEach(function(v,z){v.forEach(function(B,u){if(z<e.start-f.lines||z>=e.start+e.j.length||u<f.start-e.lines||u>=f.start+f.j.length)B.value&&S.push([z,u,B.value]),B.style&&T.push([z,u,B.style])})});var F=[];T.forEach(function(v){return F=F.concat(S.map(function(z){return[Math.abs(z[0]-v[0])+Math.abs(z[1]-v[1]),v[2],z[2]]}))});var E={};c.forEach(function(v){return E[v[0]]=new RegExp(v[1],"i")});var I={};F.sort(function(v,
z){return v[0]-z[0]}).forEach(function(v){if(K[v[1]]&&!I[v[2]]){I[v[2]]=1;var z=Object.keys(E).find(function(B){return-1!=v[2].search(E[B])});z?delete E[z]:z=v[2];k[z]=v[1];K[v[1]].u.forEach(function(B){delete B.style;B.status=z});delete K[v[1]]}});var N=0;Object.values(K).sort(function(v,z){return z.duration-v.duration}).forEach(function(v){var z=c.find(function(B){return E[B[0]]});z?(z=z[0],delete E[z]):z="Unknown status #"+ ++N;v.u.forEach(function(B){k[z]=B.style;B.status=z;delete B.style})})}else{if(wa(this,
a))return;C=a.to("Standard").records.map(function(v){var z={comments:[]};["start","end","status","comments"].forEach(function(B){return v.hasOwnProperty(B)&&(z[B]=v[B])});k[v.status]=c.find(function(B){return B[0]==v.status})[2];return z})}this.records=C;this.status_map=k}L($a,O);
$a.prototype.to=function(a){switch(a){case "output":throw Error("Please use to_async() to generate output for SpreadsheetGraph");case "Standard":return new Z({records:this.records},this.g);default:return O.prototype.to.call(this,a)}};
$a.prototype.to_async=function(a){var b=this;switch(a){case "output":var c=this.records,k=this.status_map,h=[60,30,15,5].map(function(l){return 6E4*l}).find(function(l){return!c.filter(function(r){return r.start%l}).length})||3E5,e=Infinity,f=0;c.forEach(function(l){e=Math.min(e,l.start);f=Math.max(f,l.end||l.start+1)});Infinity==e&&(e=f);e-=e%864E5;f-=f%864E5;var d=[[Y()]];a=["YYYY-MM-DD"];for(var p=[11],m=[{font:{size:10}}],n=0;864E5!=n;n+=h)d[0].push(Y(n/864E5,"#FFEEEEEE,#FFEEEEEE")),a.push("H:MM"),
p.push(5),m.push({font:{size:10}});for(n=e;n<=f;n+=864E5)d.push([Y(new Date(n),"#FFEEEEEE,#FFEEEEEE")]);c.forEach(function(l){var r=l.start,x=l.end||r+1,G=k[l.status];l=(l.comments||[]).slice(0);for(var C=Math.ceil(l.length/Math.max((x-r)/h)),K=r;K<Math.max(x,r+1);K+=h){var T=K%864E5;d[(K-T-e)/864E5+1][Math.floor(T/h)+1]=Y(l.splice(0,C).join("; "),G)}});var q={};c.forEach(function(l){var r=l.status;k[r]&&((q[r]=q[r]||[0,k[r],r])[0]+=l.end-l.start)});Object.values(q).sort(function(l,r){return r[0]-
l[0]}).forEach(function(l,r){r=d[r+1]=d[r+1]||[];r[d[0].length+2]=Y(void 0,l[1]);r[d[0].length+3]=Y(l[2])});this.spreadsheet.sheets[0]={name:"Sleep Graph",number_formats:a,cells:d,widths:p,styles:m,options:{properties:{defaultRowHeight:12.5},pageSetup:{paperSize:9,orientation:"landscape"}}};return this.spreadsheet.serialise().then(function(l){return Q(b,{file_format:function(){return"array"},contents:l})});default:return O.prototype.to_async.call(this,a)}};
$a.prototype.merge=function(a){function b(e){return["status","start","end"].map(function(f){return e[f]}).join()}a=a.to(this.file_format());var c={};this.records.forEach(function(e){return c[b(e)]=1});this.records=this.records.concat(a.records.filter(function(e){return!c.hasOwnProperty(b(e))}));var k=a.status_map,h=this.status_map;Object.keys(k).forEach(function(e){h.hasOwnProperty(e)||(h[e]=k[e])});return this};$a.prototype.file_format=function(){return"SpreadsheetGraph"};
$a.prototype.format_info=function(){return{name:"SpreadsheetGraph",title:"Spreadsheet Graph",url:"/src/SpreadsheetGraph",extension:".xlsx",icon:"mdi-file-excel-outline",timezone:"no"}};R($a);}).call(this);
//# sourceMappingURL=sleepdiary-core.min.js.map
